const firebaseConfig={apiKey:"AIzaSyAlrmioVjkpD9tVgq3ZQZTJyPn4TkfMkFk",authDomain:"peluqueria-completa.firebaseapp.com",projectId:"peluqueria-completa",storageBucket:"peluqueria-completa.firebasestorage.app",messagingSenderId:"48556844588",appId:"1:48556844588:web:7ff13754150b12b69d9389",measurementId:"G-Z5GX6CDV9R"};window.brevoConfig={senderEmail:"no-reply@gestionturno.com",senderName:"DemoPro Gesti√≥nTurno",adminEmail:"agustinmatiasf@gmail.com"},window.appConfig={version:"2.0",environment:"production",features:{multiSpecialist:!0,categories:!0,realTimeValidation:!0}},firebase.apps.length||firebase.initializeApp(firebaseConfig),window.firebaseAuth=firebase.auth(),window.db=firebase.firestore(),window.handleFirebaseError=e=>{console.error("Firebase Error:",e);return{"permission-denied":"No tienes permisos para esta acci√≥n",unavailable:"Error de conexi√≥n. Intenta nuevamente","not-found":"Recurso no encontrado"}[e.code]||e.message},window.googleProvider=new firebase.auth.GoogleAuthProvider,window.googleProvider.addScope("profile"),window.googleProvider.addScope("email"),(()=>{if(!firebase.apps.length)throw new Error("Firebase no est√° inicializado");const{db:e}=window;window.firestoreDB={async obtenerConfiguracion(){const o=await e.collection("config").doc("horarios").get();if(!o.exists)throw new Error("No se encontr√≥ configuraci√≥n");const a=o.data();"string"==typeof a.horarioApertura&&(a.horarioApertura=a.horarioApertura.replace(/"/g,"")),"string"==typeof a.horarioCierre&&(a.horarioCierre=a.horarioCierre.replace(/"/g,""));if(a.diasLaborales=(e=>{if(!e)return[1,2,3,4,5,6];if(Array.isArray(e)&&e.every(e=>"number"==typeof e))return e;if(Array.isArray(e)&&1===e.length&&"string"==typeof e[0])try{const o=e[0].trim();return o.startsWith("[")&&o.endsWith("]")?JSON.parse(o).map(Number):o.split(",").map(Number).filter(e=>!isNaN(e))}catch(e){return console.error("Error parseando diasLaborales:",e),[1,2,3,4,5,6]}if("string"==typeof e){if(e.startsWith("[")&&e.endsWith("]"))try{return JSON.parse(e).map(Number)}catch(e){console.error("Error parseando diasLaborales JSON:",e)}return e.split(",").map(Number).filter(e=>!isNaN(e))}return[1,2,3,4,5]})(a.diasLaborales),"string"==typeof a.diasNoLaborables)try{a.diasNoLaborables=JSON.parse(a.diasNoLaborables)}catch(e){a.diasNoLaborables=a.diasNoLaborables.replace(/[\[\]\s]/g,"").split(",").filter(Boolean)}return a},async obtenerConfigGeneral(){const o=await e.collection("config").doc("general").get();return o.exists?o.data():{}},obtenerCategorias:async()=>(await e.collection("categorias").orderBy("orden").get()).docs.map(e=>({id:e.id,...e.data()})),obtenerServiciosPorCategoria:async o=>(await e.collection("servicios").where("categoriaId","==",o).where("activo","==",!0).orderBy("orden").get()).docs.map(e=>({id:e.id,...e.data()})),obtenerEspecialistas:async()=>(await e.collection("especialistas").where("activo","==",!0).orderBy("orden").get()).docs.map(e=>({id:e.id,...e.data()})),obtenerServicios:async()=>(await e.collection("servicios").where("activo","==",!0).orderBy("orden").get()).docs.map(e=>({id:e.id,...e.data()})),obtenerEspecialistasPorCategoria:async o=>(await e.collection("especialistas").where("categoriasId","array-contains",o).where("activo","==",!0).orderBy("orden").get()).docs.map(e=>({id:e.id,...e.data(),categorias:e.data().categoriasId})),async obtenerEspecialistasPorServicio(o){const a=await e.collection("servicios").doc(o).get();if(!a.exists)return[];const r=a.data();return await this.obtenerEspecialistasPorCategoria(r.categoriaId)},async obtenerTurnosPorEspecialistaYFecha(o,a){try{return(await e.collection("turnos").where("especialistaIds","array-contains",o).where("fecha","==",a).get()).docs.map(e=>{const o=e.data();return{id:e.id,...o,slotsPorEspecialista:o.slotsPorEspecialista||{}}})}catch(e){return console.error("Error obteniendo turnos por especialista y fecha:",e),[]}},async obtenerTurnosPorEspecialistasYFecha(e,o){const a=e.map(e=>this.obtenerTurnosPorEspecialistaYFecha(e,o));return(await Promise.all(a)).flat()},async verificarDisponibilidadParaEspecialistas(o,a,r){try{return(await e.collection("turnos").where("fecha","==",o).where("horarioInicio","==",a).where("especialistaId","in",r).limit(1).get()).empty}catch(e){return console.error("Error verificando disponibilidad:",e),!1}},obtenerTurnosPorFecha:async o=>(await e.collection("turnos").where("fecha","==",o).get()).docs.map(e=>({id:e.id,...e.data()})),async generarHorariosDisponiblesEspecialista(o,a,r=0){try{const[t,n,i]=await Promise.all([this.obtenerConfiguracion(),e.collection("especialistas").doc(o).get(),this.obtenerTurnosPorEspecialistaYFecha(o,a)]);if(!n.exists)throw new Error("Especialista no encontrado");const s=n.data();if(!s)throw new Error("Especialista no encontrado");const c=["domingo","lunes","martes","miercoles","jueves","viernes","sabado"][new Date(a).getDay()],l=s.horarioLaboral?.[c],d=l?.activo?l.inicio:t.horarioApertura,u=l?.activo?l.fin:t.horarioCierre,p=this._calcularSlotsOcupados(i,o);return this._generarHorarios({...t,horarioApertura:d,horarioCierre:u},p,a,r)}catch(e){return console.error("Error en generarHorariosDisponiblesEspecialista:",e),[]}},_generarHorarios(e,o,a,r=0){const t=e.horarioApertura,n=e.horarioCierre,i=parseInt(t.replace(".",":").split(":")[0]),s=parseInt(t.replace(".",":").split(":")[1]||0),c=parseInt(n.replace(".",":").split(":")[0]),l=parseInt(n.replace(".",":").split(":")[1]||0);let d=30;if(e.duracionTurno&&!isNaN(parseInt(e.duracionTurno))?d=parseInt(e.duracionTurno):e.duracionTurnoBase&&!isNaN(parseInt(e.duracionTurnoBase))&&(d=parseInt(e.duracionTurnoBase)),isNaN(i))throw new Error("Horario apertura inv√°lido");if(isNaN(s)&&(s=0),isNaN(c))throw new Error("Horario cierre inv√°lido");isNaN(l)&&(l=0),isNaN(d)&&(console.warn("Duraci√≥n turno inv√°lida, usando valor por defecto de 30 minutos"),d=30);const u=[];let p=i,m=s;const g=60*c+l;for(;;){const e=`${p.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`,a=60*p+m,t=a+r,n=t<=g;if(a>=g)break;let i=!0;for(let e=a;e<t;e+=30){const a=e%60,r=`${Math.floor(e/60).toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`;if(o.includes(r)){i=!1;break}}const s=!i;if(u.push({hora:e,disponible:!s&&n}),m+=d,m>=60&&(p+=Math.floor(m/60),m%=60),p>c||p===c&&m>l)break}if(0===u.length)throw console.error("No se generaron horarios con la configuraci√≥n:",e),new Error("No se pudieron generar horarios");return u},_generarHorariosBasicos(e,o,a){const r=e.horarioApertura,t=e.horarioCierre,n=parseInt(r.replace(".",":").split(":")[0]),i=parseInt(r.replace(".",":").split(":")[1]||0),s=parseInt(t.replace(".",":").split(":")[0]),c=parseInt(t.replace(".",":").split(":")[1]||0);let l=30;e.duracionTurno&&!isNaN(parseInt(e.duracionTurno))?l=parseInt(e.duracionTurno):e.duracionTurnoBase&&!isNaN(parseInt(e.duracionTurnoBase))&&(l=parseInt(e.duracionTurnoBase));const d=[];let u=n,p=i;const m=60*s+c;for(;u<s||u===s&&p<=c;){const e=`${u.toString().padStart(2,"0")}:${p.toString().padStart(2,"0")}`,a=o.includes(e),r=60*u+p<m;d.push({hora:e,disponible:!a&&r}),p+=l,p>=60&&(u+=Math.floor(p/60),p%=60)}return d},async obtenerHorariosComunesDisponibles(e,o,a){try{const r={};for(const t of o){const o=(await this.generarHorariosDisponiblesEspecialista(t,e,a)).filter(e=>e.disponible).map(e=>e.hora);r[t]=o}return this._encontrarHorariosComunes(r)}catch(e){return console.error("Error obteniendo horarios comunes:",e),[]}},async _puedeAcomodarDuracion(o,a,r,t){try{const n=await e.collection("especialistas").doc(r).get();if(!n.exists)return!1;const i=n.data(),s=new Date(t).getDay(),c=["domingo","lunes","martes","miercoles","jueves","viernes","sabado"][s],l=i.horarioLaboral?.[c],d=await this.obtenerConfiguracion(),u=l?.activo?l.fin:d.horarioCierre,[p,m]=o.split(":"),g=parseInt(p),h=60*g+parseInt(m),[v,f]=u.split(":"),b=parseInt(v),y=parseInt(f||0);return h+a<=60*b+y}catch(e){return console.error("Error validando duraci√≥n:",e),!1}},_encontrarHorariosComunes(e){const o=Object.keys(e);if(0===o.length)return[];let a=[...e[o[0]]];for(let r=1;r<o.length;r++){const t=e[o[r]];a=a.filter(e=>t.includes(e))}return a},_encontrarHorariosComunesConDuracion(e,o){const a=Object.keys(e);if(0===a.length)return[];const r=e[a[0]],t=[];for(const n of r){if(!n.disponible)continue;let r=!0;const i=n.minutos,s=i+o;for(let o=0;o<a.length;o++){const t=e[a[o]];for(let e=i;e<s;e+=30){const o=e%60,a=`${Math.floor(e/60).toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`;if(!t.find(e=>e.hora===a&&e.disponible)){r=!1;break}}if(!r)break}r&&t.push(n.hora)}return t},_filtrarHorariosPorHoraActual(e,o){const a=new Date,r=60*a.getHours()+a.getMinutes();return e.filter(e=>{const[a,t]=e.split(":");return 60*parseInt(a)+parseInt(t)>=r+30+o})},async verificarDisponibilidad(o,a){try{return(await e.collection("turnos").where("fecha","==",o).where("horarioInicio","==",a).limit(1).get()).empty}catch(e){return console.error("Error verificando disponibilidad:",e),!1}},async verificarDisponibilidadEspecialistas(e){for(const o of datosReserva.especialistas){if(!await verificarDisponibilidadEspecialista(o.id,e))return!1}return!0},async verificarDisponibilidadEspecialista(o,a,r){try{const t=await e.collection("especialistas").doc(o).get();if(!t.exists)return!1;const n=t.data(),i=new Date(a).getDay(),s=["domingo","lunes","martes","miercoles","jueves","viernes","sabado"][i];if(!n.horarioLaboral||!n.horarioLaboral[s]?.activo)return!1;if(await this.verificarBloqueosEspecialista(o,a))return!1;return(await e.collection("turnos").where("especialistaId","==",o).where("fecha","==",a).where("horarioInicio","==",r).limit(1).get()).empty}catch(e){return console.error("Error verificando disponibilidad:",e),!1}},async verificarBloqueosEspecialista(o,a){try{const r=new Date(a).getTime(),t=await e.collection("bloqueos").where("especialistaId","==",o).get();if(t.empty)return!1;for(const e of t.docs){const o=e.data(),a=new Date(o.fechaInicio).getTime(),t=new Date(o.fechaFin).getTime();if(r>=a&&r<=t)return!0}return!1}catch(e){return console.error("Error verificando bloqueos:",e),!1}},async obtenerTurnosSolapados(o,a,r){const[t,n]=a.split(":"),i=parseInt(t),s=parseInt(n)+r,c=s%60,l=`${(i+Math.floor(s/60)).toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}`;return(await e.collection("turnos").where("fecha","==",o).where("horarioInicio",">=",a).where("horarioInicio","<",l).get()).docs.map(e=>e.data())},bloquearTurnoTemporal:async(o,a,r)=>(await e.collection("bloqueos_temporales").add({fecha:o,horario:a,userId:r,timestamp:firebase.firestore.FieldValue.serverTimestamp(),expiresAt:new Date(Date.now()+3e5)})).id,async eliminarBloqueoTemporal(o){await e.collection("bloqueos_temporales").doc(o).delete()},async obtenerTurnosPorUsuario(o){try{const a=new Date;a.setHours(0,0,0,0);const r=a.toISOString().split("T")[0];return(await e.collection("turnos").where("userId","==",o).where("fecha",">=",r).orderBy("fecha").orderBy("horarioInicio").get()).docs.map(e=>({id:e.id,...e.data()}))}catch(e){return console.error("Error obteniendo turnos del usuario:",e),[]}},async guardarTurno(o){try{const a=await e.collection("servicios").where(firebase.firestore.FieldPath.documentId(),"in",o.serviciosIds).get(),r=[];for(const e of o.serviciosIds){const o=a.docs.find(o=>o.id===e);o&&r.push(o)}const{especialistasPorCategoria:t}=o;let n=0;const i={},s={};r.forEach(e=>{const o=e.data();n+=o.duracion||30;const a=t[o.categoriaId];if(!a)throw new Error(`No se encontr√≥ especialista para la categor√≠a ${o.categoriaId}`);i[a]||(i[a]=[],s[a]=[]),i[a].push({id:e.id,nombre:o.nombre,duracion:o.duracion||30,categoriaId:o.categoriaId})});const[c,l]=o.horarioInicio.split(":"),d=parseInt(c),u=60*d+parseInt(l);let p=0;for(const e of r){const o=e.data(),a=t[o.categoriaId],r=u+p,n=r+o.duracion;for(let e=r;e<n;e+=30){const o=Math.floor(e/60),r=e%60,t=`${o.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`;s[a].includes(t)||s[a].push(t)}p+=o.duracion}const m=Object.keys(i);0===Object.keys(i).length&&(console.error("ERROR: serviciosPorEspecialista est√° vac√≠o"),console.log("Datos disponibles:",{serviciosOrdenados:r.length,especialistasPorCategoria:t,serviciosIds:o.serviciosIds})),0===Object.keys(s).length&&console.error("ERROR: slotsPorEspecialista est√° vac√≠o");const g=await e.collection("turnos").add({...o,duracionTotal:n,serviciosPorEspecialista:i,slotsPorEspecialista:s,especialistaIds:m,estado:"pendiente",createdAt:firebase.firestore.FieldValue.serverTimestamp(),actualizadoEl:firebase.firestore.FieldValue.serverTimestamp()});return console.log(`Turno guardado exitosamente. ID: ${g.id}`),{id:g.id,...o}}catch(e){throw console.error("Error guardando turno:",e),e}},async generarHorariosDisponibles(e){return console.warn("DEPRECATED: Usar generarHorariosDisponiblesEspecialista()"),this.generarHorariosDisponiblesEspecialista("especialista_default",e)},_calcularSlotsOcupados(e,o){const a=[];return e.forEach(e=>{if(e.especialistaIds&&e.especialistaIds.includes(o))if(e.slotsPorEspecialista&&e.slotsPorEspecialista[o])a.push(...e.slotsPorEspecialista[o]);else{const[o,r]=e.horarioInicio.split(":").map(Number),t=60*o+r,n=t+(e.duracionTotal||30);for(let e=t;e<n;e+=30){const o=e%60,r=`${Math.floor(e/60).toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`;a.includes(r)||a.push(r)}}}),a}}})();const cacheMonitor={hits:0,misses:0,savings:0,incrementHit:function(){this.hits++,this.logStats()},incrementMiss:function(){this.misses++,this.logStats()},logStats:function(){const e=this.hits+this.misses,o=e>0?Math.round(this.hits/e*100):0;e%10==0&&console.log(`üî• Cache Stats: ${this.hits}h/${this.misses}m (${o}%) | Ahorro: ${this.savings} lecturas`)},addSavings:function(e){this.savings+=e}},cache={config:null,categorias:null,servicios:null,especialistas:{},horarios:{},horarios_multi:{},timestamp:{config:0,categorias:0,servicios:0,especialistas:{},horarios:{},horarios_multi:{}},ttl:3e5,esValido:function(e,o=null){try{const a=o?this.timestamp[e]?.[o]||0:this.timestamp[e]||0;return Date.now()-a<this.ttl}catch(e){return console.warn("Error validando cach√©:",e),!1}},guardar:function(e,o,a=null){try{if(null==o)return void console.warn(`‚ö†Ô∏è Intentando guardar datos inv√°lidos en cach√©: ${e}`,o);a?(this[e]||(this[e]={}),this.timestamp[e]||(this.timestamp[e]={}),this[e][a]=o,this.timestamp[e][a]=Date.now()):(this[e]=o,this.timestamp[e]=Date.now()),console.log(`üíæ Cach√© guardado: ${e}${a?`[${a}]`:""}`)}catch(e){console.error("Error guardando en cach√©:",e)}},obtener:function(e,o=null){try{const a=o?this[e]?.[o]??null:this[e]??null;return null!==a&&this.esValido(e,o)?(cacheMonitor.incrementHit(),cacheMonitor.savings+=this.estimarLecturasAhorradas(e),a):(cacheMonitor.incrementMiss(),null)}catch(e){return console.error("Error obteniendo del cach√©:",e),cacheMonitor.incrementMiss(),null}},estimarLecturasAhorradas:function(e){return{config:1,categorias:10,servicios:50,especialistas:5,horarios:1,horarios_multi:3}[e]||1},limpiarEspecifico:function(e,o=null){try{o?(this[e]&&this[e][o]&&delete this[e][o],this.timestamp[e]&&this.timestamp[e][o]&&delete this.timestamp[e][o],console.log(`üßπ Cach√© limpiado: ${e}[${o}]`)):(this[e]=null,this.timestamp[e]=0,console.log(`üßπ Cach√© limpiado: ${e}`))}catch(e){console.error("Error limpiando cach√© espec√≠fico:",e)}},forzarActualizacionEspecialistas:function(e){this.limpiarEspecifico("especialistas",e),console.log(`üîÑ Cach√© forzado a actualizar para categor√≠a: ${e}`)}};async function precacheDatosEsenciales(){try{console.log("üîÑ Precargando datos esenciales..."),await Promise.allSettled([firestoreSeguro.obtenerConfiguracion(),firestoreSeguro.obtenerCategorias(),firestoreSeguro.obtenerServicios()]),console.log("‚úÖ Precaching completado")}catch(e){console.warn("‚ö†Ô∏è Precaching fall√≥:",e)}}function limpiarCache(e=null){e?(cache[e]=null,cache.timestamp[e]=0,console.log(`üßπ Cach√© de ${e} limpiado`)):(Object.keys(cache).forEach(e=>{"ttl"!==e&&"timestamp"!==e&&(cache[e]="especialistas"===e||"horarios"===e||"horarios_multi"===e?{}:null)}),Object.keys(cache.timestamp).forEach(e=>{cache.timestamp[e]="especialistas"===e||"horarios"===e||"horarios_multi"===e?{}:0}),console.log("üßπ Todo el cach√© limpiado"))}function actualizarCacheEspecialistas(){limpiarCache("especialistas"),console.log("üîÑ Cache de especialistas actualizado forzadamente")}function guardarCacheEnStorage(){try{const e={config:cache.config,categorias:cache.categorias,servicios:cache.servicios,timestamp:cache.timestamp,fechaGuardado:Date.now()};localStorage.setItem("firestoreCache",JSON.stringify(e))}catch(e){console.warn("No se pudo guardar el cach√©:",e)}}function cargarCacheDesdeStorage(){try{const e=localStorage.getItem("firestoreCache");if(e){const o=JSON.parse(e),a=36e5;Date.now()-o.fechaGuardado<a?(cache.config=o.config,cache.categorias=o.categorias,cache.servicios=o.servicios,cache.timestamp=o.timestamp,console.log("‚úÖ Cach√© cargado desde localStorage")):(console.log("üßπ Cach√© expirado, limpiando..."),localStorage.removeItem("firestoreCache"))}}catch(e){console.warn("Error cargando cach√©:",e)}}function limpiarCacheEspecialistasPorCategoria(e){cache.forzarActualizacionEspecialistas(e)}window.addEventListener("beforeunload",guardarCacheEnStorage),document.addEventListener("DOMContentLoaded",cargarCacheDesdeStorage);let usuarioActual=null;const esPaginaAdmin=window.location.pathname.includes("admin.html");function inicializarAuth(){manejarRedirectResult(),firebase.auth().onAuthStateChanged(async e=>{usuarioActual=e,esPaginaAdmin||(await actualizarUIUsuario(e),actualizarBotonAdmin(e),e&&window.cargarDatosUsuario&&await cargarDatosUsuario(e.uid))}),esPaginaAdmin||configurarEventosAuth()}function configurarEventosAuth(){document.removeEventListener("click",manejarClicAuth),document.addEventListener("click",manejarClicAuth)}function manejarClicAuth(e){const o="btn-google"===e.target.id||e.target.closest("#btn-google"),a="btn-google-menu"===e.target.id||e.target.closest("#btn-google-menu");return o||a?(e.preventDefault(),e.stopPropagation(),void iniciarSesionGoogle()):"nav-cerrar-sesion"===e.target.id||e.target.closest("#nav-cerrar-sesion")?(e.preventDefault(),void cerrarSesion()):"nav-perfil"===e.target.id||e.target.closest("#nav-perfil")?(e.preventDefault(),void manejarOpcionProtegida("perfil")):"nav-mis-turnos"===e.target.id||e.target.closest("#nav-mis-turnos")?(e.preventDefault(),void manejarOpcionProtegida("mis-turnos")):e.target.classList.contains(".btn-admin")?(e.preventDefault(),void(usuarioActual&&esUsuarioAdministrador(usuarioActual)?window.location.href="/admin.html":mostrarError("Acceso denegado. Debes ser administrador."))):void 0}async function iniciarSesionGoogle(){deshabilitarBotonesAuth(!0);try{const e=new firebase.auth.GoogleAuthProvider;e.setCustomParameters({prompt:"select_account"}),console.log("Intentando autenticaci√≥n con popup...");const o=await firebase.auth().signInWithPopup(e);console.log("Autenticaci√≥n exitosa:",o.user.email)}catch(e){console.error("Error en autenticaci√≥n:",e),"auth/popup-blocked"===e.code?(console.log("Popup bloqueado, intentando con redirecci√≥n..."),await manejarAutenticacionRedirect()):"auth/popup-closed-by-user"===e.code?(console.log("Usuario cerr√≥ el popup"),mostrarError("Cerraste la ventana de autenticaci√≥n. Intenta nuevamente.")):mostrarErrorAuth(e)}finally{deshabilitarBotonesAuth(!1)}}async function manejarAutenticacionRedirect(){try{const e=new firebase.auth.GoogleAuthProvider;e.setCustomParameters({prompt:"select_account"}),sessionStorage.setItem("preAuthUrl",window.location.href),await firebase.auth().signInWithRedirect(e)}catch(e){console.error("Error en redirecci√≥n:",e),mostrarError("No se pudo iniciar sesi√≥n. Por favor, habilita las ventanas emergentes para este sitio.")}}function manejarRedirectResult(){firebase.auth().getRedirectResult().then(e=>{if(e.user){console.log("Autenticaci√≥n por redirecci√≥n exitosa:",e.user.email);const o=sessionStorage.getItem("preAuthUrl");o&&o!==window.location.href&&(sessionStorage.removeItem("preAuthUrl"),window.location.href=o)}}).catch(e=>{console.error("Error en resultado de redirecci√≥n:",e)})}async function cerrarSesion(){try{await firebase.auth().signOut(),setTimeout(()=>{window.location.reload()},1e3)}catch(e){console.warn("Advertencia inesperada al cerrar sesi√≥n:",e),mostrarMensajeExito("Sesi√≥n cerrada correctamente")}}function deshabilitarBotonesAuth(e){[document.getElementById("btn-google"),document.getElementById("btn-google-menu")].filter(e=>null!==e).forEach(o=>{e?(o.disabled=!0,o.style.opacity="0.6",o.innerHTML='\n                <span class="loader-google"></span>\n            '):(o.disabled=!1,o.style.opacity="1","btn-google"===o.id?o.innerHTML='\n                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="22" height="22" viewBox="0 0 48 48">\n                        <path fill="#fbc02d" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12\ts5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20\ts20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#e53935" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039\tl5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4caf50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36\tc-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1565c0" d="M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571\tc0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>\n                    </svg>\n                    <span></span>\n                ':o.innerHTML='\n                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="22" height="22" viewBox="0 0 48 48">\n                        <path fill="#fbc02d" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12\ts5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20\ts20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#e53935" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039\tl5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4caf50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36\tc-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1565c0" d="M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571\tc0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>\n                    </svg>\n                    <span>Iniciar sesi√≥n</span>\n                ')})}function mostrarErrorAuth(e){let o="Error al autenticar";o={"auth/popup-blocked":"El navegador bloque√≥ la ventana de inicio de sesi√≥n. Por favor, permite ventanas emergentes para este sitio.","auth/popup-closed-by-user":"Cerraste la ventana de inicio de sesi√≥n. Intenta nuevamente.","auth/cancelled-popup-request":"Solicitud cancelada.","auth/operation-not-allowed":"Esta operaci√≥n no est√° permitida. Contacta al administrador.","auth/operation-not-supported-in-this-environment":"Este navegador no soporta la autenticaci√≥n con popup.","auth/unauthorized-domain":"Este dominio no est√° autorizado para autenticaci√≥n."}[e.code]||e.message||"Error desconocido al autenticar","function"==typeof mostrarError?mostrarError(o):alert(o)}function guardarUsuario(e){localStorage.setItem("usuario",JSON.stringify({uid:e.uid,nombre:e.displayName,email:e.email,photoURL:e.photoURL}))}function limpiarUsuario(){localStorage.removeItem("usuario")}async function actualizarUIUsuario(e){const o=document.getElementById("auth-container"),a=(document.getElementById("menu-auth-container"),document.querySelectorAll(".nav-item-auth")),r=document.querySelectorAll(".nav-item-no-auth");e&&!e.isAnonymous?(o.innerHTML=`\n            <p class="usuario-nombre">\n                <svg class="check-icon" viewBox="0 0 24 24" width="16" height="16">\n                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="#4CAF50"/>\n                </svg>\n                ${e.displayName}\n            </p>\n        `,r.forEach(e=>e.style.display="none"),a.forEach(e=>e.style.display="block"),guardarUsuario(e),actualizarSubmenusDinamicos(e),actualizarVisibilidadMenu(e),setTimeout(()=>{if("function"==typeof cargarTurnosUsuario){Date.now()-ultimaCargaTurnos>CACHE_DURACION&&cargarTurnosUsuario()}},1e3),pasoActual>=4&&autocompletarFormulario(e)):(o.innerHTML='\n            <button id="btn-google" class="google-btn">\n                <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="22" height="22" viewBox="0 0 48 48">\n                    <path fill="#fbc02d" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12\ts5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20\ts20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>\n                    <path fill="#e53935" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039\tl5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>\n                    <path fill="#4caf50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36\tc-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>\n                    <path fill="#1565c0" d="M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571\tc0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>\n                </svg>\n                <span></span>\n            </button>\n        ',a.forEach(e=>e.style.display="none"),r.forEach(e=>e.style.display="block"),limpiarUsuario()),setTimeout(configurarEventosAuth,100)}async function manejarOpcionProtegida(e){if(usuarioActual)switch(e){case"perfil":console.log("Navegando al perfil de:",usuarioActual.displayName);break;case"mis-turnos":console.log("Mostrando turnos de:",usuarioActual.displayName)}else mostrarError("Debes iniciar sesi√≥n para acceder a esta funci√≥n.")}function mostrarBotonLogin(){const e=document.querySelector("nav h1").parentElement;e.querySelector("#btn-google")||(e.innerHTML+='<button id="btn-google">Acceder</button>')}function autocompletarFormulario(e){const o=document.getElementById("nombre"),a=document.getElementById("email");o&&!o.value&&e.displayName&&(o.value=e.displayName,validarNombre()),a&&!a.value&&e.email&&(a.value=e.email,validarEmail(),datosReserva.email=e.email),e&&localStorage.setItem("usuario",JSON.stringify({uid:e.uid,nombre:e.displayName,email:e.email,telefono:e.phoneNumber||""}))}function cargarDatosGuardados(){const e=localStorage.getItem("usuario");if(e){const o=JSON.parse(e);document.getElementById("nombre").value=o.nombre||"",document.getElementById("email").value=o.email||"",document.getElementById("telefono").value=o.telefono||""}}function esUsuarioAdministrador(e){return e&&"YI2RkSy5j9W2xPVnPqNnghuif9f1"===e.uid}function actualizarBotonAdmin(e){document.querySelectorAll(".btn-admin").forEach(o=>{esUsuarioAdministrador(e)?o.style.display="block":o.style.display="none"})}function mostrarMensajeExito(e){let o=document.getElementById("mensaje-exito");o||(o=document.createElement("div"),o.id="mensaje-exito",o.className="mensaje-exito",document.body.appendChild(o)),o.innerHTML=`\n        <div class="mensaje-contenido">\n            <svg viewBox="0 0 24 24" width="24" height="24">\n                <path fill="#4CAF50" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>\n            </svg>\n            <span>${e}</span>\n        </div>\n    `,o.classList.add("visible"),setTimeout(()=>{o.classList.remove("visible")},3e3)}function actualizarSubmenusDinamicos(e){if(e){const o=document.getElementById("usuario-nombre"),a=document.getElementById("usuario-email");o&&(o.textContent=e.displayName||"Usuario"),a&&(a.textContent=e.email||"Email no disponible")}}function actualizarVisibilidadMenu(e){const o=document.querySelectorAll(".nav-item-auth"),a=document.querySelectorAll(".nav-item-no-auth");e?(o.forEach(e=>e.style.display="block"),a.forEach(e=>e.style.display="none")):(o.forEach(e=>e.style.display="none"),a.forEach(e=>e.style.display="block")),setTimeout(()=>{inicializarAcordeonMenu()},100)}let intervaloActualizacionTurnos=null,ultimaCargaTurnos=0;const CACHE_DURACION=3e5;function mostrarError(e){document.querySelectorAll(".modal-error, .modal-overlay").forEach(e=>e.remove());const o=document.createElement("div");o.className="modal-overlay";const a=document.createElement("div");a.className="modal-error";let r=e;if(e.includes("minutos")||e.includes("horario")){const e=calcularDuracionTotal(),o=Math.floor(e/60),a=e%60;r=`\n            <svg viewBox="0 0 24 24" width="48" height="48" style="margin-bottom: 1rem;">\n                <path fill="#ff6b6b" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>\n            </svg>\n            <h3>¬°Cruce de horarios!</h3>\n            <p>\n                Tu turno necesita <strong>${o>0?`${o} hora${o>1?"s":""}${a>0?` y ${a} minutos`:""}`:`${a} minutos`}</strong> como m√≠nimo.\n                <br><br>\n                Por favor, eleg√≠ otro horario donde entren todos tus servicios.\n            </p>\n        `}a.innerHTML=`\n        ${r}\n        <button id="cerrar-modal">¬°Entendido!</button>\n    `,document.body.appendChild(o),document.body.appendChild(a);const t=()=>{a.style.animation="fadeIn 0.3s reverse",o.style.animation="fadeIn 0.3s reverse",setTimeout(()=>{a.remove(),o.remove()},300)};a.querySelector("#cerrar-modal").addEventListener("click",t),o.addEventListener("click",t)}const ErrorHandler={mostrar:(e,o="error")=>{console.log(`[${o.toUpperCase()}] ${e}`),"error"===o&&"function"==typeof mostrarError?mostrarError(e):"warning"===o&&console.warn(e)},manejarErrorFirestore:(e,o)=>{console.error(`Error en ${o}:`,e);const a={"permission-denied":"No tienes permisos para acceder a estos datos","not-found":"No se encontr√≥ la informaci√≥n solicitada",unavailable:"Error de conexi√≥n. Verifica tu internet","failed-precondition":"El servicio no est√° disponible en este momento"}[e.code]||`Error al ${o}. Intenta nuevamente.`;return ErrorHandler.mostrar(a,"error"),[]}},Validador={servicio:e=>{if(!e||"object"!=typeof e)return!1;return["id","nombre","categoriaId"].every(o=>e.hasOwnProperty(o)&&null!=e[o])},especialista:e=>{if(!e||"object"!=typeof e)return!1;return["id","nombre"].every(o=>e.hasOwnProperty(o)&&null!=e[o])},categoria:e=>!(!e||"object"!=typeof e)&&(e.hasOwnProperty("id")&&e.hasOwnProperty("nombre")),filtrarInvalidos:(e,o)=>Array.isArray(e)?e.filter(e=>Validador[o](e)):[]};function inicializarAcordeonMenu(){const e=document.querySelector(".btn-menu"),o=document.querySelector(".menu-lateral");e&&o&&e.addEventListener("click",function(){o.classList.toggle("abierto")})}function inicializarCierreMenuOverlay(){document.addEventListener("click",function(e){const o=document.querySelector(".menu-lateral"),a=document.querySelector(".btn-menu");o&&o.classList.contains("abierto")&&(o.contains(e.target)||a.contains(e.target)||o.classList.remove("abierto"))})}function inicializarAcordeonesServicios(){document.querySelectorAll(".categoria-header").forEach(e=>{e.addEventListener("click",function(){this.dataset.categoriaId;const e=this.nextElementSibling,o=this.querySelector(".acordeon-icon");document.querySelectorAll(".servicios-container").forEach(o=>{if(o!==e){o.style.display="none";const e=o.previousElementSibling.querySelector(".acordeon-icon");e&&e.classList.remove("girado")}});const a="block"===e.style.display;e.style.display=a?"none":"block",o&&o.classList.toggle("girado",!a)})})}function inicializarAcordeonesEspecialistas(){document.querySelectorAll(".btn-ver-especialistas").forEach(e=>{e.addEventListener("click",function(e){e.stopPropagation();const o=this.closest(".categoria-especialistas").querySelector(".especialistas-lista"),a=this.querySelector(".acordeon-icon"),r=o.classList.contains("abierto");document.querySelectorAll(".especialistas-lista.abierto").forEach(e=>{if(e!==o){e.classList.remove("abierto");const o=e.closest(".categoria-especialistas").querySelector(".btn-ver-especialistas").querySelector(".acordeon-icon");o&&o.classList.remove("girado")}}),o.classList.toggle("abierto",!r),a&&a.classList.toggle("girado",!r)})})}function toggleLoader(e){const o=document.querySelector(".btn-siguiente"),a=document.getElementById("reserva-loader");e?(o.style.display="none",a.style.display="inline-block"):(a.style.display="none",o.style.display="flex")}function inicializarAcordeonMenu(){document.querySelectorAll(".nav__list-item .menu").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation();const o=this.closest(".nav__list-item"),a=o.querySelector(".submenu"),r=a.classList.contains("active");cerrarTodosLosSubmenus(),quitarClaseActiveNav(),r||(a.classList.add("active"),this.classList.add("active"),o.classList.add("active-nav"))})}),document.addEventListener("click",function(e){e.target.closest(".nav")||(cerrarTodosLosSubmenus(),quitarClaseActiveNav())}),document.querySelectorAll(".submenu *").forEach(e=>{e.addEventListener("click",function(e){e.stopPropagation()})})}function inicializarCierreMenuOverlay(){document.addEventListener("click",function(e){const o=document.body;if(!o.classList.contains("nav-active"))return;const a=document.querySelector(".nav"),r=document.querySelector(".menu-icon");a.contains(e.target)||r.contains(e.target)||setTimeout(()=>{o.classList.remove("nav-active")},10)});const e=document.querySelector(".nav");e&&e.addEventListener("click",function(e){e.target.closest("button")||e.target.closest("a")||e.target.closest("input")||e.stopPropagation()}),document.addEventListener("keydown",function(e){"Escape"===e.key&&document.body.classList.contains("nav-active")&&document.body.classList.remove("nav-active")})}function quitarClaseActiveNav(){document.querySelectorAll(".nav__list-item").forEach(e=>{e.classList.remove("active-nav")})}function cerrarTodosLosSubmenus(){document.querySelectorAll(".submenu").forEach(e=>{e.classList.remove("active")}),document.querySelectorAll(".menu").forEach(e=>{e.classList.remove("active")})}function obtenerDatosContactoSeguro(){if(window.datosGenerales&&window.datosGenerales.empresa)return window.datosGenerales.empresa;if(void 0!==datosGenerales&&datosGenerales.empresa)return datosGenerales.empresa;const e=localStorage.getItem("contactoCache");if(e)try{return JSON.parse(e)}catch(e){console.warn("Cache de contacto corrupto")}return null}function actualizarMenuContacto(e){if(!e)return!1;try{localStorage.setItem("contactoCache",JSON.stringify(e));const o=document.getElementById("menu-direccion");o&&e.direccion&&(o.textContent=e.direccion);const a=document.getElementById("menu-telefono");a&&e.telefono&&(a.textContent=e.telefono);const r=document.getElementById("menu-email");r&&e.email&&(r.textContent=e.email);const t=e.redesSociales||e.redes;if(t){const e=document.getElementById("menu-instagram"),o=document.getElementById("menu-equis"),a=document.getElementById("menu-whatsapp");e&&t.instagram&&"#"!==t.instagram&&(e.href=t.instagram,e.style.display="flex"),o&&t.equis&&"#"!==t.equis&&(o.href=t.equis,o.style.display="flex"),a&&t.whatsapp&&"#"!==t.whatsapp&&(a.href=t.whatsapp,a.style.display="flex")}return!0}catch(e){return console.error("‚ùå Error actualizando men√∫ contacto:",e),!1}}function inicializarMenuContactoDefinitivo(){console.log("üöÄ Inicializando men√∫ contacto (UNA SOLA CARGA)..."),setTimeout(()=>{actualizarMenuContacto(obtenerDatosContactoSeguro())?console.log("‚úÖ Men√∫ contacto cargado exitosamente (carga √∫nica)"):setTimeout(()=>{actualizarMenuContacto(obtenerDatosContactoSeguro())},5e3)},3e3)}function formatearFecha(e){const o=new Date(e+"T00:00:00");return`${["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"][o.getDay()]} ${o.getDate()} ${["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"][o.getMonth()]}`}function calcularHorarioFin(e,o){const[a,r]=e.split(":").map(Number),t=60*a+r+o,n=t%60;return`${Math.floor(t/60).toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}async function cargarTurnosUsuario(){const e=firebase.auth().currentUser;if(!e)return;const o=document.querySelector("#nav-mis-turnos .submenu ul");if(o)try{ultimaCargaTurnos=Date.now(),o.querySelector(".turno-item")||(o.innerHTML="<li><p>Cargando turnos...</p></li>");const a=await window.firestoreDB.obtenerTurnosPorUsuario(e.uid);if(0===a.length)return void(o.innerHTML="<li><p>No ten√©s turnos reservados</p></li>");const r=a.map(e=>{const o=formatearFecha(e.fecha),a=calcularHorarioFin(e.horarioInicio,e.duracionTotal||30),r=e.montoTotal?`$${e.montoTotal.toLocaleString("es-AR")}`:"Sin se√±ar";return`\n        <li class="turno-item">\n          <p><strong>${o}</strong> de ${e.horarioInicio} a ${a}</p>\n          <p style="margin-top: 4px; color: #4CAF50; font-weight: 500;">${r}</p>\n        </li>\n      `}).join("");o.innerHTML=r}catch(e){console.error("Error cargando turnos:",e),o.querySelector(".turno-item")||(o.innerHTML="<li><p>Error al cargar turnos</p></li>")}}function inicializarSistemaTurnosUsuario(){console.log("üîÑ Inicializando sistema de turnos usuario (optimizado)..."),firebase.auth().onAuthStateChanged(e=>{e?(setTimeout(()=>{cargarTurnosUsuario()},1e3),configurarObservadorMenu()):detenerActualizacionAutomatica()})}function configurarObservadorMenu(){new MutationObserver(e=>{e.forEach(e=>{if("class"===e.attributeName){if(document.body.classList.contains("nav-active")){Date.now()-ultimaCargaTurnos>CACHE_DURACION&&cargarTurnosUsuario(),iniciarActualizacionAutomatica()}else detenerActualizacionAutomatica()}})}).observe(document.body,{attributes:!0})}function iniciarActualizacionAutomatica(){intervaloActualizacionTurnos||(console.log("üì± Men√∫ abierto - iniciando actualizaciones lentas"),intervaloActualizacionTurnos=setInterval(()=>{cargarTurnosUsuario()},3e5))}function detenerActualizacionAutomatica(){intervaloActualizacionTurnos&&(console.log("üì± Men√∫ cerrado - deteniendo actualizaciones autom√°ticas"),clearInterval(intervaloActualizacionTurnos),intervaloActualizacionTurnos=null)}function forzarActualizacionTurnos(){ultimaCargaTurnos=0,cargarTurnosUsuario()}!function(){"use strict";var e,o,a,r;e=void 0,o=void 0,a=function(){o&&o.addEventListener("click",function(){return r(e,"nav-active")})},r=function(e,o){e.classList.contains(o)?e.classList.remove(o):e.classList.add(o)},e=document.querySelector("body"),(o=document.querySelector(".menu-icon"))?(document.querySelectorAll(".nav__list-item"),a()):console.log("Elementos del men√∫ no encontrados (probablemente en admin.html)")}(jQuery),console.log("‚úÖ uiManager.js cargado - Sistema de contacto del men√∫ inicializado"),document.addEventListener("DOMContentLoaded",function(){console.log("üè† DOM cargado - Iniciando soluci√≥n definitiva"),inicializarMenuContactoDefinitivo(),console.log("üìÖ Sistema de turnos usuario inicializado"),inicializarSistemaTurnosUsuario()});const esAdminPage=window.location.pathname.includes("admin.html");if(esAdminPage){console.log("‚úÖ admin.js: Inicializando en admin.html");const e="YI2RkSy5j9W2xPVnPqNnghuif9f1";function obtenerElementosAdmin(){return{authContainer:document.getElementById("auth-container"),adminPanel:document.getElementById("admin-panel"),loginBtn:document.getElementById("btn-admin-login"),logoutBtn:document.getElementById("logout-btn"),calendar:document.getElementById("calendar"),turnosList:document.getElementById("turnos-list"),fechaTitulo:document.getElementById("fecha-titulo"),modalEditar:document.getElementById("modal-editar"),formEditar:document.getElementById("form-editar"),btnEliminarModal:document.getElementById("btn-eliminar-modal"),closeModal:document.querySelector(".close-modal")}}const o=obtenerElementosAdmin();let a,r=null,t={},n=!1,i=[],s={};async function initAdmin(){await verificarFirestore()&&(o.authContainer||(console.log("‚ùå Elementos de admin no encontrados, reintentando..."),Object.assign(o,obtenerElementosAdmin()),o.authContainer))&&(firebase.auth().onAuthStateChanged(handleAuthState),o.loginBtn&&o.loginBtn.addEventListener("click",signInWithGoogle),o.logoutBtn&&o.logoutBtn.addEventListener("click",signOut),o.closeModal&&o.closeModal.addEventListener("click",()=>{o.modalEditar.style.display="none"}),o.formEditar&&o.formEditar.addEventListener("submit",async e=>{e.preventDefault(),await guardarCambiosTurno()}),window.addEventListener("click",e=>{e.target===o.modalEditar&&(o.modalEditar.style.display="none"),e.target===document.getElementById("modal-servicio")&&(document.getElementById("modal-servicio").style.display="none")}),setupModalEvents(),inicializarGestionServicios(),inicializarGestionPersonal(),inicializarNavegacionAdmin(),setTimeout(()=>{setupModalEvents()},1e3),console.log("‚úÖ admin.js inicializado completamente"))}async function verificarFirestore(){try{await obtenerConfiguracion();return await cargarEspecialistas(),await cargarServicios(),console.log("‚úÖ Firestore verificado y datos cargados"),!0}catch(e){return console.error("Error conectando con Firestore:",e),alert("Error al conectar con la base de datos. Recargando..."),setTimeout(()=>location.reload(),3e3),!1}}async function handleAuthState(o){console.log("Estado de autenticaci√≥n cambiado:",o?o.uid:"No user"),o&&o.uid===e?(console.log("Usuario es admin, mostrando panel..."),await showAdminPanel(),await initCalendar()):(console.log("Usuario no es admin, mostrando login..."),showLoginScreen())}async function signInWithGoogle(){try{const e=new firebase.auth.GoogleAuthProvider;await firebase.auth().signInWithPopup(e)}catch(e){console.error("Error de autenticaci√≥n:",e),alert("Error al iniciar sesi√≥n: "+e.message)}}async function signOut(){try{await firebase.auth().signOut()}catch(e){console.error("Error al cerrar sesi√≥n:",e)}}async function showAdminPanel(){console.log("Ejecutando showAdminPanel"),o.authContainer&&(o.authContainer.style.display="none",console.log("Auth container oculto")),o.adminPanel?(o.adminPanel.style.display="block",console.log("Admin panel mostrado")):console.error("elements.adminPanel es null o undefined")}function showLoginScreen(){o.authContainer&&(o.authContainer.style.display="flex"),o.adminPanel&&(o.adminPanel.style.display="none"),a&&a.destroy()}function inicializarNavegacionAdmin(){console.log("üîÑ Inicializando navegaci√≥n del panel admin...");const e=document.querySelectorAll(".nav-enlace"),o=document.querySelector(".nav-enlace-overlay"),a=document.querySelector(".container-cal-tur"),r=document.querySelector(".admin-container_servicios"),t=document.querySelector(".admin-container_personal");if(!(e.length&&a&&r&&t))return void console.error("‚ùå No se encontraron todos los elementos de navegaci√≥n");function n(e){a.style.display="none",r.style.display="none",t.style.display="none",e.style.display="flex"}function i(e){const o=document.querySelector(".nav-enlace-overlay");if(!o)return;const a=e.closest(".nav-admin"),r=e.getBoundingClientRect(),t=a.getBoundingClientRect(),n=getComputedStyle(e),i=parseFloat(n.paddingLeft),s=parseFloat(n.paddingRight),c=r.left-t.left-i,l=r.width+s;o.style.width=`${l}px`,o.style.left=`${c}px`}function s(o,a,r){console.log(`üîÑ Cambiando a secci√≥n: ${r}`),e.forEach(e=>e.classList.remove("active")),o.classList.add("active"),i(o),n(a),"Servicios"===r?cargarServiciosYMostrar():"Personal"===r&&cargarPersonalYMostrar(),console.log(`‚úÖ Secci√≥n ${r} activada`)}console.log("‚úÖ Elementos de navegaci√≥n encontrados:",{enlaces:e.length,calendario:!!a,servicios:!!r,personal:!!t}),e.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const o=this.querySelector(".nav-enlace-texto").textContent.trim();switch(o){case"Calendario":s(this,a,o);break;case"Servicios":s(this,r,o);break;case"Personal":s(this,t,o);break;default:console.warn("‚ö†Ô∏è Secci√≥n no reconocida:",o)}})});const c=document.querySelector(".nav-enlace.active");if(c&&o&&i(c),c){switch(c.querySelector(".nav-enlace-texto").textContent.trim()){case"Calendario":n(a);break;case"Servicios":n(r),cargarServiciosYMostrar();break;case"Personal":n(t)}}else n(a);console.log("‚úÖ Navegaci√≥n del panel admin inicializada correctamente")}function inicializarNavegacionCuandoPanelListo(){const e=document.getElementById("admin-panel");e&&"none"!==e.style.display?inicializarNavegacionAdmin():setTimeout(inicializarNavegacionCuandoPanelListo,500)}function inicializarTabBar(){const e=document.querySelector(".nav-admin"),o=e.querySelectorAll(".nav-enlace"),a=e.querySelector(".nav-enlace-overlay");function r(r){o.forEach(e=>e.classList.remove("active")),r.classList.add("active");const t=r.getBoundingClientRect(),n=e.getBoundingClientRect(),i=getComputedStyle(r),s=parseFloat(i.paddingLeft),c=parseFloat(i.paddingRight),l=t.left-n.left-s,d=t.width+c;a.style.width=`${d}px`,a.style.left=`${l}px`}o.forEach(e=>{e.addEventListener("click",()=>r(e))});const t=e.querySelector(".nav-enlace.active");t&&setTimeout(()=>r(t),100),window.addEventListener("resize",()=>{const o=e.querySelector(".nav-enlace.active");o&&setTimeout(()=>r(o),50)})}function mostrarMensajeExito(e){let o=document.getElementById("mensaje-exito-admin");o&&o.remove(),o=document.createElement("div"),o.id="mensaje-exito-admin",o.className="mensaje-exito",o.innerHTML=`\n        <div class="mensaje-contenido">\n          <svg viewBox="0 0 24 24" width="24" height="24">\n            <path fill="#4CAF50" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>\n          </svg>\n          <span>${e}</span>\n          <div class="barra-progreso-notificacion"></div>\n        </div>\n      `,document.body.appendChild(o),setTimeout(()=>{o.classList.add("visible")},10),setTimeout(()=>{o.classList.remove("visible"),setTimeout(()=>{o.parentNode&&o.remove()},300)},5e3)}function mostrarMensajeError(e){let o=document.getElementById("mensaje-error-admin");o&&o.remove(),o=document.createElement("div"),o.id="mensaje-error-admin",o.className="mensaje-error",o.innerHTML=`\n        <div class="mensaje-contenido error">\n          <svg viewBox="0 0 24 24" width="24" height="24">\n            <path fill="#f44336" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n          </svg>\n          <span>${e}</span>\n          <div class="barra-progreso-notificacion"></div>\n        </div>\n      `,document.body.appendChild(o),setTimeout(()=>{o.classList.add("visible")},10),setTimeout(()=>{o.classList.remove("visible"),setTimeout(()=>{o.parentNode&&o.remove()},300)},5e3)}function mostrarLoading(){const e=document.createElement("div");return e.className="loading-indicator",e.textContent="Procesando...",document.body.appendChild(e),e}async function cargarServicios(){try{const e=await db.collection("servicios").get();s={},e.forEach(e=>{s[e.id]=e.data()}),console.log("Servicios cargados:",Object.keys(s).length)}catch(e){console.error("Error cargando servicios:",e)}}async function cargarEspecialistas(){try{console.log("üîç Iniciando carga de especialistas..."),n=!0;const e=await db.collection("especialistas").get(),o={};console.log(`üìä Encontrados ${e.size} especialistas en Firestore`);let a=0;return e.forEach(e=>{const r=e.data();o[e.id]=r,console.log(`üë§ Cargado: ${e.id} -> ${r.nombre}`),a++}),t={...t,...o},console.log("‚úÖ Especialistas cargados exitosamente:",a),console.log("üóÇÔ∏è IDs en el mapa:",Object.keys(t)),i.length>0&&(console.log("üîÑ Reprocesando eventos pendientes..."),i.forEach(e=>e()),i=[]),a}catch(e){return console.error("‚ùå Error cargando especialistas:",e),0}finally{n=!1}}function obtenerNombreEspecialista(e){if(!e||"sin-especialista"===e)return"Sin especialista asignado";const o=t[e];return o&&o.nombre?o.nombre:(n||(console.log(`üîÑ Especialista ${e} no encontrado, cargando bajo demanda...`),cargarEspecialistaIndividual(e)),formatearNombreDesdeId(e))}async function cargarEspecialistaIndividual(e){try{const o=await db.collection("especialistas").doc(e).get();if(o.exists){const r=o.data();t[e]=r,console.log(`‚úÖ Especialista cargado bajo demanda: ${e} -> ${r.nombre}`),a&&a.refetchEvents()}}catch(o){console.error(`‚ùå Error cargando especialista individual ${e}:`,o)}}function formatearNombreDesdeId(e){let o=e.replace(/^esp_/,"");return o=o.replace(/_/g," "),o=o.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}),o}async function recargarEspecialistasYVista(){await cargarEspecialistas(),a&&a.refetchEvents()}async function obtenerConfiguracion(){try{const e=await db.collection("config").doc("horarios").get();if(!e.exists)return obtenerConfiguracionPorDefecto();const o=e.data(),a=(e=>{if(!e)return[1,2,3,4,5];if(Array.isArray(e)&&e.every(e=>"number"==typeof e))return e;if("string"==typeof e)try{const o=e.trim().replace(/[\[\]'"\s]/g,"");return""===o?[1,2,3,4,5]:o.split(",").map(Number).filter(e=>!isNaN(e)&&e>=0&&e<=6)}catch(e){return console.warn("Error parseando d√≠as laborales:",e),[1,2,3,4,5]}return Array.isArray(e)?e.map(e=>"number"==typeof e?e:"string"==typeof e?parseInt(e.replace(/\D/g,""),10):null).filter(e=>!isNaN(e)&&e>=0&&e<=6):[1,2,3,4,5]})(o.diasLaborales).filter(e=>e>=0&&e<=6).sort((e,o)=>e-o);return{horarioApertura:o.horarioApertura||"09:00",horarioCierre:o.horarioCierre||"19:00",duracionTurno:o.duracionTurno||30,diasLaborales:a.length>0?a:[1,2,3,4,5]}}catch(e){return console.error("Error obteniendo configuraci√≥n:",e),obtenerConfiguracionPorDefecto()}}function obtenerConfiguracionPorDefecto(){return{horarioApertura:"09:00",horarioCierre:"19:00",duracionTurno:30,diasLaborales:[1,2,3,4,5]}}function validarHorario(e,o){const[a,r]=e.split(":").map(Number),t=60*a+r,[n,i]=o.horarioApertura.split(":").map(Number),[s,c]=o.horarioCierre.split(":").map(Number);return t<60*n+i||t>=60*s+c?{valido:!1,mensaje:`El horario debe estar entre ${o.horarioApertura} y ${o.horarioCierre}`}:r%o.duracionTurno!==0?{valido:!1,mensaje:`Los turnos deben ser en intervalos de ${o.duracionTurno} minutos (ej: 09:00, 09:30, etc.)`}:{valido:!0}}async function initCalendar(){o.calendar&&(a=new FullCalendar.Calendar(o.calendar,{initialView:"dayGridMonth",locale:"es",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},selectable:!0,selectMirror:!0,dayMaxEvents:!0,selectOverlap:!1,height:"auto",contentHeight:"auto",allDaySlot:!1,slotMinTime:"09:00:00",slotMaxTime:"20:00:00",slotDuration:"00:30:00",slotLabelInterval:"01:00:00",slotLabelFormat:{hour:"2-digit",minute:"2-digit",hour12:!1},dateClick:async function(e){document.querySelectorAll(".fc-daygrid-day-selected").forEach(e=>{e.classList.remove("fc-daygrid-day-selected")}),e.dayEl.classList.add("fc-daygrid-day-selected");const o=e.dayEl.querySelector(".fc-daygrid-more-link");if(o)o.click();else{a.getEvents().filter(o=>{const a=o.start;return a&&a.toISOString().split("T")[0]===e.dateStr&&!o.extendedProps.esContador}).length,await loadTurnosForDate(e.dateStr)}},events:async function(e,o,a){try{const a=await db.collection("turnos").where("fecha",">=",e.startStr).where("fecha","<=",e.endStr).get(),r=[];a.docs.forEach(e=>{const o=e.data(),a=o.cliente?.nombre||"Cliente no especificado",t=obtenerNombresServicios(o.serviciosIds),n=o.especialistaIds||[];if(0===n.length){const n=o.horario||o.horarioInicio||"00:00";r.push(crearEventoTurno(e.id,o,a,t,"sin-especialista",n,n))}else if(1===n.length){const i=n[0],s=o.horario||o.horarioInicio||"00:00";r.push(crearEventoTurno(e.id,o,a,t,i,s,s))}else n.forEach(n=>{let i=o.horarioInicio,s=o.horarioInicio;if(o.slotsPorEspecialista&&o.slotsPorEspecialista[n]){const e=o.slotsPorEspecialista[n];if(e.length>0){i=e[0];let a=30;if(o.serviciosPorEspecialista&&o.serviciosPorEspecialista[n]){a=o.serviciosPorEspecialista[n].reduce((e,o)=>e+(o.duracion||30),0)}const[r,t]=i.split(":").map(Number),c=60*r+t+a;s=`${Math.floor(c/60).toString().padStart(2,"0")}:${(c%60).toString().padStart(2,"0")}`}}let c=t;if(o.serviciosPorEspecialista&&o.serviciosPorEspecialista[n]){c=o.serviciosPorEspecialista[n].map(e=>e.nombre).join(", ")}r.push(crearEventoTurno(`${e.id}_${n}`,o,a,c,n,i,s,!0))})}),o(r)}catch(e){console.error("Error cargando eventos:",e),o([])}},eventClick:function(e){abrirModalEdicion(e.event)},select:function(e){a.unselect()},views:{dayGridMonth:{dayMaxEvents:0,dayMaxEventRows:1,displayEventTime:!1},timeGridWeek:{dayHeaderFormat:{weekday:"short",day:"numeric",month:"short"},slotEventOverlap:!1,eventMinHeight:20,allDaySlot:!1},timeGridDay:{dayHeaderFormat:{weekday:"long",day:"numeric",month:"long",year:"numeric"},slotEventOverlap:!1,eventMinHeight:20,allDaySlot:!1}},eventTimeFormat:{hour:"2-digit",minute:"2-digit",hour12:!1},viewDidMount:function(){document.querySelectorAll(".fc-daygrid-day-selected").forEach(e=>{e.classList.remove("fc-daygrid-day-selected")})},eventDidMount:function(e){const{event:o}=e,a=o.start.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",hour12:!1}),r=o.end?o.end.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",hour12:!1}):"Fin no definido",t=o.end?Math.round((o.end-o.start)/6e4)+" min":"Duraci√≥n no definida",n=`\n            <strong>Cliente:</strong> ${o.extendedProps.cliente}<br>\n            <strong>Especialista:</strong> ${o.extendedProps.especialista}<br>\n            <strong>Servicios:</strong> ${o.extendedProps.servicios}<br>\n            <strong>Horario:</strong> ${a} - ${r}<br>\n            <strong>Duraci√≥n:</strong> ${t}\n          `;e.el.setAttribute("title",n.replace(/<br>/g,"\n"))}}),a.render())}function crearEventoTurno(e,o,a,r,t,n,i,s=!1){const c=obtenerNombreEspecialista(t),l=`${a} - ${c}`;let d=i;if(n===i){let e=30;if(o.serviciosPorEspecialista&&o.serviciosPorEspecialista[t]){e=o.serviciosPorEspecialista[t].reduce((e,o)=>e+(o.duracion||30),0)}else o.duracionTotal&&o.especialistaIds&&o.especialistaIds.length>0&&(e=Math.round(o.duracionTotal/o.especialistaIds.length));const[a,r]=n.split(":").map(Number),i=60*a+r+e;d=`${Math.floor(i/60).toString().padStart(2,"0")}:${(i%60).toString().padStart(2,"0")}`}const u=s?e.split("_")[0]:null,p=u?generarColorDesdeId(u):null;return{id:e,title:l,start:`${o.fecha}T${n}`,end:`${o.fecha}T${d}`,allDay:!1,extendedProps:{turnoId:o.id||e.split("_")[0],cliente:a,telefono:o.cliente?.telefono||"No especificado",email:o.cliente?.email||"No especificado",servicios:r,especialista:c,especialistaId:t,todosLosEspecialistas:o.especialistaIds?o.especialistaIds.map(e=>obtenerNombreEspecialista(e)).join(", "):c,observaciones:o.observaciones||"Sin observaciones",estado:o.estado||"pendiente",esMultiplesEspecialistas:s,horarioInicio:n,horarioFin:d,duracion:calcularDuracionEnMinutos(n,d),turnoBaseId:u,colorBordeGrupo:p},className:`fc-event-${o.estado||"pendiente"} ${s?"fc-event-grupo-multiple":""}`,borderColor:s?p:"transparent",backgroundColor:getEventColorBySpecialist(t),textColor:"#ffffff"}}function generarColorDesdeId(e){const o=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9","#F8C471","#82E0AA","#F1948A","#D7BDE2","#A3E4D7"];let a=0;for(let o=0;o<e.length;o++)a=e.charCodeAt(o)+((a<<5)-a);return o[Math.abs(a)%o.length]}function getEventColorBySpecialist(e){const o={esp_analia_solange:"#b285bfff",esp_agustin_matias:"#aaaad3ff",esp_blondie_flores:"#95bec3ff",esp_monica_flores:"#92bc8bff"};if(o[e])return o[e];const a=["#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9","#F8C471","#82E0AA","#F1948A","#D7BDE2","#A3E4D7","#F9E79F","#D2B4DE","#A9CCE3"];let r=0;for(let o=0;o<e.length;o++)r=e.charCodeAt(o)+((r<<5)-r);return a[Math.abs(r)%a.length]}function getEventColor(e){switch(e){case"confirmado":return"#4CAF50";case"cancelado":return"#F44336";case"completado":return"#2196F3";default:return"#FF9800"}}function calcularDuracionEnMinutos(e,o){const[a,r]=e.split(":").map(Number),[t,n]=o.split(":").map(Number);return 60*t+n-(60*a+r)}async function recargarVistaCalendario(){if(a)try{console.log("üîÑ Recargando vista del calendario...");const e=a.view,o=e.type,r=e.currentStart;console.log(`üìä Vista actual: ${o}, Fecha: ${r}`),"timeGridWeek"===o||"timeGridDay"===o?(a.changeView("dayGridMonth",r),setTimeout(()=>{a.changeView(o,r)},100)):a.refetchEvents()}catch(e){console.error("‚ùå Error recargando vista calendario:",e),a&&a.refetchEvents()}}async function loadTurnosForDate(e){try{console.log("üîÑ Cargando turnos para fecha:",e);const a=new Date(e),r=new Date(a.getTime()+6e4*a.getTimezoneOffset()),t={weekday:"long",year:"numeric",month:"long",day:"numeric"};o.fechaTitulo.textContent=`Turnos para ${r.toLocaleDateString("es-AR",t)}`;const n=await db.collection("turnos").where("fecha","==",e).orderBy("horario","asc").get();console.log(`üìä Encontrados ${n.docs.length} turnos`),renderTurnos(n.docs.map(e=>({id:e.id,...e.data()})))}catch(e){console.error("‚ùå Error cargando turnos:",e),o.turnosList.innerHTML="<p>Error al cargar los turnos. Intente nuevamente.</p>"}}function renderTurnos(e){o.turnosList&&(0!==e.length?(o.turnosList.innerHTML=e.map(e=>{const o=(e.especialistaIds||[]).map(e=>obtenerNombreEspecialista(e)).join(", ");let a=obtenerNombresServicios(e.serviciosIds);e.serviciosPorEspecialista&&(a="",Object.keys(e.serviciosPorEspecialista).forEach(o=>{const r=e.serviciosPorEspecialista[o],t=obtenerNombreEspecialista(o),n=r.map(e=>e.nombre).join(", ");a+=`<strong>${t}:</strong> ${n}<br>`}));let r=e.horarioInicio||"No especificado";return e.slotsPorEspecialista&&(r="",Object.keys(e.slotsPorEspecialista).forEach(o=>{const a=e.slotsPorEspecialista[o],t=obtenerNombreEspecialista(o);a.length>0&&(r+=`<strong>${t}:</strong> ${a[0]}<br>`)})),`\n        <div class="turno-card" data-id="${e.id}">\n          <div class="turno-header" data-id="${e.id}">\n            <div class="turno-sumario">\n              <span class="turno-horario">${e.horarioInicio}</span>\n              <span class="turno-cliente">${e.cliente.nombre}</span>\n              <span class="turno-especialista">${o}</span>\n              <span class="turno-estado ${e.estado||"pendiente"}">${e.estado||"pendiente"}</span>\n            </div>\n            <span class="toggle-icon">‚ñº</span>\n          </div>\n          <div class="turno-detalles">\n            <div class="turno-info">\n              <p><strong>Servicios por especialista:</strong><br>${a}</p>\n              <p><strong>Especialistas:</strong> ${o}</p>\n              <p><strong>Horarios:</strong><br>${r}</p>\n              <p><strong>Tel√©fono:</strong> ${e.cliente.telefono}</p>\n              <p><strong>Email:</strong> ${e.cliente.email}</p>\n              ${e.duracionTotal?`<p><strong>Duraci√≥n total:</strong> ${e.duracionTotal} minutos</p>`:""}\n              ${e.montoTotal?`<p><strong>Monto total:</strong> $${e.montoTotal}</p>`:""}\n              ${e.observaciones?`<p><strong>Observaciones:</strong> ${e.observaciones}</p>`:""}\n            </div>\n            <div class="turno-actions">\n              <button class="btn-editar" data-id="${e.id}">Editar</button>\n              <button class="btn-eliminar-lista" data-id="${e.id}">Eliminar</button>\n            </div>\n          </div>\n        </div>\n        `}).join(""),document.querySelectorAll(".turno-header").forEach(e=>{e.addEventListener("click",function(e){if("BUTTON"===e.target.tagName)return;const o=this.closest(".turno-card"),a=o.querySelector(".turno-detalles"),r=this.querySelector(".toggle-icon");o.classList.toggle("expanded"),a.style.display=o.classList.contains("expanded")?"block":"none",r.textContent=o.classList.contains("expanded")?"‚ñ≤":"‚ñº"})}),document.querySelectorAll(".btn-eliminar-lista").forEach(e=>{e.addEventListener("click",async e=>{e.stopPropagation();const o=e.currentTarget.getAttribute("data-id");if(confirm("¬øEst√°s seguro de eliminar este turno?")){const e=mostrarLoading();try{await eliminarTurno(o);const e=(new Date).toISOString().split("T")[0];await loadTurnosForDate(e)}catch(e){console.error("Error eliminando desde lista:",e),alert("Error al eliminar el turno")}finally{e.remove()}}})}),document.querySelectorAll(".btn-editar").forEach(e=>{e.addEventListener("click",async e=>{e.stopPropagation();const o=e.currentTarget.getAttribute("data-id");await abrirModalEdicionPorId(o)})})):o.turnosList.innerHTML='<p class="sin-turnos">No hay turnos para esta fecha.</p>')}async function abrirModalEdicion(e){try{const a=await obtenerConfiguracion();await generarOpcionesHorario(a),r=e.extendedProps.turnoId,document.getElementById("turno-id").value=r,document.getElementById("edit-fecha").value=e.start.toISOString().split("T")[0];const t=e.start.getHours().toString().padStart(2,"0"),n=e.start.getMinutes().toString().padStart(2,"0");document.getElementById("edit-horario").value=`${t}:${n}`;const i=e.extendedProps.esMultiplesEspecialistas?`\n            <p>\n              <strong>\n                <svg\n                  xmlns="http://www.w3.org/2000/svg"\n                  width="20"\n                  height="20"\n                  viewBox="0 0 24 24"\n                  fill="none"\n                  stroke="#020202"\n                  stroke-width="1.5"\n                  stroke-linecap="round"\n                  stroke-linejoin="round"\n                >\n                  <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />\n                  <path d="M6 21v-2a4 4 0 0 1 4 -4h.5" />\n                  <path d="M18 22l3.35 -3.284a2.143 2.143 0 0 0 .005 -3.071a2.242 2.242 0 0 0 -3.129 -.006l-.224 .22l-.223 -.22a2.242 2.242 0 0 0 -3.128 -.006a2.143 2.143 0 0 0 -.006 3.071l3.355 3.296z" />\n                </svg>\n              </strong>\n              <span>${e.extendedProps.cliente}</span>\n            </p>\n            <p>\n              <strong>\n                <svg\n                  xmlns="http://www.w3.org/2000/svg"\n                  width="20"\n                  height="20"\n                  viewBox="0 0 24 24"\n                  fill="none"\n                  stroke="#020202"\n                  stroke-width="1.5"\n                  stroke-linecap="round"\n                  stroke-linejoin="round"\n                >\n                  <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />\n                </svg>\n              </strong> \n              <span>${e.extendedProps.servicios}</span>\n            </p>\n            <p>\n              <strong>\n                <svg\n                  xmlns="http://www.w3.org/2000/svg"\n                  width="20"\n                  height="20"\n                  viewBox="0 0 24 24"\n                  fill="none"\n                  stroke="#020202"\n                  stroke-width="1.5"\n                  stroke-linecap="round"\n                  stroke-linejoin="round"\n                >\n                  <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />\n                  <path d="M6 21v-2a4 4 0 0 1 4 -4h.5" />\n                  <path d="M17.8 20.817l-2.172 1.138a.392 .392 0 0 1 -.568 -.41l.415 -2.411l-1.757 -1.707a.389 .389 0 0 1 .217 -.665l2.428 -.352l1.086 -2.193a.392 .392 0 0 1 .702 0l1.086 2.193l2.428 .352a.39 .39 0 0 1 .217 .665l-1.757 1.707l.414 2.41a.39 .39 0 0 1 -.567 .411l-2.172 -1.138z" />\n                </svg>\n              </strong> \n              <span>${e.extendedProps.especialista}</span>\n            </p>\n            <p>\n              <strong>\n                <svg\n                  xmlns="http://www.w3.org/2000/svg"\n                  width="20"\n                  height="20"\n                  viewBox="0 0 24 24"\n                  fill="none"\n                  stroke="#020202"\n                  stroke-width="1.5"\n                  stroke-linecap="round"\n                  stroke-linejoin="round"\n                >\n                  <path d="M17.8 19.817l-2.172 1.138a.392 .392 0 0 1 -.568 -.41l.415 -2.411l-1.757 -1.707a.389 .389 0 0 1 .217 -.665l2.428 -.352l1.086 -2.193a.392 .392 0 0 1 .702 0l1.086 2.193l2.428 .352a.39 .39 0 0 1 .217 .665l-1.757 1.707l.414 2.41a.39 .39 0 0 1 -.567 .411l-2.172 -1.138z" />\n                  <path d="M6.2 19.817l-2.172 1.138a.392 .392 0 0 1 -.568 -.41l.415 -2.411l-1.757 -1.707a.389 .389 0 0 1 .217 -.665l2.428 -.352l1.086 -2.193a.392 .392 0 0 1 .702 0l1.086 2.193l2.428 .352a.39 .39 0 0 1 .217 .665l-1.757 1.707l.414 2.41a.39 .39 0 0 1 -.567 .411l-2.172 -1.138z" />\n                  <path d="M12 9.817l-2.172 1.138a.392 .392 0 0 1 -.568 -.41l.415 -2.411l-1.757 -1.707a.389 .389 0 0 1 .217 -.665l2.428 -.352l1.086 -2.193a.392 .392 0 0 1 .702 0l1.086 2.193l2.428 .352a.39 .39 0 0 1 .217 .665l-1.757 1.707l.414 2.41a.39 .39 0 0 1 -.567 .411l-2.172 -1.138z" />\n                </svg>\n              </strong> \n              <span>${e.extendedProps.todosLosEspecialistas}</span>\n            </p>\n            <p>\n              <strong>\n                <svg\n                  xmlns="http://www.w3.org/2000/svg"\n                  width="20"\n                  height="20"\n                  viewBox="0 0 24 24"\n                  fill="none"\n                  stroke="#020202"\n                  stroke-width="1.5"\n                  stroke-linecap="round"\n                  stroke-linejoin="round"\n                >\n                  <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />\n                  <path d="M12 12h3.5" />\n                  <path d="M12 7v5" />\n                </svg>\n              </strong> \n              <span>${e.extendedProps.horarioInicio} - ${e.extendedProps.horarioFin}</span>\n            </p>\n            <p>\n              <strong>\n                <svg\n                  xmlns="http://www.w3.org/2000/svg"\n                  width="20"\n                  height="20"\n                  viewBox="0 0 24 24"\n                  fill="none"\n                  stroke="#020202"\n                  stroke-width="1.5"\n                  stroke-linecap="round"\n                  stroke-linejoin="round"\n                >\n                  <path d="M5 4h4l2 5l-2.5 1.5a11 11 0 0 0 5 5l1.5 -2.5l5 2v4a2 2 0 0 1 -2 2a16 16 0 0 1 -15 -15a2 2 0 0 1 2 -2" />\n                </svg>\n              </strong> \n              <span>${e.extendedProps.telefono}</span>\n            </p>\n          `:`\n            <p>\n              <strong>\n                <svg\n                  xmlns="http://www.w3.org/2000/svg"\n                  width="20"\n                  height="20"\n                  viewBox="0 0 24 24"\n                  fill="none"\n                  stroke="#020202"\n                  stroke-width="1.5"\n                  stroke-linecap="round"\n                  stroke-linejoin="round"\n                >\n                  <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />\n                  <path d="M6 21v-2a4 4 0 0 1 4 -4h.5" />\n                  <path d="M18 22l3.35 -3.284a2.143 2.143 0 0 0 .005 -3.071a2.242 2.242 0 0 0 -3.129 -.006l-.224 .22l-.223 -.22a2.242 2.242 0 0 0 -3.128 -.006a2.143 2.143 0 0 0 -.006 3.071l3.355 3.296z" />\n                </svg>\n              </strong> \n              <span>${e.extendedProps.cliente}</span>\n              </p>\n            <p>\n              <strong>\n                <svg\n                  xmlns="http://www.w3.org/2000/svg"\n                  width="20"\n                  height="20"\n                  viewBox="0 0 24 24"\n                  fill="none"\n                  stroke="#020202"\n                  stroke-width="1.5"\n                  stroke-linecap="round"\n                  stroke-linejoin="round"\n                >\n                  <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />\n                </svg>\n              </strong> \n              <span>${e.extendedProps.servicios}</span>\n            </p>\n            <p>\n              <strong>\n                <svg\n                  xmlns="http://www.w3.org/2000/svg"\n                  width="20"\n                  height="20"\n                  viewBox="0 0 24 24"\n                  fill="none"\n                  stroke="#020202"\n                  stroke-width="1.5"\n                  stroke-linecap="round"\n                  stroke-linejoin="round"\n                >\n                  <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />\n                  <path d="M12 12h3.5" />\n                  <path d="M12 7v5" />\n                </svg>\n              </strong> \n              <span>${e.extendedProps.horarioInicio} - ${e.extendedProps.horarioFin}</span>\n            </p>\n            <p>\n              <strong>\n                <svg\n                  xmlns="http://www.w3.org/2000/svg"\n                  width="20"\n                  height="20"\n                  viewBox="0 0 24 24"\n                  fill="none"\n                  stroke="#020202"\n                  stroke-width="1.5"\n                  stroke-linecap="round"\n                  stroke-linejoin="round"\n                >\n                  <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />\n                  <path d="M6 21v-2a4 4 0 0 1 4 -4h.5" />\n                  <path d="M17.8 20.817l-2.172 1.138a.392 .392 0 0 1 -.568 -.41l.415 -2.411l-1.757 -1.707a.389 .389 0 0 1 .217 -.665l2.428 -.352l1.086 -2.193a.392 .392 0 0 1 .702 0l1.086 2.193l2.428 .352a.39 .39 0 0 1 .217 .665l-1.757 1.707l.414 2.41a.39 .39 0 0 1 -.567 .411l-2.172 -1.138z" />\n                </svg>\n              </strong> \n              <span>${e.extendedProps.especialista}</span>\n            </p>\n            <p>\n              <strong>\n                <svg\n                  xmlns="http://www.w3.org/2000/svg"\n                  width="20"\n                  height="20"\n                  viewBox="0 0 24 24"\n                  fill="none"\n                  stroke="#020202"\n                  stroke-width="1.5"\n                  stroke-linecap="round"\n                  stroke-linejoin="round"\n                >\n                  <path d="M5 4h4l2 5l-2.5 1.5a11 11 0 0 0 5 5l1.5 -2.5l5 2v4a2 2 0 0 1 -2 2a16 16 0 0 1 -15 -15a2 2 0 0 1 2 -2" />\n                </svg>\n              </strong> \n              <span>${e.extendedProps.telefono}</span>\n            </p>\n          `;document.getElementById("turno-info").innerHTML=i,o.modalEditar.style.display="block"}catch(e){console.error("Error abriendo modal de edici√≥n:",e),alert("Error al cargar los datos del turno")}}async function abrirModalEdicionPorId(e){try{const t=await obtenerConfiguracion();await generarOpcionesHorario(t);const n=await db.collection("turnos").doc(e).get();if(!n.exists)return void alert("Turno no encontrado");const i=n.data();r=e;const s=(i.especialistaIds||[]).map(e=>obtenerNombreEspecialista(e)).join(", ");let c=obtenerNombresServicios(i.serviciosIds);i.serviciosPorEspecialista&&(c="",Object.keys(i.serviciosPorEspecialista).forEach(e=>{const o=i.serviciosPorEspecialista[e],a=obtenerNombreEspecialista(e),r=o.map(e=>e.nombre).join(", ");c+=`<strong>${a}:</strong> ${r}<br>`}));let l=i.horarioInicio||"No especificado";i.slotsPorEspecialista&&(l="",Object.keys(i.slotsPorEspecialista).forEach(e=>{const o=i.slotsPorEspecialista[e],a=obtenerNombreEspecialista(e);if(o.length>0){const r=o[0];let t=30;i.serviciosPorEspecialista&&i.serviciosPorEspecialista[e]&&(t=i.serviciosPorEspecialista[e].reduce((e,o)=>e+o.duracion,0));const[n,s]=r.split(":").map(Number),c=60*n+s+t,d=Math.floor(c/60).toString().padStart(2,"0"),u=(c%60).toString().padStart(2,"0");l+=`<strong>${a}:</strong> ${r} - ${`${d}:${u}`}<br>`}})),document.getElementById("turno-id").value=e,document.getElementById("edit-fecha").value=i.fecha,document.getElementById("edit-horario").value=i.horario||i.horarioInicio,document.getElementById("turno-info").innerHTML=`\n          <p><strong>Cliente:</strong> ${i.cliente.nombre}</p>\n          <p><strong>Servicios por especialista:</strong><br>${c}</p>\n          <p><strong>Especialistas:</strong> ${s}</p>\n          <p><strong>Horarios por especialista:</strong><br>${l}</p>\n          <p><strong>Tel√©fono:</strong> ${i.cliente.telefono}</p>\n          <p><strong>Estado:</strong> ${i.estado||"pendiente"}</p>\n          ${i.duracionTotal?`<p><strong>Duraci√≥n total:</strong> ${i.duracionTotal} minutos</p>`:""}\n          ${i.montoTotal?`<p><strong>Monto total:</strong> $${i.montoTotal}</p>`:""}\n          ${i.se√±aAbonada?`<p><strong>Se√±a abonada:</strong> $${i.se√±aAbonada}</p>`:""}\n        `;const d=document.getElementById("btn-eliminar-modal");d&&(d.onclick=async e=>{if(e.stopPropagation(),e.preventDefault(),confirm("¬øEst√°s seguro de eliminar este turno permanentemente?"))try{await eliminarTurno(r)&&(await loadTurnosForDate(i.fecha),a.refetchEvents(),o.modalEditar.style.display="none",alert("Turno eliminado correctamente"))}catch(e){console.error("Error al eliminar turno:",e),alert("Error al eliminar el turno: "+e.message)}}),o.modalEditar.style.display="block"}catch(e){console.error("Error abriendo modal de edici√≥n:",e),alert("Error al cargar los datos del turno")}}function configurarModalEliminar(){const e=document.getElementById("btn-eliminar-modal");e&&(e.onclick=null,e.onclick=async e=>{if(e.preventDefault(),e.stopPropagation(),!r)return console.error("No hay turno seleccionado"),void alert("No hay turno seleccionado para eliminar");if(confirm("¬øEst√°s seguro de eliminar este turno permanentemente? Esta acci√≥n no se puede deshacer.")){const e=mostrarLoading();try{await eliminarTurno(r)}catch(e){console.error("Error en eliminaci√≥n:",e)}finally{e.remove()}}})}async function generarOpcionesHorario(e){const o=document.getElementById("edit-horario");o.innerHTML="";const[a,r]=e.horarioApertura.split(":").map(Number),[t,n]=e.horarioCierre.split(":").map(Number);let i=a,s=r;for(;i<t||i===t&&s<n;){const a=i.toString().padStart(2,"0"),r=s.toString().padStart(2,"0"),t=document.createElement("option");t.value=`${a}:${r}`,t.textContent=`${a}:${r}`,o.appendChild(t),s+=e.duracionTurno,s>=60&&(i+=Math.floor(s/60),s%=60)}}async function verificarDisponibilidad(e,o,a=null){try{const r=await obtenerConfiguracion(),[t,n]=o.split(":").map(Number),i=60*t+n,s=i+r.duracionTurno,c=(await db.collection("turnos").where("fecha","==",e).get()).docs.filter(e=>{if(a&&e.id===a)return!1;const o=e.data(),t=o.horario||o.horarioInicio;if(!t)return!1;const[n,c]=t.split(":").map(Number),l=60*n+c,d=l+(o.duracionTotal||r.duracionTurno);return i<d&&s>l});return{disponible:0===c.length,mensaje:c.length>0?`El horario se solapa con ${c.length} turno(s) existente(s)`:null}}catch(e){return console.error("Error verificando disponibilidad:",e),{disponible:!1,mensaje:"Error al verificar disponibilidad: "+e.message}}}async function verificarDisponibilidadCompletaEspecialista(e,o,a,r,t=null){try{console.log(`üîç Verificando disponibilidad completa para ${e} en ${o} a las ${a}`);const n=await db.collection("especialistas").doc(e).get();if(!n.exists)return{disponible:!1,mensaje:"Especialista no encontrado"};const i=n.data();if(!i.activo)return{disponible:!1,mensaje:"El especialista no est√° activo"};const[s,c,l]=o.split("-").map(Number),d=new Date(s,c-1,l).getDay(),u=["domingo","lunes","martes","miercoles","jueves","viernes","sabado"][d],p=i.horarioLaboral?.[u];if(!p||!p.activo){const o=obtenerNombreEspecialista(e);return{disponible:!1,mensaje:`${o} no trabaja los ${["Domingos","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bados"][d]}`}}const[m,g]=a.split(":").map(Number),h=60*m+g,v=h+r,[f,b]=p.inicio.split(":").map(Number),[y,E]=p.fin.split(":").map(Number),w=60*y+E;if(h<60*f+b)return{disponible:!1,mensaje:`El horario ${a} es antes de la apertura (${p.inicio})`};if(v>w)return{disponible:!1,mensaje:`El turno termina despu√©s del cierre (${p.fin})`};const S=(await db.collection("turnos").where("fecha","==",o).where("especialistaIds","array-contains",e).get()).docs.filter(e=>{if(t&&e.id===t)return!1;const o=e.data(),r=o.horarioInicio||o.horario;if(!r)return!1;const[n,i]=r.split(":").map(Number),s=60*n+i,c=s+(o.duracionTotal||30),l=h<c&&v>s;return l&&console.log(`‚ùå Conflicto con turno ${e.id}: ${r} (${s}-${c}) vs ${a} (${h}-${v})`),l});if(S.length>0){return{disponible:!1,mensaje:`${obtenerNombreEspecialista(e)} tiene ${S.length} turno(s) conflictivo(s) en ese horario`}}return{disponible:!0,mensaje:null}}catch(e){return console.error("Error en verificaci√≥n completa especialista:",e),{disponible:!1,mensaje:"Error al verificar disponibilidad del especialista"}}}async function verificarDisponibilidadCompleta(e,o,a){try{if(e.slotsPorEspecialista)for(const[o,r]of Object.entries(e.slotsPorEspecialista)){if(0===r.length)continue;const t=r[0],n=30*r.length,i=await verificarDisponibilidadCompletaEspecialista(o,e.fecha,t,n,a);if(!i.disponible)return i}else{const r=o.especialistaId||o.especialistaIds&&o.especialistaIds[0];if(r){const t=o.duracionTotal||30,n=await verificarDisponibilidadCompletaEspecialista(r,e.fecha,e.horarioInicio,t,a);if(!n.disponible)return n}}return{disponible:!0,mensaje:null}}catch(e){return console.error("Error en verificaci√≥n completa:",e),{disponible:!1,mensaje:"Error al verificar disponibilidad: "+e.message}}}async function guardarCambiosTurno(){if(r)try{const n=firebase.auth().currentUser;if(!n)return void alert("Debes iniciar sesi√≥n para realizar esta acci√≥n");const i=await n.getIdTokenResult();if(!(!0===i.claims.admin||n.uid===e))return void alert("No tienes permisos de administrador para realizar esta acci√≥n");const s=await obtenerConfiguracion(),c=document.getElementById("edit-horario").value,l=document.getElementById("edit-fecha").value,d=validarHorario(c,s);if(!d.valido)return void alert(d.mensaje);const[u,p,m]=l.split("-").map(Number),g=new Date(u,p-1,m).getDay(),h=["domingo","lunes","martes","miercoles","jueves","viernes","sabado"][g],v=await db.collection("turnos").doc(r).get();if(!v.exists)return void alert("El turno no existe");const f=v.data(),b=f.especialistaIds||[];if(b.length>0){let e=!1,o=[];for(const a of b){const r=t[a];if(r&&r.horarioLaboral){const t=r.horarioLaboral[h];if(t&&t.activo){e=!0,console.log(`‚úÖ ${r.nombre} trabaja los ${h}s`);break}{const e=obtenerNombreEspecialista(a);o.push(`${e} no trabaja los ${h}s`)}}}if(!e)return void alert(`No se puede agendar el turno:\n${o.join("\n")}`)}else{const e=0===g?7:g;if(!s.diasLaborales.includes(e)){return void alert(`No se pueden agendar turnos los ${["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"][g]}s`)}}const[y,E]=c.split(":").map(Number),[w,S]=(f.horarioInicio||f.horario).split(":").map(Number),I=60*y+E-(60*w+S);console.log("üïí Desplazamiento calculado:",I,"minutos");const L={fecha:l,horario:c,horarioInicio:c,actualizadoEl:firebase.firestore.FieldValue.serverTimestamp()};if(f.slotsPorEspecialista&&Object.keys(f.slotsPorEspecialista).length>1){console.log("üîç Turno con m√∫ltiples especialistas detectado");const e={},o={};let a=[],r=null,t=null;Object.keys(f.slotsPorEspecialista).forEach(e=>{const o=f.slotsPorEspecialista[e];if(o&&o.length>0){const e=o[0];(!r||e<r)&&(r=e)}});const[n,i]=r.split(":").map(Number),s=60*n+i,c=s+I;Object.keys(f.slotsPorEspecialista).forEach(r=>{const n=f.slotsPorEspecialista[r];if(n&&n.length>0){const i=n[0],[l,d]=i.split(":").map(Number),u=c+(60*l+d-s),p=u%60,m=`${Math.floor(u/60).toString().padStart(2,"0")}:${p.toString().padStart(2,"0")}`,g=[];for(let e=0;e<n.length;e++){const o=u+30*e,r=o%60,n=`${Math.floor(o/60).toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`;g.push(n),a.push(n);const i=o+30;(!t||i>t)&&(t=i)}e[r]=g,f.serviciosPorEspecialista&&f.serviciosPorEspecialista[r]&&(o[r]=f.serviciosPorEspecialista[r]),console.log(`üë§ Especialista ${r}: ${n[0]} ‚Üí ${m}`)}});const l=Math.floor(t/60),d=t%60,u=`${l.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`;a=[...new Set(a)].sort(),L.slotsPorEspecialista=e,L.slotsOcupados=a,L.horarioFin=u,Object.keys(o).length>0&&(L.serviciosPorEspecialista=o),console.log("üîÑ Slots actualizados para m√∫ltiples especialistas:",e),console.log("üïí Nuevo horario fin:",u)}else{const e=f.duracionTotal||30,[o,a]=c.split(":").map(Number),r=60*o+a,t=r+e,n=Math.floor(t/60).toString().padStart(2,"0"),i=`${n}:${(t%60).toString().padStart(2,"0")}`,s=[];for(let e=r;e<t;e+=30){const o=Math.floor(e/60),a=e%60;s.push(`${o.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`)}if(L.horarioFin=i,L.slotsOcupados=s,f.slotsPorEspecialista){const e={};Object.keys(f.slotsPorEspecialista).forEach(o=>{e[o]=s}),L.slotsPorEspecialista=e}}const C=await verificarDisponibilidadCompleta(L,f,r);if(!C.disponible)return void alert(C.mensaje);console.log("üîÑ Actualizando turno:",r,"con:",L),await db.collection("turnos").doc(r).update(L),console.log("‚úÖ Turno actualizado en Firestore"),await loadTurnosForDate(l),a&&await recargarVistaCalendario(),a&&a.refetchEvents(),o.modalEditar.style.display="none",mostrarMensajeExito("Turno actualizado correctamente")}catch(e){console.error("‚ùå Error actualizando turno:",e),alert("Error al actualizar el turno: "+e.message)}else console.error("currentTurnoId no definido")}async function eliminarTurno(e){if(!e||"string"!=typeof e)return console.error("ID de turno inv√°lido:",e),!1;try{console.log("üóëÔ∏è Iniciando eliminaci√≥n para ID:",e);const r=await db.collection("turnos").doc(e).get();if(!r.exists)return alert("El turno ya no existe"),!1;const t=r.data(),n=t.fecha;return console.log("üìã Datos del turno a eliminar:",t),await db.collection("turnos").doc(e).delete(),console.log("‚úÖ Turno eliminado de Firestore"),a&&(console.log("üîÑ Actualizando calendario..."),a.refetchEvents()),console.log("üîÑ Actualizando lista de turnos para fecha:",n),await loadTurnosForDate(n),o.modalEditar&&"block"===o.modalEditar.style.display&&(o.modalEditar.style.display="none",console.log("üö™ Modal cerrado")),mostrarMensajeExito("Turno eliminado correctamente"),!0}catch(e){console.error("‚ùå Error al eliminar:",e);let o="Error al eliminar el turno";return"permission-denied"===e.code?o="No tienes permisos para eliminar turnos":"not-found"===e.code&&(o="El turno ya no existe"),alert(o+": "+(e.message||"Por favor intente nuevamente")),!1}}function obtenerNombresServicios(e){if(!Array.isArray(e)||0===e.length)return"Servicios no especificados";return e.map(e=>{const o=s[e];return o?o.nombre:e}).join(", ")}function setupModalEvents(){document.getElementById("modal-editar");const e=document.getElementById("btn-eliminar-modal");if(e){e.replaceWith(e.cloneNode(!0));document.getElementById("btn-eliminar-modal").addEventListener("click",async e=>{if(e.preventDefault(),e.stopPropagation(),console.log("üñ±Ô∏è Bot√≥n eliminar clickeado, currentTurnoId:",r),!r)return console.error("‚ùå No hay turno seleccionado para eliminar"),void alert("No hay turno seleccionado para eliminar");if(confirm("¬øEst√°s seguro de eliminar este turno permanentemente? Esta acci√≥n no se puede deshacer.")){console.log("‚úÖ Confirmaci√≥n recibida, eliminando turno:",r);const e=mostrarLoading();try{await eliminarTurno(r)?console.log("üéâ Eliminaci√≥n completada exitosamente"):console.error("‚ùå Eliminaci√≥n fall√≥")}catch(e){console.error("‚ùå Error en eliminaci√≥n:",e)}finally{e.remove()}}})}}document.addEventListener("DOMContentLoaded",inicializarTabBar),document.addEventListener("DOMContentLoaded",function(){setTimeout(()=>{inicializarNavegacionAdmin()},100)}),window.addEventListener("load",inicializarNavegacionCuandoPanelListo);let c={};function inicializarGestionServicios(){console.log("üîÑ Inicializando gesti√≥n de servicios...");const e=document.getElementById("btn-agregar-servicio");e&&e.addEventListener("click",()=>{abrirModalServicio()}),cargarServiciosYMostrar(),configurarModalServicio()}async function cargarServiciosYMostrar(){try{console.log("üì• Cargando servicios y categor√≠as...");const[e,o]=await Promise.all([db.collection("servicios").orderBy("orden").get(),db.collection("categorias").orderBy("orden").get()]);c={},o.forEach(e=>{c[e.id]={id:e.id,...e.data()}}),s={},e.forEach(e=>{s[e.id]={id:e.id,...e.data()}}),console.log(`‚úÖ Cargados ${e.size} servicios y ${o.size} categor√≠as`),console.log("üìã IDs de servicios:",Object.keys(s)),mostrarServiciosEnUI()}catch(e){console.error("‚ùå Error cargando servicios:",e),mostrarMensajeError("Error al cargar los servicios")}}function mostrarServiciosEnUI(){const e=document.getElementById("servicios-list");if(!e)return;const o={};Object.values(s).forEach(e=>{const a=e.categoriaId;o[a]||(o[a]=[]),o[a].push(e)});let a="";Object.keys(c).forEach(e=>{const r=c[e],t=o[e]||[];0!==t.length&&(a+=`\n                <div class="categoria">\n                    <h2>${r.nombre}</h2>\n                    <div class="servicios">\n                        ${t.map(e=>crearHTMLServicio(e)).join("")}\n                    </div>\n                </div>\n            `)}),e.innerHTML=a||'<p class="sin-servicios">No hay servicios cargados</p>',configurarEventosServicios()}function crearHTMLServicio(e){const o=formatearPrecio(e.precio),a=formatearDuracionAdmin(e.duracion);return`\n            <div class="servicio" data-servicio-id="${e.id}">\n                <h3>${e.nombre}</h3>\n                \n                <div class="mediaq-servicio">\n                    <p class="precio-servicio">\n                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3e843a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                            <path d="M16.7 8a3 3 0 0 0 -2.7 -2h-4a3 3 0 0 0 0 6h4a3 3 0 0 1 0 6h-4a3 3 0 0 1 -2.7 -2" />\n                            <path d="M12 3v3m0 12v3" />\n                        </svg>\n                        <span>${o}</span>\n                    </p>\n\n                    <p class="duracion-servicio">\n                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#667dc4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                            <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />\n                            <path d="M12 12h3.5" />\n                            <path d="M12 7v5" />\n                        </svg>\n                        <span>${a}</span>\n                    </p>\n\n                    <p class="activo-servicio">\n                        <span>Activo:</span>\n                        ${e.activo?'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#35c522" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                                <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />\n                                <path d="M9 12l2 2l4 -4" />\n                            </svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d71919" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                                <path d="M18 6l-12 12" />\n                                <path d="M6 6l12 12" />\n                            </svg>'}\n                    </p>\n                    \n                    <p class="promo-servicio">\n                        <span>Promo:</span>\n                        ${e.promo?'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9328a9ff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">\n                                <path d="M5 7.2a2.2 2.2 0 0 1 2.2 -2.2h1a2.2 2.2 0 0 0 1.55 -.64l.7 -.7a2.2 2.2 0 0 1 3.12 0l.7 .7c.412 .41 .97 .64 1.55 .64h1a2.2 2.2 0 0 1 2.2 2.2v1c0 .58 .23 1.138 .64 1.55l.7 .7a2.2 2.2 0 0 1 0 3.12l-.7 .7a2.2 2.2 0 0 0 -.64 1.55v1a2.2 2.2 0 0 1 -2.2 2.2h-1a2.2 2.2 0 0 0 -1.55 .64l-.7 .7a2.2 2.2 0 0 1 -3.12 0l-.7 -.7a2.2 2.2 0 0 0 -1.55 -.64h-1a2.2 2.2 0 0 1 -2.2 -2.2v-1a2.2 2.2 0 0 0 -.64 -1.55l-.7 -.7a2.2 2.2 0 0 1 0 -3.12l.7 -.7a2.2 2.2 0 0 0 .64 -1.55v-1" />\n                                <path d="M9 12l2 2l4 -4" />\n                            </svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d71919" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                                <path d="M18 6l-12 12" />\n                                <path d="M6 6l12 12" />\n                            </svg>'}\n                    </p>\n                </div>\n\n                <div class="acciones-servicio">\n                    <button class="btn-editar-servicio" data-servicio-id="${e.id}">\n                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#020202" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">\n                            <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />\n                            <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />\n                            <path d="M16 5l3 3" />\n                        </svg>\n                    </button>\n\n                    <button class="btn-eliminar-servicio" data-servicio-id="${e.id}">\n                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#020202" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">\n                            <path d="M4 7l16 0" />\n                            <path d="M10 11l0 6" />\n                            <path d="M14 11l0 6" />\n                            <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />\n                            <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />\n                        </svg>\n                    </button>\n                </div>\n            </div>\n        `}function configurarEventosServicios(){document.querySelectorAll(".btn-editar-servicio").forEach(e=>{e.addEventListener("click",e=>{abrirModalServicio(e.currentTarget.getAttribute("data-servicio-id"))})}),document.querySelectorAll(".btn-eliminar-servicio").forEach(e=>{e.addEventListener("click",async e=>{const o=e.currentTarget.getAttribute("data-servicio-id");await eliminarServicio(o)})})}function configurarModalServicio(){const e=document.getElementById("modal-servicio"),o=document.getElementById("form-servicio"),a=e.querySelector(".close-modal");e&&o&&(a.addEventListener("click",()=>{e.style.display="none"}),window.addEventListener("click",o=>{o.target===e&&(e.style.display="none")}),o.addEventListener("submit",async e=>{e.preventDefault(),await guardarServicio()}),cargarCategoriasEnSelect())}async function cargarCategoriasEnSelect(){const e=document.getElementById("servicio-categoria");if(e){if(Object.keys(c).length>0)return console.log("‚úÖ Usando categor√≠as ya cargadas:",Object.keys(c).length),void llenarSelectConCategorias(e);try{console.log("üì• Cargando categor√≠as desde Firestore...");const o=await db.collection("categorias").orderBy("orden").get();c={},o.forEach(e=>{c[e.id]={id:e.id,...e.data()}}),console.log(`‚úÖ Categor√≠as cargadas: ${o.size}`),llenarSelectConCategorias(e)}catch(o){console.error("‚ùå Error cargando categor√≠as:",o),e.innerHTML='<option value="">Error al cargar categor√≠as</option>'}}else console.error("‚ùå No se encontr√≥ el select de categor√≠as")}function llenarSelectConCategorias(e){e.innerHTML='<option value="">Selecciona una categor√≠a</option>',Object.values(c).sort((e,o)=>(e.orden||0)-(o.orden||0)).forEach(o=>{const a=document.createElement("option");a.value=o.id,a.textContent=o.nombre,e.appendChild(a)}),console.log(`‚úÖ Select de categor√≠as llenado con ${Object.keys(c).length} opciones`)}async function abrirModalServicio(e=null){const o=document.getElementById("modal-servicio"),a=document.getElementById("modal-servicio-titulo"),r=document.getElementById("form-servicio");if(o&&a&&r){if(r.reset(),await cargarCategoriasEnSelect(),e){a.textContent="Editar Servicio",document.getElementById("servicio-id").value=e;const o=s[e];o&&(document.getElementById("servicio-nombre").value=o.nombre||"",document.getElementById("servicio-categoria").value=o.categoriaId||"",document.getElementById("servicio-descripcion").value=o.descripcion||"",document.getElementById("servicio-duracion").value=o.duracion||30,document.getElementById("servicio-precio").value=o.precio||"",document.getElementById("servicio-activo").checked=!1!==o.activo,document.getElementById("servicio-promo").checked=!0===o.promo,console.log(`‚úÖ Campos establecidos para edici√≥n - Promo: ${o.promo}`))}else a.textContent="Crear Servicio",document.getElementById("servicio-id").value="",document.getElementById("servicio-activo").checked=!0,document.getElementById("servicio-promo").checked=!1;o.style.display="block"}}async function guardarServicio(){const e=mostrarLoading();try{const e=document.getElementById("servicio-id").value,o={nombre:document.getElementById("servicio-nombre").value.trim(),categoriaId:document.getElementById("servicio-categoria").value,descripcion:document.getElementById("servicio-descripcion").value.trim(),duracion:parseInt(document.getElementById("servicio-duracion").value),precio:parseInt(document.getElementById("servicio-precio").value),activo:document.getElementById("servicio-activo").checked,promo:document.getElementById("servicio-promo").checked,actualizadoEl:firebase.firestore.FieldValue.serverTimestamp()};if(!o.nombre)throw new Error("El nombre es obligatorio");if(!o.categoriaId)throw new Error("La categor√≠a es obligatoria");if(isNaN(o.duracion)||o.duracion<1)throw new Error("La duraci√≥n debe ser un n√∫mero mayor a 0");if(isNaN(o.precio)||o.precio<0)throw new Error("El precio debe ser un n√∫mero no negativo");if(e)console.log(`üîÑ Actualizando servicio: ${e}`,o),await db.collection("servicios").doc(e).update(o),mostrarMensajeExito("Servicio actualizado correctamente");else{const e=generarIdServicio(o.nombre);if(!await verificarIdUnico("servicios",e))throw new Error(`Ya existe un servicio con un nombre similar. El ID "${e}" ya est√° en uso.`);o.creadoEl=firebase.firestore.FieldValue.serverTimestamp(),o.orden=Object.keys(s).length+1,o.id=e,console.log("üÜï Creando nuevo servicio con ID:",e,o),await db.collection("servicios").doc(e).set(o),mostrarMensajeExito("Servicio creado correctamente")}await cargarServiciosYMostrar(),document.getElementById("modal-servicio").style.display="none"}catch(e){console.error("‚ùå Error guardando servicio:",e),mostrarMensajeError(e.message||"Error al guardar el servicio")}finally{e.remove()}}async function eliminarServicio(e){if(!e)return;const o=s[e];if(!o)return;if(!confirm(`¬øEst√°s seguro de eliminar el servicio "${o.nombre}"? Esta acci√≥n no se puede deshacer.`))return;const a=mostrarLoading();try{await db.collection("servicios").doc(e).delete(),mostrarMensajeExito("Servicio eliminado correctamente"),await cargarServiciosYMostrar()}catch(e){console.error("‚ùå Error eliminando servicio:",e),mostrarMensajeError("Error al eliminar el servicio")}finally{a.remove()}}function formatearPrecio(e){return new Intl.NumberFormat("es-AR",{minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function formatearDuracionAdmin(e){const o=Math.floor(e/60),a=e%60;return 0===o?`${e} min`:0===a?`${o} ${1===o?"hora":"horas"}`:`${o} h ${a} m`}let l={};function inicializarGestionPersonal(){console.log("üîÑ Inicializando gesti√≥n de personal...");const e=document.getElementById("btn-agregar-personal");e&&e.addEventListener("click",()=>{abrirModalPersonal()}),cargarPersonalYMostrar(),configurarModalPersonal()}async function cargarPersonalYMostrar(){try{console.log("üì• Cargando personal...");const e=await db.collection("especialistas").where("activo","==",!0).orderBy("orden").get();l={},e.forEach(e=>{l[e.id]={id:e.id,...e.data()}}),console.log(`‚úÖ Cargados ${e.size} especialistas`),console.log("üìã IDs de personal:",Object.keys(l)),mostrarPersonalEnUI()}catch(e){console.error("‚ùå Error cargando personal:",e),mostrarMensajeError("Error al cargar el personal")}}function mostrarPersonalEnUI(){const e=document.getElementById("personal-list");if(!e)return;if(0===Object.keys(l).length)return void(e.innerHTML='<p class="sin-personal">No hay personal cargado</p>');let o="";Object.values(l).forEach(e=>{o+=crearHTMLPersonal(e)}),e.innerHTML=o,configurarEventosPersonal()}function crearHTMLPersonal(e){const o=obtenerDiasLaborales(e.horarioLaboral);return`\n            <div class="personal" data-personal-id="${e.id}">\n                <div class="personal-identidad">\n                    <img src="${e.fotoUrl||""}" alt="Imagen del Empleado" onerror="this.style.display='none'">\n                    <h3>${e.nombre}</h3>\n                </div>\n\n                <div class="contenedor-datos-personal">\n                    <div class="contenedor-centro-datos">\n                        <div class="personal-datos">\n                            <p>\n                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#020202" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                                    <path d="M5 4h4l2 5l-2.5 1.5a11 11 0 0 0 5 5l1.5 -2.5l5 2v4a2 2 0 0 1 -2 2a16 16 0 0 1 -15 -15a2 2 0 0 1 2 -2" />\n                                </svg>\n                                <span>${e.telefono||"No especificado"}</span>\n                            </p>\n\n                            <p>\n                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#020202" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                                    <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z" />\n                                    <path d="M3 7l9 6l9 -6" />\n                                </svg>\n                                <span>${e.email||"No especificado"}</span>\n                            </p>\n                        </div>\n\n                        <div class="personal-disponibilidad">\n                            <p>\n                                <span>Activo:</span>\n                                ${e.activo?'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#020202" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                                        <path d="M5 12l5 5l10 -10" />\n                                    </svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#020202" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                                        <path d="M18 6l-12 12" />\n                                        <path d="M6 6l12 12" />\n                                    </svg>'}\n                            </p>\n\n                            <p>\n                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#020202" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                                    <path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z" />\n                                    <path d="M16 3v4" />\n                                    <path d="M8 3v4" />\n                                    <path d="M4 11h16" />\n                                    <path d="M7 14h.013" />\n                                    <path d="M10.01 14h.005" />\n                                    <path d="M13.01 14h.005" />\n                                    <path d="M16.015 14h.005" />\n                                    <path d="M13.015 17h.005" />\n                                    <path d="M7.01 17h.005" />\n                                    <path d="M10.01 17h.005" />\n                                </svg>\n                                <span>${o}</span>\n                            </p>\n                        </div>\n                    </div>\n\n                    <div class="acciones-personal">\n                        <button class="btn-editar-personal" data-personal-id="${e.id}">\n                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#020202" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">\n                                <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />\n                                <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />\n                                <path d="M16 5l3 3" />\n                            </svg>\n                        </button>\n    \n                        <button class="btn-eliminar-personal" data-personal-id="${e.id}">\n                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#020202" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">\n                                <path d="M4 7l16 0" />\n                                <path d="M10 11l0 6" />\n                                <path d="M14 11l0 6" />\n                                <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />\n                                <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />\n                            </svg>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `}function obtenerDiasLaborales(e){if(!e)return"No definido";const o={lunes:"L",martes:"M",miercoles:"M",jueves:"J",viernes:"V",sabado:"S",domingo:"D"},a=[];for(const[r,t]of Object.entries(e))t&&t.activo&&a.push(o[r]||r.charAt(0).toUpperCase());return a.join(" - ")||"No definido"}function configurarEventosPersonal(){document.querySelectorAll(".btn-editar-personal").forEach(e=>{e.addEventListener("click",e=>{abrirModalPersonal(e.currentTarget.getAttribute("data-personal-id"))})}),document.querySelectorAll(".btn-eliminar-personal").forEach(e=>{e.addEventListener("click",async e=>{const o=e.currentTarget.getAttribute("data-personal-id");await eliminarPersonal(o)})})}function configurarModalPersonal(){const e=document.getElementById("modal-personal"),o=document.getElementById("form-personal"),a=e.querySelector(".close-modal");e&&o&&(a.addEventListener("click",()=>{e.style.display="none"}),window.addEventListener("click",o=>{o.target===e&&(e.style.display="none")}),o.addEventListener("submit",async e=>{e.preventDefault(),await guardarPersonal()}),cargarCategoriasCheckboxesPersonal(),configurarUploaderImagen())}async function cargarCategoriasCheckboxesPersonal(){const e=document.getElementById("personal-categorias-checkboxes");if(e)if(e.innerHTML="",Object.keys(c).length>0)llenarCheckboxesConCategorias(e);else try{const o=await db.collection("categorias").orderBy("orden").get();c={},o.forEach(e=>{c[e.id]={id:e.id,...e.data()}}),llenarCheckboxesConCategorias(e)}catch(o){console.error("‚ùå Error cargando categor√≠as para personal:",o),e.innerHTML="<p>Error al cargar categor√≠as</p>"}else console.error("‚ùå No se encontr√≥ el contenedor de checkboxes de categor√≠as")}function llenarCheckboxesConCategorias(e){const o=Object.values(c).sort((e,o)=>(e.orden||0)-(o.orden||0));if(0===o.length)return void(e.innerHTML="<p>No hay categor√≠as disponibles</p>");let a='<div class="categorias-checkboxes-grid">';o.forEach(e=>{a+=`\n                <div class="checkbox-categoria-item">\n                    <label class="checkbox-categoria-label">\n                        <input type="checkbox" \n                              name="personal-categorias" \n                              value="${e.id}" \n                              class="checkbox-categoria">\n                        <span class="checkbox-custom"></span>\n                        <span class="checkbox-text">${e.nombre}</span>\n                    </label>\n                </div>\n            `}),a+="</div>",e.innerHTML=a,console.log(`‚úÖ Checkboxes de categor√≠as creados: ${o.length} opciones`)}async function abrirModalPersonal(e=null){const o=document.getElementById("modal-personal"),a=document.getElementById("modal-personal-titulo"),r=document.getElementById("form-personal"),t=document.getElementById("personal-foto-preview"),n=document.getElementById("personal-foto-preview-img"),i=document.querySelector(".file-upload-label");if(o&&a&&r){if(resetearFormularioPersonal(),await cargarCategoriasCheckboxesPersonal(),e){a.textContent="Editar Personal",document.getElementById("personal-id").value=e;const o=l[e];o&&(document.getElementById("personal-nombre").value=o.nombre||"",document.getElementById("personal-telefono").value=o.telefono||"",document.getElementById("personal-email").value=o.email||"",document.getElementById("personal-duracion").value=o.duracionTurnoBase||30,document.getElementById("personal-activo").checked=!1!==o.activo,o.fotoUrl&&(n.src=o.fotoUrl,t.style.display="block",i.style.display="none",document.getElementById("personal-foto-url").value=o.fotoUrl),o.categoriasId&&establecerCategoriasSeleccionadas(o.categoriasId),o.horarioLaboral&&establecerHorarioLaboral(o.horarioLaboral))}else{a.textContent="Crear Personal",document.getElementById("personal-id").value="",document.getElementById("personal-activo").checked=!0,document.getElementById("personal-duracion").value=30;document.querySelectorAll(".checkbox-categoria").forEach(e=>{e.checked=!1});establecerHorarioLaboral({lunes:{inicio:"09:00",fin:"20:00",activo:!0},martes:{inicio:"09:00",fin:"20:00",activo:!0},miercoles:{inicio:"09:00",fin:"20:00",activo:!0},jueves:{inicio:"09:00",fin:"20:00",activo:!0},viernes:{inicio:"09:00",fin:"20:00",activo:!0},sabado:{inicio:"09:00",fin:"20:00",activo:!1},domingo:{inicio:"09:00",fin:"20:00",activo:!1}})}o.style.display="block"}}function establecerHorarioLaboral(e){["lunes","martes","miercoles","jueves","viernes","sabado","domingo"].forEach(o=>{const a=e[o],r=document.getElementById(`personal-${o}-activo`),t=document.getElementById(`personal-${o}-inicio`),n=document.getElementById(`personal-${o}-fin`);r&&t&&n&&(a&&a.activo?(r.checked=!0,t.value=a.inicio||"09:00",n.value=a.fin||"18:00"):(r.checked=!1,t.value="09:00",n.value="18:00"))})}async function guardarPersonal(){const e=mostrarLoading();try{const e=document.getElementById("personal-id").value,o=document.getElementById("personal-foto-file").files[0],a=document.getElementById("personal-foto-url").value,r={nombre:document.getElementById("personal-nombre").value.trim(),telefono:document.getElementById("personal-telefono").value.trim(),email:document.getElementById("personal-email").value.trim(),duracionTurnoBase:parseInt(document.getElementById("personal-duracion").value),activo:document.getElementById("personal-activo").checked,categoriasId:obtenerCategoriasSeleccionadas(),horarioLaboral:obtenerHorarioLaboralFromForm(),actualizadoEl:firebase.firestore.FieldValue.serverTimestamp()};if(!r.nombre)throw new Error("El nombre es obligatorio");if(r.duracionTurnoBase<1)throw new Error("La duraci√≥n del turno debe ser mayor a 0");let t=e;if(e)r.fotoUrl=o?await subirImagenPersonal(o,e):a||"",await db.collection("especialistas").doc(e).update(r),mostrarMensajeExito("Personal actualizado correctamente");else{t=generarIdPersonal(r.nombre);if(!await verificarIdUnico("especialistas",t))throw new Error(`Ya existe un especialista con un nombre similar. El ID "${t}" ya est√° en uso.`);r.fotoUrl=o?await subirImagenPersonal(o,t):"",r.creadoEl=firebase.firestore.FieldValue.serverTimestamp(),r.orden=Object.keys(l).length+1,r.id=t,await db.collection("especialistas").doc(t).set(r),mostrarMensajeExito("Personal creado correctamente")}await cargarPersonalYMostrar(),document.getElementById("modal-personal").style.display="none",resetearFormularioPersonal()}catch(e){console.error("‚ùå Error guardando personal:",e),mostrarMensajeError(e.message||"Error al guardar el personal")}finally{e.remove()}}function resetearFormularioPersonal(){const e=document.getElementById("form-personal"),o=document.getElementById("personal-foto-preview"),a=document.querySelector(".file-upload-label");e.reset(),o.style.display="none",a.style.display="flex",document.getElementById("personal-foto-url").value=""}function obtenerCategoriasSeleccionadas(){const e=document.querySelectorAll(".checkbox-categoria:checked");return Array.from(e).map(e=>e.value)}function establecerCategoriasSeleccionadas(e){if(!e||!Array.isArray(e))return;document.querySelectorAll(".checkbox-categoria").forEach(o=>{o.checked=e.includes(o.value)})}function obtenerHorarioLaboralFromForm(){const e={};return["lunes","martes","miercoles","jueves","viernes","sabado","domingo"].forEach(o=>{const a=document.getElementById(`personal-${o}-activo`),r=document.getElementById(`personal-${o}-inicio`),t=document.getElementById(`personal-${o}-fin`);a&&r&&t&&(e[o]={activo:a.checked,inicio:r.value,fin:t.value})}),e}async function eliminarPersonal(e){if(!e)return;const o=l[e];if(!o)return;if(!confirm(`¬øEst√°s seguro de eliminar a "${o.nombre}"? Esta acci√≥n no se puede deshacer.`))return;const a=mostrarLoading();try{await db.collection("especialistas").doc(e).update({activo:!1,actualizadoEl:firebase.firestore.FieldValue.serverTimestamp()}),mostrarMensajeExito("Personal eliminado correctamente"),await cargarPersonalYMostrar()}catch(e){console.error("‚ùå Error eliminando personal:",e),mostrarMensajeError("Error al eliminar el personal")}finally{a.remove()}}function normalizarParaId(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}function generarIdServicio(e){return`serv_${normalizarParaId(e)}`}function generarIdPersonal(e){return`esp_${normalizarParaId(e)}`}async function verificarIdUnico(e,o){try{return!(await db.collection(e).doc(o).get()).exists}catch(e){return console.error(`Error verificando ID ${o}:`,e),!1}}const d=firebase.storage();async function subirImagenPersonal(e,o){try{console.log("üì§ Iniciando subida de imagen...",e.name);const a=e.name.split(".").pop().toLowerCase(),r=`especialistas/${o}_${Date.now()}.${a}`,t=d.ref().child(r),n=await t.put(e),i=await n.ref.getDownloadURL();return console.log("‚úÖ Imagen subida correctamente:",i),i}catch(e){throw console.error("‚ùå Error subiendo imagen:",e),new Error("Error al subir la imagen: "+e.message)}}function configurarUploaderImagen(){const e=document.getElementById("personal-foto-file"),o=document.getElementById("personal-foto-preview"),a=document.getElementById("personal-foto-preview-img"),r=document.getElementById("btn-remove-image"),t=document.querySelector(".file-upload-container"),n=t.querySelector(".file-upload-label");e&&(e.addEventListener("change",function(e){const r=e.target.files[0];if(r){if(!r.type.startsWith("image/"))return void mostrarMensajeError("Por favor selecciona un archivo de imagen v√°lido");if(r.size>2097152)return void mostrarMensajeError("La imagen es demasiado grande. M√°ximo 2MB permitido.");const e=new FileReader;e.onload=function(e){a.src=e.target.result,o.style.display="block",n.style.display="none"},e.readAsDataURL(r)}}),r.addEventListener("click",function(a){a.preventDefault(),a.stopPropagation(),e.value="",o.style.display="none",n.style.display="flex",document.getElementById("personal-foto-url").value=""}),t.addEventListener("dragover",function(e){e.preventDefault(),t.classList.add("dragover")}),t.addEventListener("dragleave",function(e){e.preventDefault(),t.classList.remove("dragover")}),t.addEventListener("drop",function(o){o.preventDefault(),t.classList.remove("dragover");const a=o.dataTransfer.files;a.length>0&&(e.files=a,e.dispatchEvent(new Event("change")))}))}document.addEventListener("DOMContentLoaded",initAdmin)}else{console.log("üö´ admin.js: No estamos en admin.html - modo silencioso activado");const u={initAdmin:function(){},inicializarGestionServicios:function(){},inicializarGestionPersonal:function(){},inicializarNavegacionAdmin:function(){},inicializarNavegacionCuandoPanelListo:function(){},handleAuthState:function(){},signInWithGoogle:function(){},signOut:function(){},showAdminPanel:function(){},showLoginScreen:function(){}};Object.keys(u).forEach(e=>{window[e]=u[e]})}window.enviarEmailConfirmacion=async e=>{try{const o={senderName:window.brevoConfig.senderName,senderEmail:window.brevoConfig.senderEmail,to:[{email:e.email,name:e.nombre}],subject:`Confirmaci√≥n de turno - ${e.fecha} a las ${e.horario}`,htmlContent:`\n          <!DOCTYPE html>\n          <html>\n          <head>\n              <style>\n                  body { font-family: 'Poppins', sans-serif; line-height: 1.6; color: #333; }\n                  .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n                  .header { background-color: #f8f1e9; padding: 20px; text-align: center; }\n                  .content { padding: 20px; }\n                  .footer { text-align: center; font-size: 12px; color: #777; margin-top: 20px; }\n                  .resumen { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }\n                  .servicio { margin-bottom: 5px; }\n              </style>\n          </head>\n          <body>\n              <div class="container">\n                  <div class="header">\n                      <h2>DemoPro GestionTurno</h2>\n                      <p>¬°Tu turno ha sido confirmado!</p>\n                  </div>\n                  \n                  <div class="content">\n                      <p>Hola <strong>${e.nombre}</strong>,</p>\n                      <p>Tu turno ha sido reservado con √©xito. A continuaci√≥n los detalles:</p>\n                      \n                      <div class="resumen">\n                          <h3>Resumen de tu reserva</h3>\n                          <p><strong>Especialista(s):</strong> ${e.especialistas.join(", ")}</p>\n                          <p><strong>Fecha:</strong> ${e.fecha}</p>\n                          <p><strong>Hora:</strong> ${e.horario}</p>\n                          <p><strong>Servicios:</strong></p>\n                          <ul>\n                              ${e.servicios.map(e=>`<li class="servicio">${e}</li>`).join("")}\n                          </ul>\n                          <p><strong>Se√±a abonada:</strong> $${e.reserva.toLocaleString()}</p>\n                          <p><strong>A abonar en local:</strong> $${e.montoTotal.toLocaleString()}</p>\n                      </div>\n                      \n                      <p>Si necesitas modificar o cancelar tu turno, por favor cont√°ctanos a: contacto@gestionturno.com</p>\n                  </div>\n                  \n                  <div class="footer">\n                      <p>¬© ${(new Date).getFullYear()} DemoPro GestionTurno. Todos los derechos reservados.</p>\n                  </div>\n              </div>\n          </body>\n          </html>\n        `};window.brevoConfig.adminEmail&&(o.bcc=[{email:window.brevoConfig.adminEmail,name:"Administrador DemoPro Gesti√≥nTurno"}]);const a=firebase.functions().httpsCallable("enviarEmailConfirmacion");return(await a(o)).data.success}catch(e){return console.error("Error en enviarEmailConfirmacion:",e),!1}};let pasoActual=1;const totalPasos=5;let datosReserva={servicios:[],especialistas:[],especialistaNombre:null,categorias:[],precios:{Corte:15e3,"Te√±ido":4e4,Alisado:3e4},duraciones:{Corte:30,"Te√±ido":30,Alisado:30},reserva:1e3,fecha:null,horario:null,nombre:null,email:null,telefono:null,observacion:null},datosGenerales={},mejorEspecialistaPorCategoria={},fechaSeleccionada=null,calendarioFechaActual=new Date,fechasDisponiblesCalendario=[],coordenadasLocal=null;const elementos={progreso:document.getElementById("progreso"),btnAnterior:document.querySelector(".btn-anterior"),btnSiguiente:document.querySelector(".btn-siguiente"),pasos:document.querySelectorAll(".paso"),resumenNombre:document.getElementById("cliente-nombre"),resumenEmail:document.getElementById("cliente-email"),resumenTelefono:document.getElementById("cliente-telefono"),resumenServicio:document.getElementById("servicio-seleccionado"),resumenFecha:document.getElementById("fecha-seleccionado"),resumenHorario:document.getElementById("horario-seleccionado"),resumenObservacion:document.getElementById("observacion-texto"),resumenEspecialistas:document.getElementById("especialistas-nombres"),contenedorEspecialistas:document.querySelector(".contenedor-especialistas")},db=window.db||firebase.firestore(),auth=window.firebaseAuth||{onAuthStateChanged:()=>console.warn("Auth no inicializado")};async function probarConexion(){try{await firestoreSeguro.obtenerConfiguracion();const e=(new Date).toISOString().split("T")[0];await firestoreDB.obtenerTurnosPorFecha(e),await firestoreSeguro.generarHorariosDisponibles(e)}catch(e){console.error("Error en prueba de conexi√≥n:",e)}}window.firestoreDB||console.error("Firestore no est√° disponible"),document.addEventListener("DOMContentLoaded",async()=>{await cargarConfiguracion(),cargarDatosGenerales(),inicializarAuth();const e=localStorage.getItem("usuario");if(e){JSON.parse(e)}if(inicializarAcordeonMenu(),inicializarCierreMenuOverlay(),document.querySelector(".contenedor-pasos")){inicializarEventos(),actualizarInterfaz(),inicializarAuth();const[e,o]=await Promise.all([firestoreSeguro.obtenerCategorias(),firestoreSeguro.obtenerServicios()]),a=Validador.filtrarInvalidos(e,"categoria"),r=Validador.filtrarInvalidos(o,"servicio");a.length>0?datosReserva.categorias=a:ErrorHandler.mostrar("No se pudieron cargar las categor√≠as v√°lidas","warning"),r.length>0?datosReserva.serviciosDisponibles=r:ErrorHandler.mostrar("No se pudieron cargar los servicios v√°lidos","warning"),actualizarUIServicios(a,r)}datosGenerales=await firestoreSeguro.obtenerConfigGeneral();const o=new MutationObserver(function(e){e.forEach(function(e){if("attributes"===e.type&&"class"===e.attributeName){const e=document.querySelector(".paso-3");e&&e.classList.contains("activo")&&!fechaSeleccionada&&cargarFechasYHorarios()}})}),a=document.querySelector(".paso-3");a&&o.observe(a,{attributes:!0}),await precacheDatosEsenciales(),"function"==typeof inicializarSistemaTurnosUsuario&&inicializarSistemaTurnosUsuario()});const firestoreSeguro={obtenerCategorias:async()=>{try{if(cache.esValido("categorias"))return console.log("‚úÖ Obteniendo categor√≠as desde cach√©"),cache.obtener("categorias");const e=await firestoreDB.obtenerCategorias();return cache.guardar("categorias",e),e}catch(e){return ErrorHandler.manejarErrorFirestore(e,"cargar categor√≠as")}},obtenerServicios:async()=>{try{if(cache.esValido("servicios"))return console.log("‚úÖ Obteniendo servicios desde cach√©"),cache.obtener("servicios");const e=await firestoreDB.obtenerServicios();return cache.guardar("servicios",e),e}catch(e){return ErrorHandler.manejarErrorFirestore(e,"cargar servicios")}},obtenerEspecialistasPorCategoria:async e=>{try{if(cache.esValido("especialistas",e)){console.log(`‚úÖ Obteniendo especialistas para categor√≠a ${e} desde cach√©`);const o=cache.obtener("especialistas",e);if(o&&Array.isArray(o)&&o.length>0)return o;console.log(`üîÑ Cach√© vac√≠o/inv√°lido para ${e}, recargando...`),cache.limpiarEspecifico("especialistas",e)}const o=await firestoreDB.obtenerEspecialistasPorCategoria(e);return o&&Array.isArray(o)&&o.length>0?cache.guardar("especialistas",o,e):console.warn(`‚ö†Ô∏è No se guardar√° cach√© vac√≠o para categor√≠a ${e}`),o||[]}catch(o){return console.error(`‚ùå Error obteniendo especialistas para categor√≠a ${e}:`,o),[]}},obtenerConfiguracion:async()=>{try{if(cache.esValido("config"))return console.log("‚úÖ Obteniendo configuraci√≥n desde cach√©"),cache.obtener("config");const e=await firestoreDB.obtenerConfiguracion();return cache.guardar("config",e),e}catch(e){return ErrorHandler.manejarErrorFirestore(e,"cargar configuraci√≥n"),{diasLaborales:[1,2,3,4,5,6],horarioApertura:"09:00",horarioCierre:"20:00",duracionTurnoBase:30}}},verificarDisponibilidad:async(e,o)=>{try{return await firestoreDB.verificarDisponibilidad(e,o)}catch(e){return ErrorHandler.manejarErrorFirestore(e,"verificar disponibilidad"),!1}},generarHorariosDisponibles:async e=>{try{return await firestoreDB.generarHorariosDisponibles(e)}catch(e){return ErrorHandler.manejarErrorFirestore(e,"generar horarios"),[]}},generarHorariosDisponiblesEspecialista:async(e,o)=>{try{const a=`${e}_${o}`,r=cache.obtener("horarios",a);if(r)return cacheMonitor.incrementHit(),r;cacheMonitor.incrementMiss();const t=await firestoreDB.generarHorariosDisponiblesEspecialista(e,o);return cache.guardar("horarios",t,a),t}catch(e){return ErrorHandler.manejarErrorFirestore(e,"generar horarios de especialista")}},generarHorariosMultiplesEspecialistas:async(e,o)=>{try{const a=`multi_${e.sort().join("_")}_${o}`,r=cache.obtener("horarios_multi",a);if(r)return r;const t=e.map(e=>this.generarHorariosDisponiblesEspecialista(e,o)),n=await Promise.allSettled(t),i={};return n.forEach((o,a)=>{"fulfilled"===o.status&&(i[e[a]]=o.value)}),cache.guardar("horarios_multi",i,a),i}catch(e){return console.error("Error generando horarios m√∫ltiples:",e),{}}},obtenerHorariosComunesDisponibles:async(e,o,a)=>{try{return await firestoreDB.obtenerHorariosComunesDisponibles(e,o,a)}catch(e){return ErrorHandler.manejarErrorFirestore(e,"obtener horarios comunes"),[]}},obtenerTurnosPorFecha:async e=>{try{return await firestoreDB.obtenerTurnosPorFecha(e)}catch(e){return ErrorHandler.manejarErrorFirestore(e,"obtener turnos por fecha"),[]}},obtenerTurnosSolapados:async(e,o,a)=>{try{return await firestoreDB.obtenerTurnosSolapados(e,o,a)}catch(e){return ErrorHandler.manejarErrorFirestore(e,"obtener turnos solapados"),[]}},obtenerConfigGeneral:async()=>{try{return await firestoreDB.obtenerConfigGeneral()}catch(e){return ErrorHandler.manejarErrorFirestore(e,"cargar configuraci√≥n general"),{}}},autenticarParaReserva:async()=>{try{if(!usuarioActual){console.log("üîê Iniciando autenticaci√≥n an√≥nima para reserva...");const e=await firebase.auth().signInAnonymously();usuarioActual=e.user,console.log("‚úÖ Usuario an√≥nimo autenticado:",usuarioActual.uid)}return usuarioActual}catch(e){throw console.error("Error en autenticaci√≥n para reserva:",e),e}},guardarTurno:async e=>{try{return await firestoreSeguro.autenticarParaReserva(),await firestoreDB.guardarTurno(e)}catch(e){throw ErrorHandler.manejarErrorFirestore(e,"guardar turno"),e}},bloquearTurnoTemporal:async(e,o,a)=>{try{return await firestoreDB.bloquearTurnoTemporal(e,o,a)}catch(e){return ErrorHandler.manejarErrorFirestore(e,"bloquear turno temporal"),null}},eliminarBloqueoTemporal:async e=>{try{return await firestoreDB.eliminarBloqueoTemporal(e)}catch(e){ErrorHandler.manejarErrorFirestore(e,"eliminar bloqueo temporal")}}};async function inicializarEventos(){elementos.btnAnterior.addEventListener("click",retrocederPaso),elementos.btnSiguiente.addEventListener("click",avanzarPaso),document.querySelectorAll(".flotante.servicio").forEach(e=>{e.addEventListener("click",function(){this.classList.toggle("seleccionado"),actualizarServiciosSeleccionados()})}),document.querySelectorAll(".flotante.fecha").forEach(e=>{e.addEventListener("click",function(){seleccionarElemento(this,"fecha")})}),document.querySelectorAll(".flotante.horario").forEach(e=>{e.addEventListener("click",async function(){if(!this.classList.contains("ocupado")){const e=this.querySelector(".p1").textContent,o=datosReserva.especialistas.map(e=>e.id),a=await validarDisponibilidadCompleta(datosReserva.fecha,e,calcularDuracionTotal(),o);a.disponible&&0===a.turnosSolapados.length?seleccionarElemento(this,"horario"):mostrarError(a.mensaje||"Horario no disponible")}})}),document.getElementById("nombre")?.addEventListener("input",validarNombre),document.getElementById("email")?.addEventListener("input",validarEmail),document.getElementById("telefono")?.addEventListener("input",validarTelefono),document.addEventListener("click",async function(e){if(e.target.closest(".flotante.especialista")){const o=e.target.closest(".flotante.especialista"),a=o.dataset.id,r=o.dataset.categoriaId,t=o.closest(".categoria-especialistas");if(t){const e=t.querySelector(".especialistas-container").querySelector(`[data-id="${a}"]`);if(e){const t={id:a,nombre:e.querySelector(".p1")?.textContent||"Especialista",categoriaId:r};seleccionarEspecialista(o,t,r)}}setTimeout(()=>{pasoActual>=2&&actualizarResumenEspecialistas()},100)}if(e.target.closest(".seleccion-predeterminada")&&!e.target.closest(".botones-especialista")){const o=e.target.closest(".seleccion-predeterminada").closest(".categoria-especialistas"),a=o.querySelector(".especialistas-lista"),r=o.querySelector(".btn-ver-especialistas").querySelector(".acordeon-icon"),t=a.classList.contains("abierto");document.querySelectorAll(".especialistas-lista.abierto").forEach(e=>{if(e!==a){e.classList.remove("abierto");const o=e.closest(".categoria-especialistas").querySelector(".btn-ver-especialistas").querySelector(".acordeon-icon");o&&o.classList.remove("girado")}}),a.classList.toggle("abierto",!t),r&&r.classList.toggle("girado",!t)}})}function calcularSubtotal(){const e=datosReserva.servicios.reduce((e,o)=>e+o.precio,0),o=datosReserva.servicios.reduce((e,o)=>o.promo?e+(o.precioOriginal-o.precio):e,0);if(o>0){console.log(`üí∞ Ahorro total por promociones: $${o.toLocaleString()}`);const e=document.getElementById("ahorro-total");e&&(e.textContent=`-$${o.toLocaleString()}`,e.style.display="block")}return e}function actualizarServiciosSeleccionados(){try{console.log("üîÑ actualizarServiciosSeleccionados llamado");const e=document.querySelectorAll(".flotante.servicio.seleccionado");if(datosReserva.servicios&&Array.isArray(datosReserva.servicios)||(datosReserva.servicios=[]),console.log("Servicios seleccionados en DOM:",e.length),!e||0===e.length){console.log("No hay servicios seleccionados, limpiando datos"),datosReserva.servicios=[];const e=document.querySelector(".contenedor-especialistas");return e&&(e.innerHTML='<p class="sin-especialistas">Selecciona servicios primero</p>'),actualizarContadoresCategoria(),void calcularSubtotal()}const o=Array.from(e).map(e=>{try{const o=e.getAttribute("data-servicio-id"),a=e.getAttribute("data-servicio"),r=e.getAttribute("data-categoria-id");if(!o||!r)return console.warn("Servicio sin ID o categor√≠a ID:",e),null;const t=datosReserva.serviciosDisponibles?.find(e=>e&&e.id===o),n=t?t.precio:datosReserva.precios[a]||0,i=!!t&&t.promo,s=i?Math.round(.75*n):n;return{id:o,nombre:a||(t?t.nombre:"Servicio"),precio:s,precioOriginal:n,promo:i,duracion:t?t.duracion:datosReserva.duraciones[a]||30,categoriaId:r}}catch(e){return console.error("Error procesando servicio:",e),null}}).filter(e=>null!==e);if(datosReserva.servicios=o,console.log("Servicios procesados:",datosReserva.servicios),Array.isArray(datosReserva.servicios)||(console.error("datosReserva.servicios no es un array, forzando a array vac√≠o"),datosReserva.servicios=[]),datosReserva.reserva=calcularSenia(),actualizarContadoresCategoria(),datosReserva.servicios.length>0&&document.getElementById("error-servicio").classList.remove("visible"),console.log("¬øDebe mostrar especialistas?",datosReserva.servicios.length>0),datosReserva.servicios.length>0){const e=[...new Set(datosReserva.servicios.map(e=>e.categoriaId))];console.log("Categor√≠as con servicios:",e),mostrarEspecialistas(e)}else{console.log("Limpiando especialistas porque no hay servicios");const e=document.querySelector(".contenedor-especialistas");e&&(e.innerHTML='<p class="sin-especialistas">Selecciona servicios primero</p>')}calcularSubtotal(),pasoActual>=2&&actualizarResumenServicios()}catch(e){console.error("Error en actualizarServiciosSeleccionados:",e)}}async function cargarEspecialistas(){try{const e=[...new Set(datosReserva.servicios.map(e=>e.categoriaId))];if(0===e.length)return void console.warn("No hay categor√≠as para cargar especialistas");const o=e.map(e=>firestoreSeguro.obtenerEspecialistasPorCategoria(e)),a=await Promise.allSettled(o),r={};a.forEach((o,a)=>{"fulfilled"===o.status?r[e[a]]=o.value:(console.error(`Error cargando especialistas para categor√≠a ${e[a]}:`,o.reason),r[e[a]]=[])}),mostrarEspecialistas(e,r)}catch(e){console.error("Error cargando especialistas:",e),mostrarError("Error al cargar los especialistas. Intenta nuevamente.")}}function seleccionarEspecialista(e,o,a){if(e.classList.contains("seleccionado"))e.classList.remove("seleccionado"),datosReserva.especialistas=datosReserva.especialistas.filter(e=>!(e.id===o.id&&e.categoriaId===a));else{const r=datosReserva.especialistas.findIndex(e=>e.categoriaId===a);if(-1!==r){const e=document.querySelector(`.flotante.especialista[data-id="${datosReserva.especialistas[r].id}"]`);e&&e.classList.remove("seleccionado"),datosReserva.especialistas.splice(r,1)}e.classList.add("seleccionado"),datosReserva.especialistas.push({...o,categoriaId:a})}console.log("Especialistas seleccionados:",datosReserva.especialistas)}async function cargarFechasYHorarios(){try{await cargarFechasDisponibles(),datosReserva.fecha&&await cargarHorariosDisponibles(datosReserva.fecha)}catch(e){console.error("Error cargando fechas y horarios:",e),mostrarError("Error al cargar disponibilidad. Intenta nuevamente.")}}async function cargarFechasDisponibles(){const e=document.querySelector(".contenedor-fechas");if(e){e.innerHTML="<p>Cargando fechas disponibles...</p>";try{const o=await firestoreSeguro.obtenerConfiguracion(),a=o?.diasLaborales||[1,2,3,4,5,6],r=new Date,t=[];for(let e=0;e<28;e++){const o=new Date(r);o.setDate(r.getDate()+e),a.includes(o.getDay())&&t.push(o.toISOString().split("T")[0])}e.innerHTML="",t.forEach(o=>{const a=new Date(o),r=document.createElement("div");r.className="flotante fecha",r.dataset.fecha=o;const t=a.toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"});r.innerHTML=`\n                <p class="p1">${t.charAt(0).toUpperCase()+t.slice(1)}</p>\n            `,r.addEventListener("click",function(){seleccionarElemento(this,"fecha"),cargarHorariosDisponibles(o)}),e.appendChild(r)})}catch(o){console.error("Error cargando fechas:",o),e.innerHTML="<p>Error al cargar fechas</p>"}}}async function cargarHorariosDisponibles(e){const o=document.querySelector(".contenedor-horarios");if(o){o.innerHTML="<p>Cargando horarios...</p>";try{const a=calcularDuracionTotal(),r=datosReserva.especialistas.map(e=>e.id);let t=[];if(t=r.length>0?await firestoreSeguro.obtenerHorariosComunesDisponibles(e,r,a):await firestoreSeguro.generarHorariosDisponibles(e),o.innerHTML="",0===t.length)return void(o.innerHTML="<p>No hay horarios disponibles para esta fecha</p>");t.forEach(t=>{const n=document.createElement("div");n.className="flotante horario disponible",n.innerHTML=`\n                <p class="p1">${t}</p>\n            `,n.addEventListener("click",async function(){if(!this.classList.contains("ocupado")){const o=await validarDisponibilidadCompleta(e,t,a,r);o.disponible&&0===o.turnosSolapados.length?seleccionarElemento(this,"horario"):mostrarError(o.mensaje||"Horario no disponible")}}),o.appendChild(n)})}catch(e){console.error("Error cargando horarios:",e),o.innerHTML="<p>Error al cargar horarios</p>"}}}async function validarDisponibilidadCompleta(e,o,a,r){try{if(!await firestoreSeguro.verificarDisponibilidad(e,o))return{disponible:!1,mensaje:"Este horario ya no est√° disponible"};const t=await firestoreSeguro.obtenerTurnosSolapados(e,o,a);if(t.length>0)return{disponible:!1,turnosSolapados:t,mensaje:`El horario seleccionado se cruza con ${t.length} turno(s) existente(s)`};if(r.length>0)for(const a of r){if(!(await firestoreSeguro.generarHorariosDisponiblesEspecialista(a,e)).includes(o))return{disponible:!1,mensaje:"El especialista no est√° disponible en este horario"}}return{disponible:!0,turnosSolapados:[]}}catch(e){return console.error("Error validando disponibilidad:",e),{disponible:!1,mensaje:"Error al verificar disponibilidad"}}}function validarDatosContacto(){const e=document.getElementById("nombre").value.trim(),o=document.getElementById("email").value.trim(),a=document.getElementById("telefono").value.trim();if(e.length<2)return mostrarError("Ingresa tu nombre completo"),!1;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o))return mostrarError("Ingresa un email v√°lido"),!1;return/^\d{8,}$/.test(a.replace(/\D/g,""))?(datosReserva.nombre=e,datosReserva.email=o,datosReserva.telefono=a,datosReserva.observacion=document.getElementById("observacion").value.trim(),!0):(mostrarError("Ingresa un tel√©fono v√°lido (m√≠nimo 8 d√≠gitos)"),!1)}function actualizarResumenServicios(){const e=document.getElementById("servicio-seleccionado");if(e){const o=datosReserva.servicios.map(e=>{const o=e.promo?`<span class="precio-con-descuento">$${e.precio.toLocaleString()}</span>\n                <span class="precio-original">$${e.precioOriginal.toLocaleString()}</span>`:`$${e.precio.toLocaleString()}`,a=e.promo?'<span class="badge-promo-resumen">-25%</span>':"";return`<li>${e.nombre} ${a} - ${o}</li>`}).join("");e.innerHTML=o}}function obtenerNombreCategoria(e){const o=datosReserva.categorias.find(o=>o.id===e);return o?o.nombre:"General"}async function confirmarReserva(){if(validarDatosContacto()){elementos.btnSiguiente.innerHTML='<div class="spinner"></div> Confirmando...',elementos.btnSiguiente.disabled=!0;try{const e=await validarDisponibilidadCompleta(datosReserva.fecha,datosReserva.horario,calcularDuracionTotal(),datosReserva.especialistas.map(e=>e.id));if(!e.disponible)return mostrarError(e.mensaje||"El horario ya no est√° disponible"),elementos.btnSiguiente.innerHTML="Confirmar Reserva",void(elementos.btnSiguiente.disabled=!1);const o={servicios:datosReserva.servicios,especialistas:datosReserva.especialistas,fecha:datosReserva.fecha,horario:datosReserva.horario,duracion:calcularDuracionTotal(),cliente:{nombre:datosReserva.nombre,email:datosReserva.email,telefono:datosReserva.telefono},observaciones:datosReserva.observacion,estado:"pendiente",fechaCreacion:(new Date).toISOString(),senia:datosReserva.reserva,total:calcularSubtotal()};if(!await firestoreSeguro.guardarTurno(o))throw new Error("Error al guardar el turno");mostrarConfirmacion(o),reiniciarFormulario()}catch(e){console.error("Error confirmando reserva:",e),mostrarError("Error al confirmar la reserva. Intenta nuevamente.")}finally{elementos.btnSiguiente.innerHTML="Confirmar Reserva",elementos.btnSiguiente.disabled=!1}}}function reiniciarFormulario(){datosReserva={servicios:[],especialistas:[],fecha:null,horario:null,nombre:null,email:null,telefono:null,observacion:null,reserva:1e3},pasoActual=1,actualizarInterfaz(),document.querySelectorAll(".flotante.seleccionado").forEach(e=>{e.classList.remove("seleccionado")}),document.getElementById("nombre").value="",document.getElementById("email").value="",document.getElementById("telefono").value="",document.getElementById("observacion").value=""}async function cargarDatosUsuario(e){try{const o=await db.collection("usuarios").doc(e).get();if(o.exists){const e=o.data();document.getElementById("nombre")&&e.nombre&&(document.getElementById("nombre").value=e.nombre),document.getElementById("telefono")&&e.telefono&&(document.getElementById("telefono").value=e.telefono)}}catch(e){console.error("Error cargando datos usuario:",e)}}async function logout(){try{await auth.signOut(),localStorage.removeItem("usuario")}catch(e){console.error("Error en logout:",e)}}async function cargarConfiguracion(){try{const e=await firestoreSeguro.obtenerConfigGeneral();datosGenerales=e,e.nombreLocal&&document.querySelectorAll(".nombre-local").forEach(o=>{o.textContent=e.nombreLocal}),e.logoUrl&&document.querySelectorAll(".logo").forEach(o=>{o.src=e.logoUrl,o.alt=e.nombreLocal})}catch(e){console.error("Error cargando configuraci√≥n:",e)}}function contactarPorWhatsApp(){const e=datosGenerales.telefono||"5491112345678",o=`¬°Hola! Me gustar√≠a hacer una reserva en ${datosGenerales.nombreLocal||"su local"}`,a=`https://wa.me/${e}?text=${encodeURIComponent(o)}`;window.open(a,"_blank")}function abrirUbicacion(){if(coordenadasLocal){const{lat:e,lng:o}=coordenadasLocal,a=`https://www.google.com/maps?q=${e},${o}`;window.open(a,"_blank")}else if(datosGenerales.direccion){const e=`https://www.google.com/maps?q=${encodeURIComponent(datosGenerales.direccion)}`;window.open(e,"_blank")}else mostrarError("No hay informaci√≥n de ubicaci√≥n disponible")}function actualizarUIServicios(e,o){if(!e||!o)return void ErrorHandler.mostrar("Datos de categor√≠as o servicios no definidos","error");const a=document.querySelector(".contenedor-servicios");if(!a)return void console.error("No se encontr√≥ el contenedor de servicios");if(console.log("Actualizando UI con:",e.length,"categor√≠as y",o.length,"servicios"),a.innerHTML="",0===e.length)return void(a.innerHTML='<p class="sin-servicios">No cargaron las categor√≠as disponibles.</p>');const r={};e.forEach(e=>{r[e.id]=o.filter(o=>o.categoriaId===e.id)}),e.forEach(e=>{let o=r[e.id]||[];const t=o.some(e=>!0===e.promo);o=o.sort((e,o)=>e.promo&&!o.promo?-1:!e.promo&&o.promo?1:0);const n=document.createElement("div");n.className="categoria-acordeon",n.dataset.categoriaId=e.id;const i=t?'\n      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9328a9ff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">\n        <path d="M5 7.2a2.2 2.2 0 0 1 2.2 -2.2h1a2.2 2.2 0 0 0 1.55 -.64l.7 -.7a2.2 2.2 0 0 1 3.12 0l.7 .7c.412 .41 .97 .64 1.55 .64h1a2.2 2.2 0 0 1 2.2 2.2v1c0 .58 .23 1.138 .64 1.55l.7 .7a2.2 2.2 0 0 1 0 3.12l-.7 .7a2.2 2.2 0 0 0 -.64 1.55v1a2.2 2.2 0 0 1 -2.2 2.2h-1a2.2 2.2 0 0 0 -1.55 .64l-.7 .7a2.2 2.2 0 0 1 -3.12 0l-.7 -.7a2.2 2.2 0 0 0 -1.55 -.64h-1a2.2 2.2 0 0 1 -2.2 -2.2v-1a2.2 2.2 0 0 0 -.64 -1.55l-.7 -.7a2.2 2.2 0 0 1 0 -3.12l.7 -.7a2.2 2.2 0 0 0 .64 -1.55v-1" />\n        <path d="M9 12l2 2l4 -4" />\n      </svg>\n    ':"",s=document.createElement("div");s.className="categoria-header",t&&s.classList.add("con-promociones"),s.dataset.categoriaId=e.id,s.innerHTML=`\n      <div class="categoria-info">\n        <h3>${e.nombre} ${i}</h3>\n        <span class="contador-seleccionados-categoria"></span>\n      </div>\n        <svg\n        class="acordeon-icon" \n        width="18"\n        height="18"\n        viewBox="0 0 24 24"\n        fill="none"\n        stroke="#000000"\n        stroke-width="2"\n        stroke-linecap="round"\n        stroke-linejoin="round"\n        >\n        <path d="M18 6l-12 12" />\n        <path d="M6 6l12 12" />\n        </svg>\n    `;const c=document.createElement("div");c.className="servicios-container",c.style.display="none",o.length>0?o.forEach(e=>{const o=document.createElement("div");o.className="flotante servicio",e.promo&&o.classList.add("descuento"),o.dataset.servicioId=e.id,o.dataset.categoriaId=e.categoriaId,o.dataset.servicio=e.nombre;const a=e.promo?Math.round(.75*e.precio):e.precio;o.innerHTML=`\n            <p class="p1">${e.nombre}</p>\n            <p class="detalles-servicio">\n                <span class="${e.promo?"precio-con-descuento":""}">\n                    ${a.toLocaleString()}\n                    ${e.promo?`<span class="precio-original">${e.precio.toLocaleString()}</span>`:""}\n                    <svg\n                    xmlns="http://www.w3.org/2000/svg"\n                    width="18"\n                    height="18"\n                    viewBox="0 0 24 24"\n                    fill="none"\n                    stroke="#000000"\n                    stroke-width="1"\n                    stroke-linecap="round"\n                    stroke-linejoin="round"\n                    >\n                    <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />\n                    <path d="M14.8 9a2 2 0 0 0 -1.8 -1h-2a2 2 0 1 0 0 4h2a2 2 0 1 1 0 4h-2a2 2 0 0 1 -1.8 -1" />\n                    <path d="M12 7v10" />\n                    </svg>\n                </span>\n                <span>${e.duracion} min\n                    <svg\n                    xmlns="http://www.w3.org/2000/svg"\n                    width="18"\n                    height="18"\n                    viewBox="0 0 24 24"\n                    fill="none"\n                    stroke="#000000"\n                    stroke-width="1"\n                    stroke-linecap="round"\n                    stroke-linejoin="round"\n                    >\n                    <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />\n                    <path d="M12 12l3 -2" />\n                    <path d="M12 7v5" />\n                    </svg>\n                </span>\n            </p>\n            ${e.promo?'<div class="badge-promo">-25%</div>':""}\n            <svg class="check-icon" viewBox="0 0 24 24">\n                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>\n            </svg>\n        `,o.addEventListener("click",function(e){e.stopPropagation(),this.classList.toggle("seleccionado"),actualizarServiciosSeleccionados()}),c.appendChild(o)}):(c.innerHTML='<p class="sin-servicios-categoria">No hay servicios disponibles en esta categor√≠a</p>',c.classList.add("sin-servicios")),s.addEventListener("click",function(){if(0===o.length)return;const e=c.classList.contains("activo");document.querySelectorAll(".categoria-acordeon .servicios-container.activo").forEach(e=>{e!==c&&(e.classList.remove("activo"),e.closest(".categoria-acordeon").querySelector(".categoria-header").classList.remove("activo"))}),c.classList.toggle("activo",!e),this.classList.toggle("activo",!e)}),0===o.length&&(s.classList.add("sin-servicios"),s.style.cursor="default",s.querySelector(".acordeon-icon").style.display="none"),n.appendChild(s),n.appendChild(c),a.appendChild(n)})}function actualizarContadoresCategoria(){document.querySelectorAll(".contador-seleccionados-categoria").forEach(e=>{e.textContent="",e.classList.remove("mostrar")});const e={};datosReserva.servicios.forEach(o=>{o.categoriaId&&(e[o.categoriaId]||(e[o.categoriaId]=0),e[o.categoriaId]++)}),Object.keys(e).forEach(o=>{const a=document.querySelector(`.categoria-header[data-categoria-id="${o}"] .contador-seleccionados-categoria`);a&&e[o]>0&&(a.textContent=e[o],setTimeout(()=>{a.classList.add("mostrar")},10))})}function debugServicios(){console.log("=== DEBUG SERVICIOS ==="),console.log("Servicios disponibles:",datosReserva.serviciosDisponibles),console.log("Servicios seleccionados:",datosReserva.servicios);document.querySelectorAll(".flotante.servicio").forEach(e=>{console.log("Elemento DOM:",{id:e.getAttribute("data-servicio-id"),nombre:e.getAttribute("data-servicio"),categoria:e.getAttribute("data-categoria-id"),texto:e.textContent})})}function calcularDuracionTotal(){return datosReserva.servicios.reduce((e,o)=>e+o.duracion,0)}async function avanzarPaso(){if(!(pasoActual>=5))try{if(toggleLoader(!0),2===pasoActual){if(datosReserva.especialistas.some(e=>"auto"===e.id)){if(!await buscarEspecialistasAutomaticos())return void toggleLoader(!1)}}if(!await validarPaso(pasoActual))return void toggleLoader(!1);if(pasoActual++,actualizarInterfaz(),actualizarResumenContinuo(pasoActual),setTimeout(()=>{scrollAlInicio()},100),4===pasoActual&&usuarioActual&&autocompletarFormulario(usuarioActual),5===pasoActual)try{guardarDatosFormulario(),actualizarResumen(),cargarDatosGenerales()}catch(e){console.error("Error actualizando resumen:",e),mostrarError("Error al generar el resumen. Por favor, recarga la p√°gina."),pasoActual--,actualizarInterfaz()}}catch(e){console.error("Error al avanzar paso:",e),mostrarError("Ocurri√≥ un error al procesar la solicitud")}finally{toggleLoader(!1)}}function retrocederPaso(){if(pasoActual>1){switch(pasoActual){case 2:datosReserva.especialistas=[],document.querySelectorAll(".flotante.especialista.seleccionado").forEach(e=>{e.classList.remove("seleccionado")}),document.querySelectorAll(".seleccion-predeterminada.seleccionado").forEach(e=>{e.classList.remove("seleccionado");const o=e.querySelector(".info-especialista");o&&(o.innerHTML='<span class="texto-predeterminado">Selecciona un especialista</span>')});break;case 3:limpiarSeleccion("horario"),datosReserva.horario=null}if(pasoActual--,actualizarInterfaz(),actualizarResumenContinuo(pasoActual),setTimeout(()=>{scrollAlInicio()},100),2===pasoActual){mostrarEspecialistas([...new Set(datosReserva.servicios.map(e=>e.categoriaId))])}}}function limpiarSeleccion(e){document.querySelectorAll(`.flotante.${e}.seleccionado`).forEach(e=>{e.classList.remove("seleccionado")});const o=document.getElementById(`error-${e}`);o&&o.classList.remove("visible")}function actualizarInterfaz(){actualizarPasos(),actualizarBotones(),actualizarResumenContinuo(pasoActual)}function scrollAlInicio(){const e=document.querySelector(".contenedor-maqueta");e&&e.scrollTo({top:0,behavior:"smooth"})}async function simularReserva(){if(5===pasoActual){const e=document.getElementById("reserva-loader"),o=document.querySelector(".btn-siguiente"),a=document.getElementById("error-reserva"),r=calcularDuracionTotal();a&&(a.style.display="none"),o.classList.add("hidden"),setTimeout(()=>{e.style.display="inline-block"},200);try{const t=await validarDisponibilidadCompleta(datosReserva.fecha,datosReserva.horario,r);if(!t.disponible)return requestAnimationFrame(()=>{e.style.display="none",o.style.display="flex"}),console.error("Validaci√≥n fallida:",t),void(a&&(a.textContent=t.mensaje||"El horario ya no est√° disponible",a.style.display="block"));console.log("Especialistas en datosReserva:",datosReserva.especialistas);const n={};datosReserva.especialistas.forEach(e=>{n[e.categoriaId]=e.id});datosReserva.servicios.map(e=>e.id);const i={cliente:{nombre:datosReserva.nombre,email:datosReserva.email,telefono:datosReserva.telefono},serviciosIds:datosReserva.servicios.map(e=>e.id),fecha:datosReserva.fecha,horarioInicio:datosReserva.horario,duracionTotal:r,montoTotal:calcularSubtotal(),"se√±aAbonada":datosReserva.reserva,observaciones:datosReserva.observacion||"",userId:usuarioActual?usuarioActual.uid:null,estado:"pendiente",especialistasPorCategoria:n,especialistaIds:datosReserva.especialistas.map(e=>e.id)};console.log("Datos del turno a guardar:",i),console.log("Usuario actual:",usuarioActual);if(await firestoreSeguro.guardarTurno(i))try{await window.enviarEmailConfirmacion({nombre:datosReserva.nombre,email:datosReserva.email,fecha:datosReserva.fecha,horario:datosReserva.horario,servicios:datosReserva.servicios.map(e=>e.nombre),especialistas:datosReserva.especialistas.map(e=>e.nombre),reserva:datosReserva.reserva,montoTotal:calcularSubtotal()})}catch(e){console.error("Error al enviar email:",e)}e.style.display="none",mostrarConfirmacion(!0)}catch(r){console.error("Error al reservar:",r),requestAnimationFrame(()=>{e.style.display="none",o.style.display="flex"}),a&&(a.textContent="Ocurri√≥ un error al procesar la reserva. Por favor, intenta nuevamente.",a.style.display="block")}}}async function completarReserva(){let e=null;try{const o=usuarioActual?usuarioActual.uid:"sesion_"+Date.now();e=await firestoreSeguro.bloquearTurnoTemporal(datosReserva.fecha,datosReserva.horario,o);const a=await firestoreSeguro.obtenerConfiguracion(),[r,t]=await Promise.all([firestoreSeguro.verificarDisponibilidad(datosReserva.fecha,datosReserva.horario),firestoreSeguro.obtenerTurnosSolapados(datosReserva.fecha,datosReserva.horario,a.duracionTurno)]);if(!r||t.length>0)return await firestoreSeguro.eliminarBloqueoTemporal(e),void mostrarError(t.length>0?`El horario se solapa con un turno existente (${t[0].servicios.join(", ")})`:"El horario ya fue reservado");const n={};await firestoreDB.guardarTurno(n),await firestoreDB.eliminarBloqueoTemporal(e),mostrarConfirmacion(!0)}catch(o){console.error("Error en reserva:",o),e&&await firestoreDB.eliminarBloqueoTemporal(e).catch(e=>console.error("Error limpiando bloqueo:",e)),mostrarConfirmacion(!1)}}async function inicializarDisponibilidad(){try{const e=await firestoreSeguro.obtenerConfiguracion();actualizarUIFechas(generarFechasDisponibles(e))}catch(e){console.error("Error inicializando disponibilidad:",e),mostrarError("No se pudieron cargar las fechas disponibles")}}async function validarDisponibilidadCompleta(e,o,a){try{if(!o)return{disponible:!1,turnosSolapados:[],slotsOcupados:[],mensaje:"Horario no seleccionado"};await firestoreSeguro.obtenerConfiguracion();const r=datosReserva.especialistas.map(e=>e.id),[t,n]=o.split(":"),i=parseInt(t),s=60*i+parseInt(n),c=s+a,l=(await firestoreDB.obtenerTurnosPorEspecialistasYFecha(r,e)).filter(e=>{const[o,a]=e.horarioInicio.split(":").map(Number),r=60*o+a,t=r+(e.duracionTotal||30);return!(c<=r||s>=t)}),d=[];for(let o=s;o<c;o+=30){const a=Math.floor(o/60),t=o%60,n=`${a.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`;await firestoreDB.verificarDisponibilidadParaEspecialistas(e,n,r)||d.push(n)}const u=0===l.length&&0===d.length;let p="";if(!u){const e=Math.floor(a/60);p=`Tu turno necesita ${e>0?e+" hora"+(e>1?"s":"")+" y ":""}${a%60} minutos continuos.`}return{disponible:u,turnosSolapados:l,slotsOcupados:d,mensaje:p}}catch(e){return console.error("Error en validaci√≥n:",e),{disponible:!1,turnosSolapados:[],slotsOcupados:[],mensaje:"Error al verificar disponibilidad. Por favor, intenta nuevamente."}}}async function cargarFechasDisponibles(){if(datosReserva.especialistas.length)try{actualizarUIFechas(await obtenerFechasComunesDisponibles())}catch(e){console.error("Error cargando fechas:",e),mostrarError("No se pudieron cargar las fechas disponibles")}}async function obtenerFechasComunesDisponibles(){const e=generarFechasDisponibles(await firestoreSeguro.obtenerConfiguracion()),o=[];for(const a of e){await verificarDisponibilidadEspecialistas(a)&&o.push(a)}return o}function generarFechasDisponibles(e){const o=new Date((new Date).toLocaleString("en-US",{timeZone:"America/Argentina/Buenos_Aires"})),a=new Date(o.getFullYear(),o.getMonth(),o.getDate()),[r,t]=e.horarioCierre.split(":").map(Number),n=o.getHours()>r||o.getHours()===r&&o.getMinutes()>=t,i=[],s=n?1:0;for(let o=s;o<7+s;o++){const r=new Date(a);if(r.setDate(a.getDate()+o),!esDiaLaboral(r,e))continue;const t=r.toISOString().split("T")[0];Array.isArray(e.diasNoLaborables)&&e.diasNoLaborables.includes(t)||(0===o&&n||i.push({fecha:t,display:formatearFechaDisplay(r)}))}return i}function esDiaLaboral(e,o){const a=e.getDay();let r=[];try{Array.isArray(o.diasLaborales)?r=o.diasLaborales.map(Number).filter(e=>!isNaN(e)):"string"==typeof o.diasLaborales&&(r=o.diasLaborales.split(",").map(Number).filter(e=>!isNaN(e)))}catch(e){console.error("Error procesando d√≠as laborales:",e),r=[1,2,3,4,5]}return 0===r.length&&(r=[1,2,3,4,5]),r.includes(a)}function obtenerFechaSeleccionada(){if(!datosReserva.fecha)return(new Date).toISOString().split("T")[0];const e=datosReserva.fecha.split(" "),[o,a]=e[1].split("/");return`${(new Date).getFullYear()}-${a.padStart(2,"0")}-${o.padStart(2,"0")}`}async function actualizarUIFechas(e){console.log("Actualizando UI con fechas:",e),fechasDisponiblesCalendario=e||[];const o=document.querySelector(".cargando-fechas"),a=document.querySelector(".contenedor-calendario"),r=document.querySelector(".sin-fechas");if(o&&(o.style.display="none"),!e||0===e.length)return console.log("No hay fechas disponibles"),r&&(r.style.display="block",r.textContent="No hay fechas disponibles en este momento"),void(a&&(a.style.display="none"));a&&(a.style.display="block"),r&&(r.style.display="none");const t=await obtenerPrimeraFechaDisponibleEspecialistas();if(t){const e=new Date(t+"T03:00:00");calendarioFechaActual=new Date(e.getFullYear(),e.getMonth(),1)}else calendarioFechaActual=new Date;renderizarCalendario(),debugVisualizacionFechas(),t?seleccionarFechaAutomaticamente(t):e.length>0&&seleccionarFechaAutomaticamente(e[0].fecha)}async function obtenerPrimeraFechaDisponibleEspecialistas(){try{if(!datosReserva.especialistas||0===datosReserva.especialistas.length)return null;const e=await firestoreSeguro.obtenerConfiguracion(),o=new Date,a=new Date(o.toLocaleString("en-US",{timeZone:"America/Argentina/Buenos_Aires"}));for(let o=0;o<60;o++){const r=new Date(a);r.setDate(a.getDate()+o);const t=r.toISOString().split("T")[0];if(!esDiaLaboral(r,e))continue;if(Array.isArray(e.diasNoLaborables)&&e.diasNoLaborables.includes(t))continue;if(await verificarDisponibilidadEspecialistas(t))return console.log(`‚úÖ Primera fecha disponible encontrada: ${t}`),t}return console.log("‚ùå No se encontr√≥ fecha disponible en los pr√≥ximos 60 d√≠as"),null}catch(e){return console.error("Error obteniendo primera fecha disponible:",e),null}}async function cargarHorariosParaFecha(e){try{const o=document.querySelector(".cargando-horarios"),a=document.querySelector(".contenedor-horarios"),r=document.querySelector(".sin-horarios");o&&(o.style.display="block"),a&&(a.innerHTML=""),r&&(r.style.display="none");const t=datosReserva.especialistas.map(e=>e.id),n=calcularDuracionTotal();console.log(`Buscando horarios para ${e} con duraci√≥n: ${n} minutos`);const i=await firestoreDB.obtenerHorariosComunesDisponibles(e,t,n);console.log(`Horarios disponibles encontrados: ${i.length}`);const s=(new Date).toISOString().split("T")[0];let c=i;e===s&&(c=filtrarHorariosPorHoraActual(i,n),console.log(`Horarios despu√©s de filtrar por hora actual: ${c.length}`)),o&&(o.style.display="none"),actualizarUIHorarios(c)}catch(e){console.error("Error cargando horarios:",e),mostrarError("No se pudieron cargar los horarios disponibles");const o=document.querySelector(".cargando-horarios");o&&(o.style.display="none")}}function filtrarHorariosPorHoraActual(e,o){const a=new Date,r=a.getHours(),t=a.getMinutes(),n=60*r+t;console.log(`Filtrando horarios para hoy - Hora actual: ${r}:${t}`),console.log(`Se requieren horarios despu√©s de: ${n+30} minutos (${Math.floor((n+30)/60)}:${(n+30)%60})`);const i=e.filter(e=>{const[o,a]=e.split(":");return 60*parseInt(o)+parseInt(a)>=n+30});return console.log(`Horarios despu√©s de filtrar: ${i.length}`),i}function encontrarHorariosComunes(e){const o=Object.keys(e);if(0===o.length)return[];let a=e[o[0]];for(let r=1;r<o.length;r++){const t=e[o[r]];a=a.filter(e=>t.includes(e))}return a}async function generarHorariosDisponibles(e){const[o,a]=await Promise.all([this.obtenerConfiguracion(),this.obtenerTurnosPorFecha(e)]),r=a.map(e=>e.horario);return this._generarHorarios(o,r,e)}function actualizarUIHorarios(e){const o=document.querySelector(".contenedor-horarios"),a=document.querySelector(".sin-horarios");o&&(o.innerHTML="",e&&0!==e.length?(a&&(a.style.display="none"),e.forEach(e=>{const a=document.createElement("div");a.className="flotante horario",a.dataset.horario=e,a.innerHTML=`\n            <p class="p1">${e}</p>\n            <svg class="check-icon" viewBox="0 0 24 24">\n                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>\n            </svg>\n        `,a.addEventListener("click",function(){seleccionarHorario(this,e)}),o.appendChild(a)})):a&&(a.style.display="block",a.textContent="No hay horarios disponibles para esta fecha"))}async function verificarDisponibilidadEnTiempoReal(e,o){try{return!!await firestoreSeguro.verificarDisponibilidad(e,o)||(mostrarError("Este horario ya no est√° disponible. Por favor selecciona otro."),document.querySelectorAll(".flotante.horario").forEach(e=>{e.textContent.trim()===o&&(e.classList.add("ocupado"),e.removeEventListener("click",manejarClickHorario))}),!1)}catch(e){return console.error("Error verificando disponibilidad:",e),!1}}function crearContenedorHorarios(e){const o=document.createElement("div");return o.className="contenedor-horarios",e.appendChild(o),o}function actualizarPasos(){elementos.pasos.forEach((e,o)=>{e.classList.toggle("activo",o+1===pasoActual)})}function actualizarBotones(){const e=document.getElementById("reserva-loader");e&&(e.style.display="none"),1===pasoActual?elementos.btnAnterior.classList.remove("activo"):elementos.btnAnterior.classList.add("activo"),elementos.btnSiguiente.replaceWith(elementos.btnSiguiente.cloneNode(!0)),elementos.btnSiguiente=document.querySelector(".btn-siguiente"),5===pasoActual?(elementos.btnSiguiente.classList.add("btn-reserva"),elementos.btnSiguiente.innerHTML='\n            <span class="circulo" aria-hidden="true">\n                <span class="icono-flecha flecha"></span>\n            </span>\n            <span class="texto-reserva">Reservar</span>\n        ',elementos.btnSiguiente.addEventListener("click",async()=>{await simularReserva()})):(elementos.btnSiguiente.classList.remove("btn-reserva"),elementos.btnSiguiente.innerHTML='\n            <svg class="flecha" viewBox="0 0 24 24" width="24" height="24">\n                <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" fill="ffffff"/>\n            </svg>\n        ',elementos.btnSiguiente.addEventListener("click",avanzarPaso))}function seleccionarElemento(e,o){if(e.classList.contains("seleccionado")&&"servicio"===o)return e.classList.remove("seleccionado"),void actualizarServiciosSeleccionados();"servicio"===o?(e.classList.add("seleccionado"),actualizarServiciosSeleccionados()):(document.querySelectorAll(`.flotante.${o}`).forEach(e=>{e.classList.remove("seleccionado")}),e.classList.add("seleccionado"),datosReserva[o]=e.querySelector(".p1").textContent,"fecha"===o?document.getElementById("error-fecha").classList.remove("visible"):"horario"===o&&document.getElementById("error-horario").classList.remove("visible"))}async function validarPaso(e){const o=document.querySelector(`.paso-${e}`);if(!o)return console.error(`Elemento del paso ${e} no encontrado`),!1;const a=o.querySelectorAll(".error-mensaje");switch(a&&a.forEach(e=>e.classList.remove("visible")),e){case 1:const e=o.querySelector("#error-servicio");return 0!==datosReserva.servicios.length||(e&&(e.classList.add("visible"),e.style.animation="shake 0.5s",setTimeout(()=>e.style.animation="",500)),!1);case 2:const a=document.getElementById("error-especialista"),r=[...new Set(datosReserva.servicios.map(e=>e.categoriaId))],t=[...new Set(datosReserva.especialistas.map(e=>e.categoriaId))];return!!r.every(e=>t.includes(e))||(a&&(a.textContent="¬°Selecciona un especialista para cada categor√≠a de servicios!",a.classList.add("visible")),!1);case 3:const n=document.getElementById("error-fecha"),i=document.getElementById("error-horario");if(console.log("Validando paso 3 - fecha:",datosReserva.fecha,"horario:",datosReserva.horario),!datosReserva.fecha)return n&&n.classList.add("visible"),!1;if(!datosReserva.horario)return i&&i.classList.add("visible"),!1;toggleLoader(!0);try{const e=calcularDuracionTotal(),o=await validarDisponibilidadCompleta(datosReserva.fecha,datosReserva.horario,e);return!(!o.disponible||o.turnosSolapados.length>0)||(mostrarError(o.mensaje||"El horario ya no est√° disponible para la duraci√≥n requerida"),!1)}finally{toggleLoader(!1)}case 4:if(!validarFormulario()){const e=document.createElement("div");return e.className="error-general visible",e.innerHTML='\n                    <svg viewBox="0 0 24 24" width="20" height="20">\n                        <path fill="#ff6b6b" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>\n                    </svg>\n                    <span>Completa todos los campos correctamente para continuar</span>\n                ',!1}const s=document.querySelector(".error-general");return s&&s.remove(),!0;case 5:return validarFormulario();default:return!0}}function validarFormulario(){let e=!0;document.querySelectorAll(".error-mensaje").forEach(e=>{e.classList.remove("visible")});const o=validarNombre(),a=validarEmail(),r=validarTelefono();return document.getElementById("nombre").value.trim()||(document.getElementById("error-nombre").textContent="El nombre es obligatorio",document.getElementById("error-nombre").classList.add("visible"),document.getElementById("nombre").classList.add("invalido"),e=!1),document.getElementById("email").value.trim()||(document.getElementById("error-email").textContent="El email es obligatorio",document.getElementById("error-email").classList.add("visible"),document.getElementById("email").classList.add("invalido"),e=!1),document.getElementById("telefono").value||(document.getElementById("error-telefono").textContent="El tel√©fono es obligatorio",document.getElementById("error-telefono").classList.add("visible"),document.getElementById("telefono").classList.add("invalido"),e=!1),!o&&document.getElementById("nombre").value.trim()&&(e=!1),!a&&document.getElementById("email").value.trim()&&(e=!1),!r&&document.getElementById("telefono").value&&(e=!1),e}function guardarDatosFormulario(){datosReserva.nombre=document.getElementById("nombre").value.trim(),datosReserva.email=document.getElementById("email").value.trim(),datosReserva.telefono=document.getElementById("telefono").value.trim(),datosReserva.observacion=document.getElementById("observacion").value.trim()||"Sin observaciones"}function actualizarResumen(){guardarDatosFormulario(),elementos.resumenNombre.textContent=datosReserva.nombre||"[No ingresado]",elementos.resumenEmail.textContent=datosReserva.email||"[No ingresado]",elementos.resumenTelefono.textContent=datosReserva.telefono||"[No ingresado]"}function calcularSenia(){const e=calcularDuracionTotal();return 1e3*Math.ceil(e/30)}function validarNombre(){const e=document.getElementById("nombre"),o=document.getElementById("error-nombre"),a=e.value.trim(),r=a.split(" ").filter(e=>e.length>1).length>=1&&a.length>=5;return r?(e.classList.remove("invalido"),o.classList.remove("visible")):(e.classList.add("invalido"),a.length>0&&(o.textContent="Debe tener al menos 5 caracteres",o.classList.add("visible"))),r}function validarTelefono(){const e=document.getElementById("telefono"),o=document.getElementById("error-telefono"),a=e.value.replace(/\D/g,""),r=10===a.length;return e.value=a,r?(e.classList.remove("invalido"),o.classList.remove("visible")):(e.classList.add("invalido"),a.length>0&&(o.textContent="El tel√©fono debe tener 10 n√∫meros",o.classList.add("visible"))),r}function validarEmail(){const e=document.getElementById("email"),o=document.getElementById("error-email"),a=e.value.trim(),r=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a);return r?(e.classList.remove("invalido"),o.classList.remove("visible")):(e.classList.add("invalido"),a.length>0&&(o.textContent="Ingresa un email v√°lido",o.classList.add("visible"))),r}function mostrarConfirmacion(){document.querySelectorAll(".paso").forEach(e=>{e.classList.remove("activo")});const e=document.querySelector(".resumen-continuo");e&&(e.style.display="none");const o=document.querySelector(".paso-6");o.classList.add("activo");if(document.querySelector(".paso-6 .exito").innerHTML=`\n        \n    <div class="check-icon">\n        <span class="icon-line line-tip"></span>\n        <span class="icon-line line-long"></span>\n        <div class="icon-circle"></div>\n        <div class="icon-fix"></div>\n    </div>\n    \n        <h2>¬°Turno reservado!</h2>\n        <p>Buen√≠simo <span>${datosReserva.nombre||"cliente"}</span>, recibir√°s un email de confirmaci√≥n con los datos de tu reserva.</p>\n        <p class="nos-vemos">¬°Nos vemos en el local!</p>\n    `,document.querySelector(".paso-6 .exito").classList.add("visible"),elementos.btnAnterior.style.display="none",elementos.btnSiguiente.style.display="none",!document.getElementById("nueva-reserva")){const e='\n            <button id="nueva-reserva" class="btn-reserva">\n                \n        <svg\n        xmlns="http://www.w3.org/2000/svg"\n        width="20"\n        height="20"\n        viewBox="0 0 24 24"\n        fill="none"\n        stroke="#000000"\n        stroke-width="1.5"\n        stroke-linecap="round"\n        stroke-linejoin="round"\n        >\n        <path d="M15 4.55a8 8 0 0 0 -6 14.9m0 -4.45v5h-5" />\n        <path d="M18.37 7.16l0 .01" />\n        <path d="M13 19.94l0 .01" />\n        <path d="M16.84 18.37l0 .01" />\n        <path d="M19.37 15.1l0 .01" />\n        <path d="M19.94 11l0 .01" />\n        </svg>\n    \n                Volver\n            </button>\n        ';o.insertAdjacentHTML("beforeend",e),document.getElementById("nueva-reserva").addEventListener("click",()=>{location.reload()})}}function demoPaso6(){datosReserva={...datosReserva,servicios:[{nombre:"Corte de pelo",precio:15e3,duracion:30},{nombre:"Te√±ido",precio:4e4,duracion:60}],fecha:"2025-01-20",horario:"10:00",nombre:"Cliente Demo",email:"demo@email.com",telefono:"1234567890",reserva:1e3,especialistas:[{id:"esp_1",nombre:"Especialista Demo",categoriaId:"cat_1"}]},document.querySelectorAll(".paso").forEach(e=>{e.classList.remove("activo")});document.querySelector(".paso-6").classList.add("activo"),mostrarConfirmacion(),elementos.btnAnterior.style.display="none",elementos.btnSiguiente.style.display="none"}function seleccionarEspecialista(e,o,a){if(!o||!a)return void console.error("Par√°metros inv√°lidos en seleccionarEspecialista:",{elemento:e,especialista:o,categoriaId:a});const r=document.querySelector(`.categoria-especialistas[data-categoria-id="${a}"]`);if(!r)return;const t=r.querySelector(".seleccion-predeterminada"),n=r.querySelector(".especialistas-lista"),i=t.querySelector(".info-especialista"),s=datosReserva.especialistas.findIndex(e=>e.categoriaId===a);-1!==s&&datosReserva.especialistas.splice(s,1);let c="img/avatar-default.png";if(o.fotoUrl)c=o.fotoUrl;else if(e){const o=e.querySelector(".avatar-especialista");o&&(c=o.src)}datosReserva.especialistas.push({id:o.id,nombre:o.nombre,categoriaId:a,fotoUrl:c});const l=document.getElementById("error-especialista");if(l&&l.classList.remove("visible"),n.querySelectorAll(".flotante.especialista").forEach(e=>{e.classList.remove("seleccionado")}),e&&e.classList.add("seleccionado"),t.classList.add("seleccionado"),"auto"===o.id)i.innerHTML='\n            <span class="texto-predeterminado">Con quien tenga disponibilidad</span>\n        ';else{const e=Array.from(n.querySelectorAll(".flotante.especialista")).find(e=>e.dataset.id===o.id);let a="img/avatar-default.png";if(e){const o=e.querySelector(".avatar-especialista");o&&(a=o.src)}i.innerHTML=`\n            <img src="${a}" alt="${o.nombre}" class="avatar-especialista">\n            <div>\n                <span class="nombre-especialista">${o.nombre}</span>\n            </div>\n        `}const d=t.querySelector(".btn-ver-especialistas");d&&!d.hasEventListener&&(d.addEventListener("click",e=>{e.stopPropagation();const o=r.querySelector(".especialistas-lista"),a=d.querySelector(".acordeon-icon"),t=o.classList.contains("abierto");document.querySelectorAll(".especialistas-lista.abierto").forEach(e=>{if(e!==o){e.classList.remove("abierto");const o=e.closest(".categoria-especialistas").querySelector(".acordeon-icon");o&&o.classList.remove("girado")}}),o.classList.toggle("abierto",!t),a&&a.classList.toggle("girado",!t)}),d.hasEventListener=!0),pasoActual>=2&&actualizarResumenEspecialistas(),limpiarFechasYHorarios(),console.log("Especialistas seleccionados:",datosReserva.especialistas)}async function mostrarEspecialistas(e){try{console.log("üîß mostrarEspecialistas llamado con:",e),console.log("üìä Estado de datosReserva:",{servicios:datosReserva.servicios,serviciosLength:datosReserva.servicios?datosReserva.servicios.length:"null",categorias:datosReserva.categorias?datosReserva.categorias.length:"null"});const o=document.querySelector(".contenedor-especialistas");if(!o)return void console.error("‚ùå No se encontr√≥ el contenedor de especialistas");if(!e||!Array.isArray(e))return console.warn("‚ùå categoriasIds no es un array v√°lido:",e),void(o.innerHTML='<p class="sin-especialistas">Error al cargar especialistas</p>');if(!datosReserva.categorias||!Array.isArray(datosReserva.categorias)){console.warn("‚ùå No hay categor√≠as cargadas en datosReserva"),o.innerHTML='<p class="sin-especialistas">Cargando categor√≠as...</p>';try{datosReserva.categorias=await firestoreSeguro.obtenerCategorias(),console.log("‚úÖ Categor√≠as cargadas:",datosReserva.categorias.length)}catch(e){return console.error("‚ùå Error cargando categor√≠as:",e),void(o.innerHTML='<p class="sin-especialistas">Error al cargar categor√≠as</p>')}}if(o.innerHTML="",datosReserva.especialistas=[],datosReserva.servicios||(console.warn("‚ùå datosReserva.servicios es null/undefined, inicializando a array vac√≠o"),datosReserva.servicios=[]),Array.isArray(datosReserva.servicios)||(console.warn("‚ùå datosReserva.servicios no es un array:",datosReserva.servicios),datosReserva.servicios=[]),0===datosReserva.servicios.length)return console.warn("‚ùå datosReserva.servicios est√° vac√≠o"),void(o.innerHTML='<p class="sin-especialistas">Selecciona servicios primero</p>');console.log("‚úÖ datosReserva.servicios es v√°lido:",datosReserva.servicios.length,"servicios");const a={};if(console.log("üîç Procesando servicios..."),datosReserva.servicios.forEach((e,o)=>{console.log(`üîç Procesando servicio ${o}:`,e),e?e.categoriaId&&e.nombre?(a[e.categoriaId]||(a[e.categoriaId]=[]),a[e.categoriaId].includes(e.nombre)||a[e.categoriaId].push(e.nombre)):console.warn(`‚ùå Servicio ${o} no tiene categoriaId o nombre:`,e):console.warn(`‚ùå Servicio ${o} es null/undefined, omitiendo`)}),console.log("üìã Servicios por categor√≠a:",a),0===Object.keys(a).length)return console.warn("‚ùå No se encontraron servicios v√°lidos agrupados por categor√≠a"),void(o.innerHTML='<p class="sin-especialistas">Selecciona servicios v√°lidos primero</p>');console.log("‚úÖ Creando UI para especialistas...");for(const e of Object.keys(a)){const r=a[e];if(!r||0===r.length){console.warn(`‚ùå Categor√≠a ${e} no tiene servicios, omitiendo`);continue}const t=datosReserva.categorias.find(o=>o.id===e);if(!t){console.warn(`‚ùå No se encontr√≥ categor√≠a con id ${e}`);continue}console.log(`‚úÖ Procesando categor√≠a: ${t.nombre}`);let n="";1===r.length?n=r[0]:2===r.length?n=r.join(" + "):r.length>2&&(n=r[0]+" + "+(r.length-1)+" servicios m√°s");const i=document.createElement("div");i.className="categoria-especialistas",i.dataset.categoriaId=e,i.innerHTML=`\n                <h3><span>${n}</span> con:</h3>\n                <div class="seleccion-predeterminada" data-categoria-id="${e}">\n                    <div class="info-especialista">\n                        <span class="texto-predeterminado">Selecciona un especialista</span>\n                    </div>\n                    <div class="botones-especialista">\n                        <button class="btn-ver-especialistas">\n                            <svg\n                            class="acordeon-icon" \n                            width="18"\n                            height="18"\n                            viewBox="0 0 24 24"\n                            fill="none"\n                            stroke="currentColor"\n                            stroke-width="2"\n                            stroke-linecap="round"\n                            stroke-linejoin="round"\n                            >\n                            <path d="M18 6l-12 12" />\n                            <path d="M6 6l12 12" />\n                            </svg>\n                        </button>\n                    </div>\n                </div>\n                <div class="especialistas-lista" data-categoria-id="${e}">\n                    \x3c!-- Los especialistas se agregar√°n aqu√≠ --\x3e\n                </div>\n            `,console.log(`üìû Obteniendo especialistas para categor√≠a: ${e}`);let s=await firestoreSeguro.obtenerEspecialistasPorCategoria(e);if(s?Array.isArray(s)||(console.warn(`‚ùå especialistas no es un array para categor√≠a ${e}:`,s),s=[]):(console.warn(`‚ùå especialistas es null para categor√≠a ${e}, forzando a array vac√≠o`),s=[]),console.log(`‚úÖ Especialistas obtenidos: ${s.length} para ${e}`),0===s.length)i.querySelector(".especialistas-lista").innerHTML='<p class="sin-especialistas">No hay especialistas disponibles</p>';else{const o=i.querySelector(".especialistas-lista"),a=(i.querySelector(".seleccion-predeterminada"),i.querySelector(".btn-ver-especialistas")),r=document.createElement("div");r.className="flotante especialista opcion-disponibilidad",r.dataset.id="auto",r.dataset.categoriaId=e,r.innerHTML='\n                    <div class="info-especialista">\n                        <p class="p1">Con quien tenga disponibilidad</p>\n                        <p class="detalles-especialista">Seleccionaremos el especialista con mejor disponibilidad</p>\n                    </div>\n                    <svg class="check-icon" viewBox="0 0 24 24">\n                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>\n                    </svg>\n                ',r.addEventListener("click",o=>{o.stopPropagation(),seleccionarEspecialista(r,{id:"auto",nombre:"Con quien tenga disponibilidad"},e)}),o.appendChild(r),s.forEach(a=>{const r=document.createElement("div");r.className="flotante especialista",r.dataset.id=a.id,r.dataset.categoriaId=e;const t=a.descripcion?`<div class="especialista-info-adicional">${a.descripcion}</div>`:"",n=a.calificacion?`<div class="especialista-calificacion">\n                            <span class="estrella">‚òÖ</span>\n                            <span>${a.calificacion}</span>\n                        </div>`:"";r.innerHTML=`\n                        <img src="${a.fotoUrl||"img/avatar-default.png"}" \n                             alt="${a.nombre}" class="avatar-especialista">\n                        <div class="info-especialista">\n                            <p class="p1">${a.nombre}</p>\n                            ${t}\n                            ${n}\n                        </div>\n                        <svg class="check-icon" viewBox="0 0 24 24">\n                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>\n                        </svg>\n                    `,r.addEventListener("click",o=>{o.stopPropagation(),seleccionarEspecialista(r,a,e)}),o.appendChild(r)}),a.addEventListener("click",e=>{e.stopPropagation();const o=i.querySelector(".especialistas-lista"),r=a.querySelector(".acordeon-icon"),t=o.classList.contains("abierto");document.querySelectorAll(".especialistas-lista.abierto").forEach(e=>{if(e!==o){e.classList.remove("abierto");const o=e.closest(".categoria-especialistas").querySelector(".acordeon-icon");o&&o.classList.remove("girado")}}),o.classList.toggle("abierto",!t),r.classList.toggle("girado",!t)})}o.appendChild(i)}console.log("‚úÖ mostrarEspecialistas completado exitosamente")}catch(e){console.error("‚ùå Error cr√≠tico en mostrarEspecialistas:",e),console.error("üìù Stack trace:",e.stack);const o=document.querySelector(".contenedor-especialistas");o&&(o.innerHTML='<p class="sin-especialistas">Error al cargar especialistas. Intenta nuevamente.</p>')}}function actualizarUIEspecialistas(e){const o=document.querySelector(".paso-2");if(!o)return;const a=o.querySelector(".contenedor-especialistas"),r=o.querySelector(".flotante.especialista"),t=o.querySelector(".sin-especialistas");a.innerHTML="",0!==e.length?e.forEach(e=>{const o=r.cloneNode(!0);o.style.display="flex",o.dataset.id=e.id,o.querySelector(".p1").textContent=e.nombre,o.querySelector(".p2").textContent=e.categorias.join(", "),o.addEventListener("click",()=>{seleccionarEspecialista(o,e)}),a.appendChild(o)}):t&&(t.style.display="block")}async function buscarEspecialistasAutomaticos(){try{const e=datosReserva.especialistas.filter(e=>"auto"===e.id);for(const o of e){const e=await obtenerEspecialistaConMejorDisponibilidad(o.categoriaId);if(!e)throw new Error(`No se encontr√≥ especialista disponible para la categor√≠a ${o.categoriaId}`);{const a=datosReserva.especialistas.findIndex(e=>"auto"===e.id&&e.categoriaId===o.categoriaId);-1!==a&&(datosReserva.especialistas[a]={id:e.id,nombre:e.nombre,categoriaId:o.categoriaId,fotoUrl:e.fotoUrl||"img/avatar-default.png"},console.log(`‚úÖ Especialista autom√°tico reemplazado: ${e.nombre}`,e.fotoUrl))}}return!0}catch(e){return console.error("Error buscando especialistas autom√°ticos:",e),mostrarError("No se pudo encontrar especialistas disponibles. Por favor, selecciona manualmente."),!1}}async function obtenerEspecialistaConMejorDisponibilidad(e){try{console.log("Buscando mejor especialista para categor√≠a:",e);const o=await firestoreDB.obtenerEspecialistasPorCategoria(e);if(!o||0===o.length)return console.log("No hay especialistas para esta categor√≠a"),null;if(1===o.length)return console.log("Solo hay un especialista, retornando:",o[0].nombre),o[0];const a=datosReserva.servicios.filter(o=>o.categoriaId===e).reduce((e,o)=>e+o.duracion,0);console.log("Duraci√≥n total necesaria:",a,"minutos");const r=new Date((new Date).toLocaleString("en-US",{timeZone:"America/Argentina/Buenos_Aires"})),t=[];for(const e of o){console.log("Evaluando especialista:",e.nombre);let o=0,n=0;for(let t=0;t<3;t++){const i=new Date(r);i.setDate(r.getDate()+t);const s=i.toISOString().split("T")[0];if(0!==i.getDay()&&6!==i.getDay())try{let i=(await firestoreDB.generarHorariosDisponiblesEspecialista(e.id,s)).filter(e=>e.disponible);if(0===t){const e=r.getHours(),o=60*e+r.getMinutes();i=i.filter(e=>{const[a,r]=e.hora.split(":");return 60*parseInt(a)+parseInt(r)>=o+30})}const c=encontrarBloquesDisponibles(i,a);o+=c.length,n++,console.log(`Especialista ${e.nombre} - ${s}: ${c.length} bloques disponibles`)}catch(o){console.warn(`Error obteniendo horarios para ${e.nombre} en ${s}:`,o)}}const i=n>0?o/n:0;console.log(`Especialista ${e.nombre} - Puntuaci√≥n: ${i}`),t.push({especialista:e,puntuacion:i})}t.sort((e,o)=>o.puntuacion-e.puntuacion),console.log("Ranking de especialistas:",t.map(e=>`${e.especialista.nombre}: ${e.puntuacion}`));const n=t[0].puntuacion>0?t[0].especialista:o[0];return console.log("Mejor especialista encontrado:",n.nombre,"Foto:",n.fotoUrl),mejorEspecialistaPorCategoria[e]=n,n}catch(o){console.error("Error calculando disponibilidad:",o);try{const o=await firestoreDB.obtenerEspecialistasPorCategoria(e);return o.length>0?o[0]:null}catch(e){return console.error("Error de fallback:",e),null}}}function encontrarBloquesDisponibles(e,o){const a=[],r=Math.ceil(o/30);if(e.length<r)return a;for(let t=0;t<=e.length-r;t++){let n=!0;for(let o=0;o<r;o++)if(!e[t+o]||!e[t+o].disponible){n=!1;break}n&&a.push({inicio:e[t].hora,fin:calcularHoraFin(e[t].hora,o)})}return a}function calcularHoraFin(e,o){const[a,r]=e.split(":");let t=parseInt(a),n=parseInt(r);return n+=o,t+=Math.floor(n/60),n%=60,`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}function agregarEventosBotones(e,o){const a=e.querySelector(".seleccion-predeterminada"),r=e.querySelector(".btn-ver-especialistas"),t=e.querySelector(".btn-buscar-disponibilidad"),n=e.querySelector(".especialistas-lista"),i=r.querySelector(".acordeon-icon"),s=()=>{const e=n.classList.contains("abierto");document.querySelectorAll(".especialistas-lista.abierto").forEach(e=>{if(e!==n){e.classList.remove("abierto");const o=e.closest(".categoria-especialistas").querySelector(".acordeon-icon");o&&o.classList.remove("girado")}}),n.classList.toggle("abierto",!e),i&&i.classList.toggle("girado",!e)};r.addEventListener("click",e=>{e.stopPropagation(),s()}),a.addEventListener("click",e=>{e.target.closest(".botones-especialista")||s()}),t.addEventListener("click",async r=>{r.stopPropagation();const t=a.querySelector(".info-especialista"),n=a.querySelector(".botones-especialista"),i=e.querySelector(".especialistas-lista"),s=n.innerHTML;t.innerHTML='\n            <span class="texto-predeterminado">Buscando mejor disponibilidad...</span>\n        ';try{const r=await obtenerEspecialistaConMejorDisponibilidad(o);if(r){i.querySelectorAll(".flotante.especialista").forEach(e=>{e.classList.remove("seleccionado")});const e=i.querySelector(`[data-id="${r.id}"]`);e&&e.classList.add("seleccionado"),a.classList.add("seleccionado"),t.innerHTML=`\n                    <span class="badge-recomendado">Recomendado</span>\n                    <img src="${r.fotoUrl||"img/avatar-default.png"}" \n                        alt="${r.nombre}" class="avatar-especialista">\n                    <div>\n                        <span class="nombre-especialista">${r.nombre}</span>\n                        <div class="info-disponibilidad">\n                            <span class="icono-disponibilidad">‚úì</span>\n                            Mejor disponibilidad esta semana\n                        </div>\n                    </div>\n                `,seleccionarEspecialista(null,r,o)}else t.innerHTML='\n                    <span class="texto-predeterminado">No disponible</span>\n                ',n.innerHTML=s,agregarEventosBotones(e,o)}catch(a){console.error("Error al obtener especialista:",a),t.innerHTML='\n                <span class="texto-predeterminado">Error, intenta nuevamente</span>\n            ',n.innerHTML=s,agregarEventosBotones(e,o)}})}function esDuracionValida(e,o,a){const[r,t]=e.split(":").map(Number);return 60*r+t+o<=60*parseInt(a.split(":")[0])+parseInt(a.split(":")[1])}function mostrarErrorDisponibilidad(e){mostrarError(`Los siguientes especialistas no est√°n disponibles: ${e.map(e=>e.nombre).join(", ")}`)}async function cargarFechasYHorarios(){console.log("=== CARGANDO FECHAS ==="),console.log("Especialistas actuales:",datosReserva.especialistas.map(e=>e.nombre));try{const e=await firestoreSeguro.obtenerConfiguracion(),o=document.querySelector(".contenedor-calendario"),a=document.querySelector(".cargando-fechas"),r=document.querySelector(".sin-fechas");o&&(o.style.display="none"),a&&(a.style.display="block"),r&&(r.style.display="none");const t=await generarFechasDisponiblesConEspecialistas(e);console.log("üìÖ Fechas disponibles despu√©s del filtrado:",t.map(e=>e.fecha)),actualizarUIFechas(t)}catch(e){console.error("Error cargando fechas:",e),mostrarError("No se pudieron cargar las fechas disponibles");const o=document.querySelector(".cargando-fechas");o&&(o.style.display="none")}}async function generarFechasDisponiblesConEspecialistas(e){const o=new Date((new Date).toLocaleString("en-US",{timeZone:"America/Argentina/Buenos_Aires"})),a=new Date(o.getFullYear(),o.getMonth(),o.getDate()),r=[];for(let o=0;o<14;o++){const t=new Date(a);t.setDate(a.getDate()+o);const n=t.toISOString().split("T")[0];if(Array.isArray(e.diasNoLaborables)&&e.diasNoLaborables.includes(n)){console.log(`Saltando ${n} - D√≠a no laborable configurado`);continue}await verificarDisponibilidadEspecialistas(n)&&r.push({fecha:n,display:formatearFechaDisplay(t)})}return console.log("Fechas disponibles despu√©s de verificar especialistas:",r),r}function seleccionarFechaAutomaticamente(e){fechaSeleccionada=e,datosReserva.fecha=e;document.querySelectorAll(".dia-calendario").forEach(o=>{if(o.dataset.fecha)if(o.dataset.fecha===e){o.classList.add("seleccionado");const a=document.getElementById("error-fecha");a&&a.classList.remove("visible"),cargarHorariosParaFecha(e)}else o.classList.remove("seleccionado")}),actualizarSubtituloHorarios(e),console.log("Fecha seleccionada autom√°ticamente:",e)}async function obtenerHorariosComunes(e){if(!datosReserva.especialistas||0===datosReserva.especialistas.length)return[];const o={},a=calcularDuracionTotal();for(const r of datosReserva.especialistas)try{const t=(await firestoreSeguro.generarHorariosDisponiblesEspecialista(r.id,e,a)).filter(e=>e.disponible).map(e=>e.hora);o[r.id]=t}catch(e){console.error(`Error obteniendo horarios para ${r.nombre}:`,e),o[r.id]=[]}return encontrarHorariosComunes(o)}async function puedeAcomodarDuracion(e,o,a,r){try{const t=await db.collection("especialistas").doc(a).get();if(!t.exists)return!1;const n=t.data(),i=new Date(r).getDay(),s=["domingo","lunes","martes","miercoles","jueves","viernes","sabado"][i];let c=n.horarioLaboral?.[s]?.fin||datosReserva.configuracion.horarioCierre;const[l,d]=c.replace(".",":").split(":"),u=parseInt(l),p=60*u+parseInt(d||0),[m,g]=e.split(":"),h=parseInt(m),v=parseInt(g);return 60*h+v+o<=p}catch(e){return console.error("Error validando horario:",e),!1}}function encontrarHorariosComunes(e){const o=Object.keys(e);if(0===o.length)return[];let a=[...e[o[0]]];for(let r=1;r<o.length;r++){const t=e[o[r]];a=a.filter(e=>t.includes(e))}return a}function seleccionarHorario(e,o){document.querySelectorAll(".flotante.horario").forEach(e=>{e.classList.remove("seleccionado")}),e.classList.add("seleccionado"),datosReserva.horario=o;const a=document.getElementById("error-horario");a&&a.classList.remove("visible"),console.log("Horario seleccionado:",datosReserva.horario)}function seleccionarFecha(e,o){document.querySelectorAll(".flotante.fecha").forEach(e=>{e.classList.remove("seleccionado")}),e.classList.add("seleccionado"),fechaSeleccionada=o,datosReserva.fecha=o,cargarHorariosParaFecha(o);const a=document.getElementById("error-fecha");a&&a.classList.remove("visible")}async function verificarDisponibilidadEspecialistas(e){console.log(`üîç Verificando fecha ${e} para especialistas:`,datosReserva.especialistas.map(e=>e.nombre));try{if(!datosReserva.especialistas||0===datosReserva.especialistas.length)return console.log("No hay especialistas seleccionados"),!1;for(const o of datosReserva.especialistas){const a=await verificarDisponibilidadEspecialista(o.id,e);if(console.log(`üëâ Especialista ${o.nombre} en ${e}: ${a?"DISPONIBLE":"NO DISPONIBLE"}`),!a)return!1}return console.log(`üéØ Todos los especialistas disponibles el ${e}`),!0}catch(e){return console.error("Error verificando disponibilidad:",e),!1}}function formatearFechaParaDebug(e){return new Date(e+"T03:00:00").toLocaleDateString("es-AR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}async function verificarDisponibilidadEspecialista(e,o){try{const a=await db.collection("especialistas").doc(e).get();if(!a.exists)return!1;const r=a.data(),t=new Date(o+"T03:00:00").getUTCDay(),n={0:"domingo",1:"lunes",2:"martes",3:"miercoles",4:"jueves",5:"viernes",6:"sabado"}[t];if(console.log(`Verificando ${n} (${t}) para ${r.nombre}`),!r.horarioLaboral||!r.horarioLaboral[n]?.activo)return console.log(`-> ${r.nombre} NO trabaja los ${n}`),!1;return await verificarBloqueosEspecialista(e,o)?(console.log(`-> ${r.nombre} tiene bloqueos para ${o}`),!1):(console.log(`-> ${r.nombre} S√ç trabaja los ${n}`),!0)}catch(e){return console.error("Error verificando disponibilidad del especialista:",e),!1}}async function verificarBloqueosEspecialista(e,o){try{const a=new Date(o).getTime(),r=await db.collection("bloqueos").where("especialistaId","==",e).get();if(r.empty)return!1;for(const e of r.docs){const o=e.data(),r=new Date(o.fechaInicio).getTime(),t=new Date(o.fechaFin).getTime();if(a>=r&&a<=t)return!0}return!1}catch(e){return console.error("Error verificando bloqueos:",e),!1}}function formatearFechaDisplay(e){let o;if("string"==typeof e)o=new Date(e+"T03:00:00");else{if(!(e instanceof Date))return"Fecha inv√°lida";o=e}return o.toLocaleDateString("es-AR",{weekday:"long",day:"numeric",month:"short"})}async function cargarConfiguracion(){try{return datosReserva.configuracion=await firestoreSeguro.obtenerConfiguracion(),datosReserva.configuracion}catch(e){return console.error("Error cargando configuraci√≥n:",e),datosReserva.configuracion={horarioApertura:"09:00",horarioCierre:"20:00",diasLaborales:[1,2,3,4,5,6],duracionTurnoBase:30},datosReserva.configuracion}}function limpiarFechasYHorarios(){datosReserva.fecha=null,datosReserva.horario=null,fechaSeleccionada=null;const e=document.querySelector(".contenedor-fechas"),o=document.querySelector(".contenedor-horarios");e&&(e.innerHTML=""),o&&(o.innerHTML=""),document.querySelectorAll(".flotante.fecha.seleccionado").forEach(e=>{e.classList.remove("seleccionado")}),document.querySelectorAll(".flotante.horario.seleccionado").forEach(e=>{e.classList.remove("seleccionado")}),document.querySelectorAll(".sin-fechas, .sin-horarios, .cargando-fechas, .cargando-horarios").forEach(e=>e.style.display="none")}function calcularHorarioFin(e,o){const[a,r]=e.split(":");let t=parseInt(a),n=parseInt(r);return n+=o,t+=Math.floor(n/60),n%=60,`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}function formatearDuracion(e){const o=Math.floor(e/60),a=e%60;return o>0&&a>0?`${o}h ${a}min`:o>0?`${o} hora${o>1?"s":""}`:`${a} minutos`}document.addEventListener("DOMContentLoaded",()=>{inicializarCalendario()}),window.demoPaso6=demoPaso6;const debounce=(e,o)=>{let a;return function(...r){clearTimeout(a),a=setTimeout(()=>{clearTimeout(a),e(...r)},o)}},debouncedCargarHorarios=debounce(async e=>{try{actualizarUIHorarios(await obtenerHorariosComunes(e))}catch(e){console.error("Error cargando horarios:",e)}},300);function inicializarCalendario(){const e=document.querySelector(".btn-calendario-prev"),o=document.querySelector(".btn-calendario-next");calendarioFechaActual=new Date,e&&o&&(e.addEventListener("click",()=>{calendarioFechaActual.setMonth(calendarioFechaActual.getMonth()-1),console.log("Navegando a mes anterior:",calendarioFechaActual.getMonth()+1),renderizarCalendario(),debugVisualizacionFechas()}),o.addEventListener("click",()=>{calendarioFechaActual.setMonth(calendarioFechaActual.getMonth()+1),console.log("Navegando a mes siguiente:",calendarioFechaActual.getMonth()+1),renderizarCalendario(),debugVisualizacionFechas()})),console.log("Calendario inicializado")}function renderizarCalendario(){const e=document.querySelector(".calendario-mes"),o=document.querySelector(".calendario-dias");if(!e||!o)return void console.error("Elementos del calendario no encontrados");const a=calendarioFechaActual.getMonth(),r=calendarioFechaActual.getFullYear();e.innerHTML=`${["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][a]} <span>${r}</span>`;const t=new Date(r,a,1),n=new Date(r,a+1,0).getDate(),i=t.getDay();o.innerHTML="";for(let e=0;e<i;e++){const e=document.createElement("div");e.className="dia-calendario fuera-de-mes",o.appendChild(e)}(new Date).toISOString().split("T")[0];console.log("Fechas disponibles para calendario:",fechasDisponiblesCalendario);for(let e=1;e<=n;e++){const t=document.createElement("div");t.className="dia-calendario",t.textContent=e;const n=`${r}-${String(a+1).padStart(2,"0")}-${String(e).padStart(2,"0")}`,i=new Date(n+"T03:00:00").toISOString().split("T")[0];t.dataset.fecha=i;const s=(new Date).toISOString().split("T")[0];i===s&&t.classList.add("hoy");fechasDisponiblesCalendario.some(e=>e.fecha===i)?(t.classList.add("disponible"),t.addEventListener("click",()=>seleccionarFechaCalendario(i,t))):t.classList.add("no-disponible"),o.appendChild(t)}}function seleccionarFechaCalendario(e,o){document.querySelectorAll(".dia-calendario.seleccionado").forEach(e=>{e.classList.remove("seleccionado")}),o.classList.add("seleccionado"),fechaSeleccionada=e,datosReserva.fecha=e,console.log("Fecha seleccionada:",datosReserva.fecha),cargarHorariosParaFecha(e);const a=document.getElementById("error-fecha");a&&a.classList.remove("visible"),actualizarSubtituloHorarios(e)}function debugVisualizacionFechas(){console.log("=== DEBUG VISUALIZACI√ìN ==="),console.log("Fecha actual del calendario:",calendarioFechaActual),console.log("Fechas disponibles:",fechasDisponiblesCalendario),console.log("Datos reserva fecha:",datosReserva.fecha);const e=calendarioFechaActual.getMonth(),o=calendarioFechaActual.getFullYear(),a=(new Date(o,e,1),new Date(o,e+1,0).getDate());for(let r=1;r<=a;r++){const a=`${o}-${String(e+1).padStart(2,"0")}-${String(r).padStart(2,"0")}`,t=new Date(a+"T03:00:00").toISOString().split("T")[0];fechasDisponiblesCalendario.some(e=>e.fecha===t)&&console.log(`D√≠a ${r} (${t}) deber√≠a estar DISPONIBLE`)}}function actualizarSubtituloHorarios(e){const o=document.querySelector(".seccion-horarios .subtitulo");if(!o)return;const a=new Date(e+"T03:00:00").toLocaleDateString("es-AR",{weekday:"long",day:"numeric"}).split(" "),r=a[0],t=a[1];o.innerHTML=`${r} <span>${t}</span>`}function actualizarResumenContinuo(e){const o=document.querySelector(".resumen-continuo"),a=document.querySelector(".resumen-especialistas"),r=document.querySelector(".resumen-fecha-hora"),t=document.querySelector(".resumen-cliente");e>=2?(o.style.display="block",actualizarResumenServicios(),e>=3?(a&&(a.style.display="block"),actualizarResumenEspecialistas(),e>=4?(r.style.display="block",actualizarResumenFechaHora(),e>=5?(t.style.display="block",actualizarResumenCliente()):t.style.display="none"):(r.style.display="none",t.style.display="none")):(a.style.display="none",r.style.display="none",t.style.display="none")):o.style.display="none"}function actualizarResumenServicios(){const e=document.querySelector(".servicios-lista"),o=document.getElementById("resumen-duracion"),a=document.getElementById("resumen-precio"),r=document.getElementById("resumen-senia");if(datosReserva.servicios&&datosReserva.servicios.length>0){e.innerHTML=datosReserva.servicios.map(e=>`<div class="servicio-item">\n        <svg\n        xmlns="http://www.w3.org/2000/svg"\n        width="18"\n        height="18"\n        viewBox="0 0 24 24"\n        fill="#000000"\n        stroke="#000000"\n        stroke-width="1"\n        stroke-linecap="round"\n        stroke-linejoin="round"\n        >\n        <path d="M17.286 21.09q -1.69 .001 -5.288 -2.615q -3.596 2.617 -5.288 2.616q -2.726 0 -.495 -6.8q -9.389 -6.775 2.135 -6.775h.076q 1.785 -5.516 3.574 -5.516q 1.785 0 3.574 5.516h.076q 11.525 0 2.133 6.774q 2.23 6.802 -.497 6.8" />\n        </svg>\n      ${e.nombre}\n      </div>`).join("");const t=calcularDuracionTotal(),n=datosReserva.servicios.reduce((e,o)=>e+o.precio,0),i=calcularSenia();o.textContent=`${t} min`,a.textContent=`${n.toLocaleString()}`,r.textContent=`${i.toLocaleString()}`}else e.innerHTML='<p class="sin-datos">No hay servicios seleccionados</p>',o.textContent="0 min",a.textContent="$0",r.textContent="$0"}function actualizarResumenEspecialistas(){const e=document.querySelector(".resumen-especialistas .especialistas-resumen");e?(console.log("Actualizando resumen de especialistas:",datosReserva.especialistas),datosReserva.especialistas&&datosReserva.especialistas.length>0?e.innerHTML=datosReserva.especialistas.map(e=>{let o="img/avatar-default.png";if(e.fotoUrl)o=e.fotoUrl;else if("auto"!==e.id){const a=document.querySelector(`.flotante.especialista[data-id="${e.id}"]`);if(a){const e=a.querySelector(".avatar-especialista");e&&(o=e.src)}}const a=e.nombre||"Especialista";return console.log(`üñºÔ∏è Mostrando especialista ${a} con avatar: ${o}`),`<div class="especialista-item">\n        <img src="${o}" alt="${a}" class="avatar-especialista" \n             onerror="this.src='img/avatar-default.png'">\n        <span>${a}</span>\n      </div>`}).join(""):(e.innerHTML='<p class="sin-datos">No hay especialistas seleccionados</p>',console.warn("No hay especialistas en datosReserva.especialistas"))):console.error("Elemento .especialistas-resumen no encontrado")}function actualizarResumenFechaHora(){const e=document.getElementById("resumen-fecha"),o=document.getElementById("resumen-hora"),a='\n    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">\n      <path d="M11.5 21h-5.5a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v6" />\n      <path d="M16 3v4" />\n      <path d="M8 3v4" />\n      <path d="M4 11h16" />\n      <path d="M15 19l2 2l4 -4" />\n    </svg>\n  ',r='\n    <svg\n    xmlns="http://www.w3.org/2000/svg"\n    width="18"\n    height="18"\n    viewBox="0 0 24 24"\n    fill="none"\n    stroke="#000000"\n    stroke-width="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n    >\n    <path d="M20.942 13.021a9 9 0 1 0 -9.407 7.967" />\n    <path d="M12 7v5l3 3" />\n    <path d="M15 19l2 2l4 -4" />\n    </svg>\n  ';if(datosReserva.fecha?e.innerHTML=`${a} ${formatearFechaDisplay(datosReserva.fecha)}`:e.innerHTML=`${a} Fecha no seleccionada`,datosReserva.horario){const e=calcularDuracionTotal(),a=calcularHorarioFin(datosReserva.horario,e);o.innerHTML=`${r} ${datosReserva.horario} a ${a}`}else o.innerHTML=`${r} Horario no seleccionado`}function actualizarResumenCliente(){}async function cargarDatosGenerales(){try{if(0===Object.keys(datosGenerales).length&&(datosGenerales=await firestoreSeguro.obtenerConfigGeneral()),!datosGenerales||0===Object.keys(datosGenerales).length)return document.getElementById("local-direccion").textContent="Direcci√≥n no disponible",document.getElementById("local-telefono").textContent="Tel√©fono no disponible",document.getElementById("local-email").textContent="Email no disponible",void(document.getElementById("local-atencion").textContent="Horarios no disponibles");const e=datosGenerales.empresa||{},o=document.getElementById("local-direccion");o&&e.direccion?o.textContent=e.direccion:o&&(o.textContent="Direcci√≥n no disponible");const a=document.getElementById("local-telefono");a&&e.telefono?a.textContent=e.telefono:a&&(a.textContent="Tel√©fono no disponible");const r=document.getElementById("local-email");r&&e.email?r.textContent=e.email:r&&(r.textContent="Email no disponible");const t=document.getElementById("local-atencion");if(t&&e.horariosAtencion?t.textContent=e.horariosAtencion:t&&(t.textContent="Horarios no disponibles"),e.redesSociales){const o=document.getElementById("instagram"),a=document.getElementById("equis"),r=document.getElementById("whatsapp");o&&e.redesSociales.instagram&&(o.href=e.redesSociales.instagram),a&&e.redesSociales.twitter&&(a.href=e.redesSociales.twitter),r&&e.redesSociales.whatsapp&&(r.href=e.redesSociales.whatsapp)}setTimeout(()=>{inicializarMapasEnDirecciones()},100)}catch(e){console.error("Error cargando datos del local:",e),document.getElementById("local-direccion").textContent="Direcci√≥n no disponible",document.getElementById("local-telefono").textContent="Tel√©fono no disponible",document.getElementById("local-email").textContent="Email no disponible";const o=document.getElementById("local-atencion");o&&(o.textContent="Horarios no disponibles")}}function escucharCambiosConfigGeneral(){db.collection("config").doc("general").onSnapshot(e=>{e.exists&&(datosGenerales=e.data(),cargarDatosGenerales())},e=>{console.error("Error escuchando cambios:",e)})}function inicializarMapas(){console.log("API de Google Maps cargada")}function geocodificarDireccion(e,o){if("undefined"==typeof google||!google.maps||!google.maps.Geocoder)return console.error("API de Google Maps no est√° disponible"),void o("API de Google Maps no est√° disponible",null);(new google.maps.Geocoder).geocode({address:e},(e,a)=>{if("OK"===a){const a=e[0].geometry.location;o(null,{lat:a.lat(),lng:a.lng()})}else o("Error en geocodificaci√≥n: "+a,null)})}function inicializarMapasEnDirecciones(){const e=document.getElementById("local-direccion");if(!e)return;const o=e.textContent;if(!o||"Direcci√≥n no disponible"===o)return;const a=(datosGenerales.empresa||{}).coordenadas;let r=e.querySelector(".mapa-popup");if(r||(r=document.createElement("div"),r.className="mapa-popup",e.appendChild(r)),a&&a.lat&&a.lng){coordenadasLocal=a;const e="AIzaSyCAO4m-WpFO7Hc9rf8Iy1-gyDMlSLDFong",o=`https://maps.googleapis.com/maps/api/staticmap?center=${a.lat},${a.lng}&zoom=16&size=300x200&markers=color:red%7C${a.lat},${a.lng}&key=${e}`,t=document.createElement("img");t.src=o,t.alt="Mapa del local",t.style.width="100%",t.style.height="100%",t.onload=function(){console.log("Mapa cargado correctamente")},t.onerror=function(){console.error("Error al cargar la imagen del mapa"),r.innerHTML='<div style="padding: 20px; text-align: center;">Error al cargar el mapa</div>'},r.innerHTML="",r.appendChild(t)}else r.innerHTML='<div style="padding: 20px; text-align: center;">Cargando mapa...</div>',geocodificarDireccion(o,(e,o)=>{if(e)return console.error("Error en geocodificaci√≥n:",e),void(r.innerHTML='<div style="padding: 20px; text-align: center;">Error al cargar el mapa</div>');coordenadasLocal=o;const a=`https://maps.googleapis.com/maps/api/staticmap?center=${o.lat},${o.lng}&zoom=16&size=300x200&markers=color:red%7C${o.lat},${o.lng}&key=TU_API_KEY_REAL`,t=document.createElement("img");t.src=a,t.alt="Mapa del local",t.style.width="100%",t.style.height="100%",r.innerHTML="",r.appendChild(t)});e.addEventListener("click",e=>{if(e.preventDefault(),coordenadasLocal){const e=`https://www.google.com/maps/search/?api=1&query=${coordenadasLocal.lat},${coordenadasLocal.lng}`;window.open(e,"_blank")}else{const e=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(o)}`;window.open(e,"_blank")}})}function actualizarAnioFooter(){const e=document.getElementById("current-year");if(e){const o=(new Date).getFullYear();e.textContent=o}}debugVisualizacionFechas(),document.addEventListener("DOMContentLoaded",function(){actualizarAnioFooter()});
//# sourceMappingURL=bundle.min.js.map
